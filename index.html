<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ÏÑ∏Ìò∏Î°úÎ¶¨ ÎΩëÍ∏∞</title>
  <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', 'Malgun Gothic', 'Apple SD Gothic Neo', sans-serif;
            background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        #appLayoutRoot {
            position: relative;
            width: var(--app-layout-width, 100vw);
            height: var(--app-layout-height, 100vh);
            margin: 0 auto;
            overflow: hidden;
        }

        :root {
            --app-layout-width: 100vw;
            --app-layout-height: 100vh;
        }

        body.is-mobile {
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }

        body.is-mobile #appLayoutRoot {
            width: var(--app-layout-width);
            height: var(--app-layout-height);
            aspect-ratio: 9 / 16;
            max-width: 100%;
            max-height: 100%;
        }

        body.is-mobile #coinBuffContainer {
            position: fixed;
            top: 12px;
            right: 12px;
            transform: scale(0.8);
            transform-origin: top right;
        }

        body.is-mobile #settingsPanel {
            position: fixed;
            top: 12px;
            left: 12px;
            transform: scale(0.8);
            transform-origin: top left;
        }

        body.is-mobile .navigation-dots {
            position: fixed;
            bottom: 12px;
            transform: scale(0.85);
        }

        body.is-mobile #questOverlay {
            position: fixed;
            inset: 0;
            padding: 12px;
        }

        body.is-mobile .screen {
            padding: 10px;
        }

        body.is-mobile .container,
        body.is-mobile .shop-container {
            max-height: calc(100% - 28px);
            width: 86%;
            padding: 28px 24px;
            overflow-y: auto;
        }

        body.is-mobile .container h1,
        body.is-mobile .shop-container h2 {
            font-size: 1.4em;
        }

        #hudDrawerPanel {
            display: none;
        }

        body.is-mobile #hudDrawerPanel {
            display: block;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 220px;
            background: linear-gradient(135deg, rgba(30, 64, 175, 0.92), rgba(59, 130, 246, 0.88));
            z-index: 2050;
            border-radius: 0 0 28px 28px;
            opacity: 0;
            transform: translateY(-100%);
            transition: transform 0.3s ease, opacity 0.3s ease;
            pointer-events: none;
            box-shadow: 0 24px 40px rgba(15, 23, 42, 0.25);
        }

        body.is-mobile.hud-drawer-open #hudDrawerPanel {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        body.is-mobile .hud-drawer-item {
            transition: transform 0.3s ease, opacity 0.3s ease;
        }

        body.is-mobile:not(.hud-drawer-open) .hud-drawer-item {
            transform: translateY(-160px);
            opacity: 0;
            pointer-events: none;
        }

        body.is-mobile.hud-drawer-open .hud-drawer-item {
            transform: translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .device-mode-settings {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .settings-device-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
        }

        .device-mode-label {
            font-weight: 700;
            color: #334155;
            font-size: 0.95em;
        }

        .device-toggle {
            position: relative;
            width: 92px;
            height: 34px;
        }

        .device-toggle input {
            position: absolute;
            inset: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
            z-index: 3;
            margin: 0;
        }

        .device-toggle-track {
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, #e2e8f0 0%, #cfd8e3 100%);
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 12px;
            font-size: 0.78em;
            font-weight: 700;
            color: #475569;
            transition: background 0.25s ease, color 0.25s ease;
            pointer-events: none;
        }

        .device-toggle-thumb {
            position: absolute;
            top: 4px;
            left: 4px;
            width: 42px;
            height: 26px;
            border-radius: 999px;
            background: #ffffff;
            box-shadow: 0 6px 16px rgba(15, 23, 42, 0.18);
            transition: transform 0.25s ease;
            z-index: 1;
            pointer-events: none;
        }

        .device-toggle-option {
            z-index: 2;
            pointer-events: none;
            transition: color 0.25s ease;
        }

        .device-toggle-option.option-desktop {
            color: #1e293b;
        }

        .device-toggle-option.option-mobile {
            color: #94a3b8;
        }

        .device-toggle input:checked + .device-toggle-track {
            background: linear-gradient(135deg, #60a5fa 0%, #2563eb 100%);
            color: rgba(255, 255, 255, 0.85);
        }

        .device-toggle input:checked + .device-toggle-track .option-desktop {
            color: rgba(255, 255, 255, 0.68);
        }

        .device-toggle input:checked + .device-toggle-track .option-mobile {
            color: #ffffff;
        }

        .device-toggle input:checked ~ .device-toggle-thumb {
            transform: translateX(42px);
        }

        .device-mode-hint {
            font-size: 0.82em;
            color: #64748b;
        }

        .device-mode-caption {
            font-size: 0.78em;
            color: #5b6b85;
        }

        .device-mode-reset {
            align-self: flex-end;
            border: none;
            background: rgba(96, 165, 250, 0.16);
            color: #1d4ed8;
            font-weight: 600;
            padding: 8px 14px;
            border-radius: 999px;
            cursor: pointer;
            transition: background 0.2s ease, color 0.2s ease;
        }

        .device-mode-reset:hover:not(:disabled) {
            background: rgba(59, 130, 246, 0.25);
            color: #1e3a8a;
        }

        .device-mode-reset:disabled {
            cursor: default;
            opacity: 0.5;
        }

        .main-container {
            display: flex;
            width: 100%;
            height: 100%;
            transition: transform 0.3s ease;
        }

        .screen {
            min-width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: linear-gradient(160deg, rgba(255, 255, 255, 0.92) 0%, rgba(236, 243, 255, 0.92) 100%);
            border-radius: 24px;
            padding: 48px 54px;
            box-shadow: 0 32px 60px rgba(15, 23, 42, 0.14);
            text-align: center;
            max-width: 600px;
            width: 95%;
            border: 1px solid rgba(148, 163, 184, 0.18);
            backdrop-filter: blur(8px);
        }

        .navigation-dots {
      position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        /* ÏÑ∏Ìò∏ÏΩîÏù∏ & Î≤ÑÌîÑ UI (Ïö∞Ï∏° ÏÉÅÎã®) */
        #questButton {
            position: relative;
            align-self: flex-end;
            width: 52px;
            height: 52px;
            background: linear-gradient(135deg, #facc15 0%, #f97316 100%);
            border: none;
            border-radius: 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5em;
            box-shadow: 0 16px 28px rgba(249, 115, 22, 0.28);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            z-index: 999;
        }
        #questButton:hover {
            transform: translateY(-3px);
            box-shadow: 0 20px 40px rgba(249, 115, 22, 0.32);
        }
        #questButton:active {
            transform: translateY(0);
        }

        /* ÌÄòÏä§Ìä∏ Ïò§Î≤ÑÎ†àÏù¥ */
        .quest-overlay {
            position: fixed;
            inset: 0;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.45);
            z-index: 2300;
            padding: 20px;
        }

        .quest-overlay.show {
            display: flex;
        }

        .quest-container {
            background: #ffffff;
            border-radius: 18px;
            width: min(520px, 96vw);
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 16px 40px rgba(0, 0, 0, 0.2);
            overflow: hidden;
            animation: fadeInUp 0.2s ease-out;
        }

        .quest-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 18px 20px 12px;
            border-bottom: 1px solid #e9ecef;
            background: linear-gradient(135deg, #ffe082 0%, #ffca28 100%);
        }

        .quest-tabs {
            display: flex;
            gap: 8px;
        }

        .quest-tab-button {
            background: rgba(255, 255, 255, 0.7);
            border: none;
            border-radius: 10px;
            padding: 8px 14px;
            font-weight: 700;
            color: #6c4f12;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quest-tab-button.active {
            background: #ffffff;
            color: #d35400;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
        }

        .quest-close {
            background: rgba(255, 255, 255, 0.8);
            border: none;
            width: 34px;
            height: 34px;
            border-radius: 10px;
            font-size: 1.1em;
            cursor: pointer;
            color: #6c4f12;
            transition: transform 0.2s ease;
        }

        .quest-close:hover {
            transform: rotate(90deg);
        }

        .quest-meta {
            padding: 14px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid #f1f3f5;
            background: #fff9e6;
            font-size: 0.95em;
            color: #8c6d1f;
            gap: 10px;
        }

        .quest-meta strong {
            font-weight: 800;
            color: #d35400;
        }

        .quest-content {
            padding: 16px 20px 24px;
            overflow-y: auto;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 18px;
            background: #fffdf6;
        }

        .quest-tab-content {
            display: none;
            flex-direction: column;
            gap: 14px;
        }

        .quest-tab-content.active {
            display: flex;
        }

        .quest-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .quest-item {
            background: #ffffff;
            border: 1px solid #f0e4c3;
            border-radius: 14px;
            padding: 14px 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .quest-item.completed {
            border-color: rgba(34, 197, 94, 0.25);
            box-shadow: 0 6px 16px rgba(34, 197, 94, 0.12);
        }

        .quest-item.ready {
            background: linear-gradient(145deg, #fff8d6 0%, #ffe8a3 100%);
            border-color: rgba(250, 204, 21, 0.7);
            box-shadow: 0 14px 26px rgba(250, 204, 21, 0.22);
        }

        .quest-item.claimed {
            background: linear-gradient(145deg, #f0fff4 0%, #dcfce7 100%);
            border-color: rgba(34, 197, 94, 0.5);
            box-shadow: 0 12px 22px rgba(34, 197, 94, 0.2);
        }

        .quest-item-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .quest-item-title {
            font-weight: 800;
            color: #5d4037;
            font-size: 1.05em;
        }

        .quest-item-reward {
            font-size: 0.85em;
            color: #d35400;
            font-weight: 700;
        }

        .quest-item-desc {
            font-size: 0.9em;
            color: #6d4c41;
            line-height: 1.4;
        }

        .quest-progress {
            background: #f1ede4;
            border-radius: 12px;
            height: 10px;
            overflow: hidden;
            position: relative;
        }

        .quest-progress-bar {
            height: 100%;
            background: linear-gradient(135deg, #ffa726 0%, #fb8c00 100%);
            border-radius: 12px;
            transition: width 0.3s ease;
        }

        .quest-item.ready .quest-progress-bar {
            background: linear-gradient(135deg, #facc15 0%, #f59e0b 100%);
        }

        .quest-item.claimed .quest-progress-bar {
            background: linear-gradient(135deg, #34d399 0%, #059669 100%);
        }

        .quest-progress-info {
            font-size: 0.8em;
            color: #8d6e63;
            font-weight: 600;
        }

        .quest-item.ready .quest-progress-info {
            color: #b45309;
        }

        .quest-item.claimed .quest-progress-info {
            color: #0f9d58;
        }

        .quest-claim-button {
            display: none;
            margin: 10px auto 0;
            padding: 10px 22px;
            border-radius: 999px;
            border: none;
            background: linear-gradient(135deg, #facc15 0%, #f97316 100%);
            color: #451a03;
            font-weight: 800;
            font-size: 0.95em;
            cursor: pointer;
            box-shadow: 0 12px 22px rgba(249, 115, 22, 0.28);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .quest-claim-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 30px rgba(249, 115, 22, 0.32);
        }

        .quest-item.ready .quest-claim-button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .quest-empty-state {
            text-align: center;
            color: #8d6e63;
            padding: 40px 0;
            border: 2px dashed #f0e4c3;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.7);
            font-weight: 600;
        }

        @keyframes fadeInUp {
            0% {
                opacity: 0;
                transform: translateY(20px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        #coinBuffContainer {
            position: fixed;
            top: 24px;
            right: 24px;
            display: flex;
            flex-direction: row;
            align-items: flex-start;
            gap: 18px;
            z-index: 2100;
        }

        .coin-stack {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 12px;
        }

        #coinDisplay {
            display: flex;
            align-items: center;
            gap: 14px;
            background: rgba(15, 23, 42, 0.75);
            border-radius: 20px;
            padding: 14px 20px;
            box-shadow: 0 22px 40px rgba(15, 23, 42, 0.28);
            border: 1px solid rgba(148, 163, 184, 0.45);
            backdrop-filter: blur(14px);
            min-width: 220px;
            color: #f8fafc;
        }

        #coinDisplay .coin-icon {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            background: linear-gradient(135deg, #facc15 0%, #f97316 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            color: #78350f;
            box-shadow: 0 12px 26px rgba(250, 204, 21, 0.35);
        }

        #coinDisplay .coin-text {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 3px;
        }

        #coinDisplay .coin-label {
            font-size: 0.78em;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: rgba(226, 232, 240, 0.82);
        }

        #coinDisplay .coin-amount {
            font-size: 1.6em;
            font-weight: 800;
            color: #ffeab6;
        }

        .buff-panel {
            background: rgba(248, 250, 252, 0.92);
            border-radius: 16px;
            padding: 12px 14px;
            box-shadow: 0 16px 30px rgba(15, 23, 42, 0.14);
            border: 1px solid rgba(203, 213, 225, 0.45);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            gap: 8px;
            width: min(260px, 85vw);
        }

        .buff-panel-header {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            gap: 8px;
        }

        .buff-panel-title {
            font-size: 0.82em;
            font-weight: 800;
            color: #0f172a;
        }

        #buffContainer {
            display: grid;
            grid-auto-flow: column;
            grid-template-rows: repeat(3, minmax(0, auto));
            grid-auto-columns: 1fr;
            gap: 6px;
            width: 100%;
        }

        .buff-icon {
            position: relative;
            border-radius: 12px;
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: linear-gradient(135deg, rgba(241, 245, 249, 0.9), rgba(226, 232, 240, 0.85));
            color: #0f172a;
            cursor: pointer;
            width: 100%;
            min-height: 64px;
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.1);
            transition: box-shadow 0.2s ease, transform 0.2s ease;
            overflow: hidden;
            transform-style: preserve-3d;
        }

        .buff-icon:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 28px rgba(15, 23, 42, 0.14);
        }

        .buff-icon .buff-face {
            position: absolute;
            inset: 0;
            padding: 8px 10px;
            display: flex;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            transition: transform 0.35s ease, opacity 0.35s ease;
        }

        .buff-icon .buff-front {
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            opacity: 1;
            transform: rotateY(0deg);
        }

        .buff-icon .buff-back {
            flex-direction: column;
            gap: 6px;
            opacity: 0;
            transform: rotateY(-180deg);
        }

        .buff-icon.flipped .buff-front {
            opacity: 0;
            transform: rotateY(180deg);
        }

        .buff-icon.flipped .buff-back {
            opacity: 1;
            transform: rotateY(0deg);
        }

        .buff-icon .buff-name {
            font-size: 0.84em;
            font-weight: 700;
            color: #0f172a;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .buff-icon .buff-timer {
            font-size: 0.8em;
            font-weight: 700;
            color: #1f2937;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 999px;
            padding: 2px 10px;
            white-space: nowrap;
            min-width: 48px;
            text-align: center;
        }

        .buff-detail-tag {
            font-size: 0.74em;
            font-weight: 700;
            color: #1d4ed8;
            line-height: 1.25;
        }

        .buff-detail-content {
            font-size: 0.7em;
            color: #475569;
            line-height: 1.35;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .buff-icon.luck {
            background: linear-gradient(135deg, rgba(220, 252, 231, 0.95), rgba(187, 247, 208, 0.88));
            border-color: rgba(52, 211, 153, 0.4);
        }

        .buff-icon.speed {
            background: linear-gradient(135deg, rgba(255, 247, 237, 0.95), rgba(254, 215, 170, 0.88));
            border-color: rgba(251, 191, 36, 0.45);
        }

        .buff-icon.speed_boost {
            background: linear-gradient(135deg, rgba(239, 246, 255, 0.95), rgba(191, 219, 254, 0.88));
            border-color: rgba(59, 130, 246, 0.35);
        }

        .buff-icon.xiaomi_phone {
            background: linear-gradient(135deg, rgba(254, 243, 199, 0.95), rgba(253, 230, 138, 0.88));
            border-color: rgba(245, 158, 11, 0.4);
        }

        .buff-icon.cold_water {
            background: linear-gradient(135deg, rgba(219, 234, 254, 0.95), rgba(191, 219, 254, 0.88));
            border-color: rgba(59, 130, 246, 0.35);
        }

        .buff-icon.weekend {
            background: linear-gradient(135deg, rgba(254, 226, 226, 0.95), rgba(254, 215, 226, 0.88));
            border-color: rgba(244, 114, 182, 0.4);
        }

        .buff-empty {
            width: 100%;
            padding: 6px 8px;
            border-radius: 10px;
            background: rgba(226, 232, 240, 0.5);
            color: #64748b;
            font-size: 0.72em;
            font-weight: 600;
            text-align: center;
        }
        /* ÏÑ§Ï†ï Ìå®ÎÑê (Ï¢åÏ∏° ÏÉÅÎã®) */
        #settingsPanel {
            position: fixed;
            top: 16px;
            left: 16px;
            z-index: 2100;
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: flex-start;
        }
        #settingsPanel.collapsed {
            width: auto;
            height: auto;
        }
        #settingsPanel.open {
            width: auto;
            height: auto;
        }
        .settings-toggle {
            width: 56px;
            height: 56px;
            border-radius: 18px;
            border: none;
            background: #ffffff;
            color: #5a6ff1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4em;
            box-shadow: 0 14px 28px rgba(74, 98, 246, 0.25);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .settings-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 16px 32px rgba(74, 98, 246, 0.32);
        }
        #settingsPanel.open .settings-toggle {
            display: none;
        }
        .settings-card {
            display: none;
            flex-direction: column;
            gap: 18px;
            background: rgba(255, 255, 255, 0.96);
            border-radius: 20px;
            padding: 22px 24px 24px;
            width: min(420px, 92vw);
            border: 1px solid rgba(255, 255, 255, 0.45);
            box-shadow: 0 24px 48px rgba(15, 23, 42, 0.2);
            backdrop-filter: blur(14px);
        }
        #settingsPanel.open .settings-card {
            display: flex;
        }
        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }
        .settings-header-main {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        .settings-title {
            font-size: 1.4em;
            font-weight: 800;
            color: #1f2933;
        }
        .settings-subtitle {
            font-size: 0.9em;
            color: #6c757d;
        }
        .settings-close {
            width: 34px;
            height: 34px;
            border-radius: 10px;
            border: none;
            background: #f1f3f5;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background 0.2s ease;
        }
        .settings-close:hover {
            background: #e9ecef;
        }
        .settings-stat-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(0, 1fr));
            gap: 12px;
        }
        .settings-stat {
            background: #f8f9fb;
            border: 1px solid #e9ecef;
            border-radius: 14px;
            padding: 12px 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .settings-stat-label {
            font-size: 0.85em;
            color: #6c757d;
            font-weight: 600;
        }
        .settings-stat-value {
            font-size: 1.2em;
            font-weight: 800;
            color: #2b2d42;
        }
        .settings-highlight {
            background: linear-gradient(135deg, rgba(120, 97, 255, 0.14) 0%, rgba(120, 197, 255, 0.14) 100%);
            border: 1px solid rgba(120, 97, 255, 0.28);
            border-radius: 14px;
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .settings-highlight-label {
            font-size: 0.85em;
            color: #5c6c85;
            font-weight: 600;
        }
        .settings-highlight-value {
            font-size: 0.95em;
            font-weight: 700;
            color: #2f3b52;
        }
        .settings-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .settings-section-title {
            font-size: 0.95em;
            font-weight: 700;
            color: #374151;
        }
        .settings-section-content {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .code-input-container {
            display: flex;
            gap: 10px;
        }
        .settings-input {
            flex: 1;
            padding: 10px 14px;
            border-radius: 10px;
            border: 1px solid #d1d9e6;
            font-size: 0.95em;
            background: #ffffff;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        .settings-input:focus {
            outline: none;
            border-color: #6c5ce7;
            box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.2);
        }
        .settings-primary {
            padding: 10px 18px;
            border-radius: 10px;
            border: none;
            background: linear-gradient(135deg, #6c5ce7 0%, #8a7cf8 100%);
            color: #ffffff;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .settings-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 20px rgba(108, 92, 231, 0.24);
        }
        .settings-helper {
            font-size: 0.8em;
            color: #6c757d;
        }
        .settings-reset {
            margin-top: 6px;
            width: 100%;
            background: linear-gradient(135deg, #ff6b6b 0%, #ff3d71 100%);
            color: #ffffff;
            border: none;
            padding: 12px 14px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .settings-reset:hover {
            transform: translateY(-1px);
            box-shadow: 0 15px 24px rgba(255, 107, 107, 0.3);
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .dot.active {
            background: white;
            transform: scale(1.2);
        }

        .dot.locked {
            background: rgba(255, 255, 255, 0.3);
            cursor: not-allowed;
            opacity: 0.5;
        }


        h1 {
            color: #0f172a;
            margin-bottom: 36px;
            font-size: 2.85em;
            font-weight: 800;
            letter-spacing: -0.01em;
        }

        .draw-area {
            margin: 40px 0;
            padding: 32px 38px;
            background: linear-gradient(145deg, rgba(248, 250, 252, 0.88) 0%, rgba(226, 232, 240, 0.78) 100%);
            border-radius: 24px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.6), 0 24px 40px rgba(15, 23, 42, 0.12);
        }

        .result-display {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.92) 0%, rgba(241, 245, 249, 0.92) 100%);
            border: 1px solid rgba(148, 163, 184, 0.28);
            border-radius: 20px;
            padding: 48px 30px;
            margin: 24px 0 28px;
            min-height: 150px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.9em;
            color: #475569;
            transition: all 0.35s ease;
            box-shadow: 0 24px 45px rgba(15, 23, 42, 0.12);
        }

        .result-display.reset {
            font-size: 1.3em;
            color: #64748b;
            background: transparent;
            border-color: rgba(148, 163, 184, 0.22);
        }
        .result-display.miss {
            background: transparent;
            font-weight: 700;
            font-size: 2.3em;
            animation: pulse 0.55s ease-in-out;
        }

        .result-display.winner {
            background: transparent;
            font-weight: 700;
            font-size: 2.4em;
            animation: pulse 0.55s ease-in-out;
        }

        .result-display.shining {
            background: linear-gradient(135deg, #fff4d1 0%, #ffdd8c 100%);
            border: 1px solid rgba(245, 196, 74, 0.45);
            color: #b45309;
            font-weight: 700;
            font-size: 2.4em;
            animation: pulse 0.55s ease-in-out;
        }

        .result-display.sparkling {
            background: linear-gradient(135deg, #ffe3a3 0%, #ffb347 100%);
            border: 1px solid rgba(249, 115, 22, 0.45);
            color: #9a3412;
            font-weight: 700;
            font-size: 2.4em;
            animation: pulse 0.55s ease-in-out;
            box-shadow: 0 0 26px rgba(249, 115, 22, 0.35);
        }

        .result-display.golden {
            background: linear-gradient(135deg, #ffd700 0%, #ffb200 35%, #d97706 100%);
            border: 1px solid rgba(217, 119, 6, 0.6);
            color: #5f370e;
            font-weight: 800;
            font-size: 2.45em;
            animation: goldenGlow 2s ease-in-out infinite;
            box-shadow: 0 0 40px rgba(217, 119, 6, 0.55);
        }
        .result-display.diamond {
            background: linear-gradient(135deg, #bae6fd 0%, #67e8f9 40%, #38bdf8 100%);
            border: 1px solid rgba(14, 165, 233, 0.5);
            color: #0c4a6e;
            font-weight: 800;
            font-size: 2.45em;
            animation: diamondSparkle 2s ease-in-out infinite;
            box-shadow: 0 0 30px rgba(14, 165, 233, 0.55);
        }
        .result-display.rainbow {
            background: #ff4d4d; /* Îçî ÏßÑÌïú ÏãúÏûë ÏÉâ */
            border: 1px solid rgba(255,255,255,0.5); /* ÏùÄÏùÄÌïú ÎùºÏù∏ */
            color: #000000; /* Í∏ÄÏûêÏÉâ Í≤ÄÏ†ï Í≥†Ï†ï */
            font-weight: 800;
            font-size: 2.5em;
            animation: rainbowCycle 1.6s linear infinite, rainbowAura 1.6s ease-in-out infinite alternate, rainbowSparkle 0.7s ease-in-out infinite alternate;
            box-shadow: 0 0 26px rgba(255,255,255,0.45);
            position: relative;
        }

        .result-display.rainbow::after { display: none; }

        /* Í¥ëÌÉù Ìö®Í≥º Ï†úÍ±∞ (before ÏöîÏÜå ÏÇ≠Ï†ú) */

        @keyframes rainbowCycle {
            0%   { background: #ff4d4d; color: #000000; }
            16%  { background: #ff9f1a; color: #000000; }
            33%  { background: #ffd60a; color: #000000; }
            50%  { background: #2ecc71; color: #000000; }
            66%  { background: #3498db; color: #000000; }
            83%  { background: #6c5ce7; color: #000000; }
            100% { background: #9b59b6; color: #000000; }
        }

        @keyframes rainbowAura {
            0%   { box-shadow: 0 0 14px rgba(255,179,186,0.35), 0 0 28px rgba(255,217,179,0.25); }
            50%  { box-shadow: 0 0 22px rgba(186,255,201,0.45), 0 0 36px rgba(186,225,255,0.35); }
            100% { box-shadow: 0 0 18px rgba(208,179,255,0.4), 0 0 30px rgba(255,179,186,0.3); }
        }

        @keyframes rainbowBorder {
            0%   { border-color: rgba(255,179,186,0.6); }
            16%  { border-color: rgba(255,217,179,0.6); }
            33%  { border-color: rgba(255,243,179,0.6); }
            50%  { border-color: rgba(186,255,201,0.6); }
            66%  { border-color: rgba(186,225,255,0.6); }
            83%  { border-color: rgba(208,179,255,0.6); }
            100% { border-color: rgba(255,179,186,0.6); }
        }

        @keyframes rainbowSparkle {
            0% { filter: brightness(1) saturate(1); }
            100% { filter: brightness(1.25) saturate(1.1); }
        }

        /* Í¥ëÌÉù ÌÇ§ÌîÑÎ†àÏûÑ Ï†úÍ±∞ */

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        @keyframes goldenGlow {
            0% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 215, 0, 0.3), 0 0 60px rgba(255, 215, 0, 0.1); }
            50% { box-shadow: 0 0 30px rgba(255, 215, 0, 0.8), 0 0 60px rgba(255, 215, 0, 0.5), 0 0 90px rgba(255, 215, 0, 0.2); }
            100% { box-shadow: 0 0 20px rgba(255, 215, 0, 0.5), 0 0 40px rgba(255, 215, 0, 0.3), 0 0 60px rgba(255, 215, 0, 0.1); }
        }

        @keyframes diamondSparkle {
            0% { box-shadow: 0 0 20px rgba(0, 191, 255, 0.5), 0 0 40px rgba(0, 191, 255, 0.3), 0 0 60px rgba(0, 191, 255, 0.1); }
            25% { box-shadow: 0 0 30px rgba(0, 191, 255, 0.8), 0 0 60px rgba(0, 191, 255, 0.5), 0 0 90px rgba(0, 191, 255, 0.2); }
            50% { box-shadow: 0 0 25px rgba(0, 191, 255, 0.6), 0 0 50px rgba(0, 191, 255, 0.4), 0 0 75px rgba(0, 191, 255, 0.15); }
            75% { box-shadow: 0 0 35px rgba(0, 191, 255, 0.9), 0 0 70px rgba(0, 191, 255, 0.6), 0 0 100px rgba(0, 191, 255, 0.25); }
            100% { box-shadow: 0 0 20px rgba(0, 191, 255, 0.5), 0 0 40px rgba(0, 191, 255, 0.3), 0 0 60px rgba(0, 191, 255, 0.1); }
        }


        @keyframes confetti {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }

        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background: #ffd700;
            animation: confetti 3s linear infinite;
            z-index: 1000;
        }

        .confetti:nth-child(odd) {
            background: #ff6b6b;
            animation-delay: 0.5s;
        }

        .confetti:nth-child(3n) {
            background: #4ecdc4;
            animation-delay: 1s;
        }

        .confetti:nth-child(4n) {
            background: #45b7d1;
            animation-delay: 1.5s;
        }

        .confetti:nth-child(5n) {
            background: #96ceb4;
            animation-delay: 2s;
        }

        .draw-button {
            background: linear-gradient(120deg, #fb923c 0%, #f97316 100%);
            color: #ffffff;
            border: none;
            padding: 18px 48px;
            font-size: 1.35em;
            border-radius: 40px;
            cursor: pointer;
            transition: transform 0.25s ease, box-shadow 0.25s ease, filter 0.25s ease;
            box-shadow: 0 18px 35px rgba(249, 115, 22, 0.32);
            margin: 15px;
            font-weight: 700;
            letter-spacing: 0.02em;
        }

        .draw-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 24px 45px rgba(249, 115, 22, 0.36);
            filter: brightness(1.03);
        }

        .draw-button:active {
            transform: translateY(-1px);
        }

        .draw-button[disabled], .draw-button.disabled {
            background: linear-gradient(120deg, #cbd5f5 0%, #a5b4fc 100%);
            cursor: not-allowed;
            box-shadow: none;
            color: #475569;
        }

        /* Ï†ëÏù¥Ïãù Ìå®ÎÑê Í≥µÌÜµ Ïä§ÌÉÄÏùº */
        .collapse-panel {
            margin-top: 15px;
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 12px;
            padding: 12px;
            display: none;
        }
        .panel-tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
        }
        .tab-button {
            background: #e9ecef;
            border: none;
            padding: 8px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
        }
        .tab-button.active {
            background: #007bff;
            color: #fff;
        }
        .panel-content {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
        }

        /* ÎèÖÎ¶Ω Ïò§Î≤ÑÎ†àÏù¥ Ìå®ÎÑê */
        .overlay {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            max-height: 60vh;
            background: #ffffff;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.2);
            border-top: 4px solid #007bff;
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 2000;
            padding: 16px;
            overflow-y: auto;
        }
        .overlay.open {
            transform: translateY(0);
        }
        .overlay .overlay-header {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        .overlay .overlay-header .tab-button { flex: none; }

        /* ÏïÑÎûòÎ°ú ÎÇ¥Î†§Ïò§Îäî Ìå®ÎÑê */
        .bottom-panel {
            display: none;
            margin-top: 12px;
            background: #ffffff;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 16px;
        }
        .bottom-panel h2 {
            font-size: 1.4em;
            margin: 10px 0;
            color: #333;
        }
        .bottom-row { display: flex; gap: 16px; align-items: flex-start; }
        .bottom-col { flex: 1; min-width: 0; }

        /* Ïú†Î¨º Ïª¨Î†âÏÖò Í∑∏Î¶¨Îìú */
        /* Ïú†Î¨º Ïª¨Î†âÏÖò: 3x3 Í∑∏Î¶¨Îìú */
        .artifact-carousel { 
            width: 100%; 
            min-height: 480px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px 0;
        }
        .artifact-collection-screen .container {
            max-width: 1500px;
            width: 95%;
            transform: scale(0.9);
            transform-origin: top center;
            margin-top: 180px;
            margin-bottom: 100px;
        }
        .artifact-collection-screen .container h1 {
            margin-top: 0;
            margin-bottom: 20px;
        }
        .artifact-grid { 
            display: grid;
            grid-template-columns: repeat(6, 130px);
            column-gap: 8px;
            row-gap: 12px;
            width: 100%;
            padding: 16px 0;
            margin: 0 auto;
            justify-items: center;
            justify-content: center;
        }
        .artifact-card {
            position: relative;
            width: 128px;
            max-width: 128px;
            aspect-ratio: 3 / 4;
            transform-style: preserve-3d;
            transition: transform 0.6s ease, box-shadow 0.3s ease;
            border-radius: 20px;
            box-shadow: 0 10px 24px rgba(0, 0, 0, 0.08);
        }
        .artifact-card:not(.locked) {
            cursor: pointer;
        }
        .artifact-card.flipped {
            transform: rotateY(180deg);
            box-shadow: 0 18px 36px rgba(0, 0, 0, 0.16);
        }
        .artifact-card.locked { 
            cursor: default;
        }
        .artifact-front,
        .artifact-back {
            position: absolute;
            inset: 0;
            border-radius: 20px;
            padding: 20px 18px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            backface-visibility: hidden;
            transition: background 0.3s ease, border 0.3s ease, color 0.3s ease;
        }
        .artifact-front {
            background: linear-gradient(135deg, #f1f3f5 0%, #e9ecef 100%);
            border: 1px solid rgba(173, 181, 189, 0.6);
            color: #495057;
        }
        .artifact-back {
            background: linear-gradient(135deg, #5c7082 0%, #445769 100%);
            color: #ffffff;
            transform: rotateY(180deg);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .artifact-card.level-1 .artifact-front {
            background: linear-gradient(135deg, #e4f9d6 0%, #a8e6a3 100%);
            border-color: rgba(102, 187, 106, 0.65);
            color: #255d31;
        }
        .artifact-card.level-1 .artifact-back {
            background: linear-gradient(135deg, #2e7d32 0%, #43a047 100%);
        }
        .artifact-card.level-2 .artifact-front {
            background: linear-gradient(135deg, #d0f0ff 0%, #9ad7ff 100%);
            border-color: rgba(33, 150, 243, 0.6);
            color: #0d47a1;
        }
        .artifact-card.level-2 .artifact-back {
            background: linear-gradient(135deg, #1976d2 0%, #42a5f5 100%);
        }
        .artifact-card.level-3 .artifact-front {
            background: linear-gradient(135deg, #e3d0ff 0%, #c4a9ff 100%);
            border-color: rgba(156, 39, 176, 0.6);
            color: #4a148c;
        }
        .artifact-card.level-3 .artifact-back {
            background: linear-gradient(135deg, #6a1b9a 0%, #8e24aa 100%);
        }
        .artifact-card.level-4 .artifact-front {
            background: linear-gradient(135deg, #ffe1e1 0%, #ffb3c1 100%);
            border-color: rgba(244, 114, 182, 0.6);
            color: #991b1b;
        }
        .artifact-card.level-4 .artifact-back {
            background: linear-gradient(135deg, #e11d48 0%, #f43f5e 100%);
        }
        .artifact-card.level-5 .artifact-front {
            background: linear-gradient(135deg, #fff7d6 0%, #fde68a 100%);
            border-color: rgba(250, 204, 21, 0.65);
            color: #92400e;
        }
        .artifact-card.level-5 .artifact-back {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }
        .artifact-level-badge {
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 0.8em;
            font-weight: 800;
            padding: 5px 10px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.92);
            color: #d35400;
            box-shadow: 0 6px 14px rgba(211, 84, 0, 0.22);
        }
        .artifact-card.locked .artifact-level-badge {
            background: rgba(255, 255, 255, 0.85);
            color: #6c757d;
            box-shadow: none;
        }
        .artifact-name {
            font-size: 1.05em;
            font-weight: 800;
            line-height: 1.45;
            word-break: keep-all;
        }
        .artifact-front-body {
            display: flex;
            flex-direction: column;
            gap: 12px;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
        }
        .artifact-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 999px;
            font-size: 0.82em;
            font-weight: 700;
            transition: background 0.3s ease, color 0.3s ease, box-shadow 0.3s ease;
        }
        .artifact-status[data-status="locked"] {
            background: rgba(0, 0, 0, 0.05);
            color: #6c757d;
        }
        .artifact-status[data-status="locked"]::before {
            content: 'üîí';
        }
        .artifact-status[data-status="owned"] {
            background: rgba(255, 255, 255, 0.75);
            color: #c0392b;
            box-shadow: 0 6px 16px rgba(255, 140, 0, 0.25);
        }
        .artifact-status[data-status="owned"]::before {
            content: '‚ú®';
        }
        .artifact-back-heading {
            font-weight: 800;
            font-size: 1em;
            letter-spacing: 0.02em;
        }
        .artifact-back-level {
            font-size: 0.9em;
            font-weight: 700;
            opacity: 0.9;
        }
        .artifact-back-desc {
            font-size: 0.85em;
            line-height: 1.5;
            opacity: 0.9;
        }

        /* ÏÉÅÏ†ê Ïä§ÌÉÄÏùº */
        .shop-container {
            position: relative;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 28px;
            padding: 46px 48px 52px;
            box-shadow: 0 32px 60px rgba(25, 32, 56, 0.18);
            max-width: 1100px;
            width: 95%;
            border: 1px solid rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(12px);
            display: flex;
            flex-direction: column;
            gap: 24px;
        }

        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 16px;
        }

        .shop-heading {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .shop-container h2 {
            text-align: left;
            color: #1f2933;
            margin: 0;
            font-size: 2.4em;
            font-weight: 800;
        }

        .shop-subtitle {
            font-size: 0.95em;
            color: #6c7a89;
        }

        .shop-metadata {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .shop-timer {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #4c5c68;
            font-size: 1.05em;
            font-weight: 700;
            padding: 12px 16px;
            background: rgba(90, 111, 241, 0.12);
            border-radius: 12px;
            border: 1px solid rgba(90, 111, 241, 0.24);
        }

        .shop-timer::before {
            content: '‚è±';
            font-size: 1.1em;
        }

        .shop-probability {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            color: #3f4c5d;
            font-size: 0.9em;
            padding: 10px 14px;
            background: #f3f6ff;
            border-radius: 12px;
            border: 1px solid rgba(123, 140, 218, 0.35);
            font-weight: 600;
        }

        .shop-items {
            display: flex;
            flex-direction: row;
            gap: 26px;
            justify-content: center;
        }

        .shop-item {
            position: relative;
            background: #ffffff;
            border: 1px solid rgba(223, 228, 238, 0.7);
            border-radius: 22px;
            padding: 36px 24px;
            text-align: center;
            height: 420px;
            width: 260px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 18px;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            cursor: pointer;
            position: relative;
            box-shadow: 0 14px 28px rgba(15, 23, 42, 0.12);
        }

        .shop-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 24px 40px rgba(15, 23, 42, 0.18);
        }

        .shop-item.sold-out {
            background: #f1f3f5 !important;
            border-color: #ced4da !important;
            opacity: 0.65;
            cursor: not-allowed;
        }
        .shop-item.sold-out:hover {
            transform: none;
            box-shadow: 0 14px 28px rgba(15, 23, 42, 0.12);
        }

        .shop-item .sold-out-label {
            position: absolute;
            top: 16px;
            right: 16px;
            padding: 8px 14px;
            border-radius: 999px;
            font-size: 0.9em;
            font-weight: 700;
            background: rgba(15, 30, 54, 0.85);
            color: #ffffff;
            pointer-events: none;
        }

        /* ÏÉÅÏ†ê Î¨ºÌíà Îì±Í∏âÎ≥Ñ Î∞∞Í≤ΩÏÉâ */
        .shop-item.common {
            background: linear-gradient(135deg, #f9fbff 0%, #eef1f8 100%);
            border-color: rgba(206, 214, 224, 0.7);
        }

        .shop-item.rare {
            background: linear-gradient(135deg, #e7f7e9 0%, #c4efdb 100%);
            border-color: rgba(76, 175, 80, 0.35);
        }

        .shop-item.epic {
            background: linear-gradient(135deg, #e1e9ff 0%, #c6d8ff 100%);
            border-color: rgba(66, 133, 244, 0.35);
        }

        .shop-item.hero {
            background: linear-gradient(135deg, #f1e1ff 0%, #d8c1ff 100%);
            border-color: rgba(156, 39, 176, 0.35);
        }

        .shop-item.legendary {
            background: linear-gradient(135deg, #fff4d6 0%, #ffe3a1 100%);
            border-color: rgba(255, 193, 7, 0.4);
        }

        .shop-item-name {
            font-weight: 800;
            font-size: 1.35em;
            color: #1f2933;
        }

        .shop-item-price {
            font-size: 1.2em;
            color: #334155;
            font-weight: 700;
        }

        .shop-item-desc {
            font-size: 0.9em;
            color: #6b7280;
            line-height: 1.5;
        }

        /* ÌôïÎ•†Ìëú Ïä§ÌÉÄÏùº */
        .probability-list {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .probability-item {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.85);
            border-radius: 10px;
            padding: 9px 22px;
            border: 1px solid rgba(203, 213, 225, 0.5);
            box-shadow: 0 9px 18px rgba(15, 23, 42, 0.08);
            position: relative;
            transition: transform 0.18s ease, box-shadow 0.18s ease;
        }

        .probability-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 16px 28px rgba(15, 23, 42, 0.12);
        }

        .probability-item .participant-name {
            font-weight: 700;
            color: #1f2937;
            font-size: 1em;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .probability-value {
            margin-left: auto;
            font-weight: 800;
            font-size: 1em;
            color: #1f2937;
            background: rgba(90, 111, 241, 0.08);
            border: 1px solid rgba(90, 111, 241, 0.25);
            border-radius: 999px;
            padding: 3px 12px;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .probability-layout {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
        }

        .probability-label {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 700;
            color: #1f2937;
        }

        .probability-item.no-hover {
            cursor: default;
        }

        .probability-item:not(.no-hover):hover {
            transform: translateY(-2px);
            box-shadow: 0 24px 44px rgba(99, 102, 241, 0.18);
        }
        .participant-name {
            font-weight: 800;
            color: #1f2937;
            font-size: 1em;
            flex: 1;
            min-width: 0;
            white-space: nowrap;
            overflow: visible;
        }

        .probability-value {
            display: inline-flex;
            align-items: center;
            padding: 3px 12px;
            border-radius: 999px;
            background: rgba(59, 130, 246, 0.14);
            color: #1d4ed8;
            font-weight: 800;
            font-size: 0.98em;
            margin-left: auto;
        }

        .probability-item.no-hover .probability-value {
            background: rgba(239, 68, 68, 0.14);
            color: #b91c1c;
        }

        .shining-info {
            width: 100%;
            background: rgba(255, 255, 255, 0.97);
            border-radius: 9px;
            border: 1px solid rgba(226, 232, 240, 0.85);
            font-size: 0.9em;
            color: #374151;
            box-shadow: 0 18px 34px rgba(15, 23, 42, 0.12);
            overflow: hidden;
            max-height: 0;
            opacity: 0;
            margin-top: 0;
            padding: 0 12px;
            pointer-events: none;
            transition: max-height 0.3s ease, opacity 0.22s ease, margin 0.22s ease, padding 0.22s ease;
        }

        .probability-item.expanded {
            border-color: rgba(99, 102, 241, 0.35);
            box-shadow: 0 26px 48px rgba(99, 102, 241, 0.22);
        }

        .probability-item.expanded .shining-info {
            margin-top: -16px;
            padding: 6px 12px 10px;
            max-height: 540px;
            opacity: 1;
            pointer-events: auto;
            overflow: visible;
        }

        .shining-info .effect-title {
            font-weight: 700;
            font-size: 0.82em;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
            color: #4338ca;
        }

        .shining-info .effect-probability {
            background: rgba(249, 250, 251, 0.85);
            padding: 3px 8px;
            border-radius: 5px;
            margin: 0;
            font-weight: 700;
            color: #1f2937;
            border: 1px solid rgba(203, 213, 225, 0.6);
            display: flex;
            flex-direction: column;
            gap: 1px;
            font-size: 0.6em;
        }

        .effect-prob-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 3px;
            width: 100%;
        }

        .effect-label {
            flex: 1;
            min-width: 0;
            white-space: normal;
            overflow: visible;
        }

        .shining-info .effect-probability small {
            font-size: 0.54em;
            color: #4b5563;
            font-weight: 500;
        }

        .effect-boost {
            color: #2563eb;
            font-weight: 700;
            white-space: nowrap;
        }

        .shining-info .effect-description {
            font-size: 0.76em;
            color: #374151;
            margin-top: 4px;
            padding: 3px 7px;
            background: rgba(238, 242, 255, 0.65);
            border-radius: 6px;
            border-left: 3px solid rgba(99, 102, 241, 0.45);
        }

        /* Î≥¥Í¥ÄÏÜå Í∏∞Î≥∏ Ïä§ÌÉÄÏùº */
        .storage-container .container {
            max-width: 640px;
            width: 95%;
            padding: 52px 48px;
            background: linear-gradient(155deg, rgba(248, 250, 252, 0.95) 0%, rgba(229, 234, 246, 0.9) 100%);
            box-shadow: 0 34px 60px rgba(15, 23, 42, 0.14);
        }

        .storage-list {
            max-height: 600px;
            overflow-y: auto;
            margin-top: 24px;
            padding-right: 6px;
        }

        /* ÏïÑÏù¥ÌÖú Î≥¥Í¥ÄÏÜå Ï†ÑÏö© Ïä§ÌÉÄÏùº */
        .item-storage-screen .container {
            max-width: 1500px;
            width: 95%;
            padding: 48px 52px;
            border-radius: 30px;
            background: rgba(255, 255, 255, 0.96);
            border: 1px solid rgba(255, 255, 255, 0.55);
            box-shadow: 0 36px 70px rgba(15, 23, 42, 0.2);
            backdrop-filter: blur(14px);
            display: flex;
            flex-direction: column;
            gap: 18px;
            transform: scale(0.9);
            transform-origin: top center;
            margin-top: 180px;
            margin-bottom: 100px;
        }

        .item-storage-screen .container h1 {
            margin: 0;
            font-size: 2.6em;
            color: #1f2933;
            font-weight: 800;
        }
        .item-storage-screen .storage-subtitle {
            margin: 0;
            margin-top: -6px;
            color: #6b7c8f;
            font-size: 0.96em;
        }
        .item-storage-screen .storage-list {
            display: grid;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            gap: 26px;
            max-height: 520px;
            overflow-y: auto;
            padding-right: 6px;
        }

        .item-storage-screen .storage-row {
            display: contents;
        }

        .item-storage-screen .storage-list::-webkit-scrollbar {
            width: 8px;
        }

        .item-storage-screen .storage-list::-webkit-scrollbar-track {
            background: rgba(226, 232, 240, 0.4);
            border-radius: 999px;
        }

        .item-storage-screen .storage-list::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.6);
            border-radius: 999px;
        }
        .item-storage-screen .storage-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 0;
            border: 1px dashed rgba(148, 163, 184, 0.45);
            border-radius: 20px;
            color: #6b7c8f;
            background: rgba(248, 250, 252, 0.65);
            font-weight: 600;
        }

        .item-storage-screen .storage-item {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 14px;
            padding: 24px 22px;
            background: linear-gradient(135deg, #f9fafb 0%, #edf2f7 100%);
            border-radius: 24px;
            border: 1px solid rgba(203, 213, 225, 0.6);
            box-shadow: 0 18px 36px rgba(15, 23, 42, 0.12);
            transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
            cursor: pointer;
            overflow: hidden;
            align-items: flex-start;
            min-height: 220px;
        }

        .item-storage-screen .storage-item:hover {
            transform: translateY(-6px);
            box-shadow: 0 32px 56px rgba(15, 23, 42, 0.22);
        }

        .item-storage-screen .storage-item.selected {
            border-color: rgba(79, 70, 229, 0.55);
            box-shadow: 0 30px 58px rgba(79, 70, 229, 0.24);
        }

        .item-storage-screen .storage-item-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            width: 100%;
            gap: 12px;
        }

        .item-storage-screen .storage-item-name {
            font-size: 1.1em;
            font-weight: 900;
            color: #111827;
            flex: 1;
            line-height: 1.4;
        }

        .item-storage-screen .storage-item-count {
            font-weight: 900;
            font-size: 0.95em;
            color: #1f2937;
            background: rgba(17, 24, 39, 0.08);
            padding: 4px 12px;
            border-radius: 999px;
            white-space: nowrap;
        }
        .item-storage-screen .storage-item .enhanced-label {
            font-size: 0.78em;
            color: rgba(17, 24, 39, 0.6);
            font-style: italic;
        }
        .item-storage-screen .storage-item .item-description {
            font-size: 0.9em;
            color: rgba(17, 24, 39, 0.72);
            line-height: 1.6;
        }
        .item-storage-screen .storage-item .probability {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 14px;
            background: rgba(15, 23, 42, 0.04);
            border: 1px solid rgba(15, 23, 42, 0.08);
            border-radius: 14px;
            font-size: 0.85em;
            color: #1f2937;
            width: 100%;
        }
        .item-storage-screen .storage-item .probability strong {
            font-size: 1.05em;
            color: #0f172a;
        }

        .item-storage-screen .storage-item .enhance-stats {
            position: absolute;
            bottom: 18px;
            left: 22px;
            background: rgba(15, 23, 42, 0.85);
            color: #fff;
            padding: 6px 12px;
            border-radius: 10px;
            font-size: 0.78em;
            line-height: 1.3;
            display: none;
        }

        .item-storage-screen .storage-item:hover .enhance-stats {
            display: block;
        }

        .item-storage-screen .storage-item .action-btn {
            position: absolute;
            right: 22px;
            bottom: 56px;
            padding: 8px 16px;
            font-size: 0.82em;
            font-weight: 700;
            border-radius: 12px;
            color: #ffffff;
            cursor: pointer;
            user-select: none;
            display: none;
        }

        .item-storage-screen .storage-item:hover .action-btn {
            display: block;
        }

        .item-storage-screen .storage-item .action-upgrade {
            background: linear-gradient(135deg, #34d399 0%, #10b981 100%);
        }

        .item-storage-screen .storage-item .action-back {
            left: 22px;
            right: auto;
            background: linear-gradient(135deg, #f87171 0%, #ef4444 100%);
        }

        .item-storage-screen .storage-item .enhance-info {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 104px;
            background: rgba(15, 23, 42, 0.85);
            color: #fff;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 0.78em;
            white-space: nowrap;
            display: none;
        }

        .item-storage-screen .storage-item:hover .enhance-info {
            display: block;
        }

        .item-storage-screen .storage-item .sell-button,
        .item-storage-screen .storage-item .count,
        .item-storage-screen .storage-item .enhance-stats,
        .item-storage-screen .storage-item .action-btn,
        .item-storage-screen .storage-item .enhance-info {
            z-index: 2;
        }

        .item-storage-screen .storage-item .sell-button {
            position: absolute;
            top: 14px;
            right: 14px;
            width: 32px;
            height: 32px;
            background: rgba(239, 68, 68, 0.12);
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 50%;
            color: #ef4444;
            font-size: 0.95em;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .item-storage-screen .storage-item .sell-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 12px 20px rgba(239, 68, 68, 0.25);
            background: rgba(239, 68, 68, 0.18);
        }

        .item-storage-screen .storage-item .count {
            position: absolute;
            bottom: 18px;
            right: 22px;
            background: rgba(17, 24, 39, 0.85);
            color: #fff;
            font-weight: 900;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 0.88em;
            letter-spacing: 0.02em;
        }

        .item-storage-screen .storage-item .time,
        .item-storage-screen .storage-item .item-description,
        .item-storage-screen .storage-item .probability {
            z-index: 1;
        }

        .item-storage-screen .storage-item.rarity-common {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-color: rgba(148, 163, 184, 0.55);
        }

        .item-storage-screen .storage-item.rarity-rare {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: rgba(16, 185, 129, 0.45);
            box-shadow: 0 22px 44px rgba(16, 185, 129, 0.18);
        }

        .item-storage-screen .storage-item.rarity-epic {
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 100%);
            border-color: rgba(79, 70, 229, 0.45);
            box-shadow: 0 22px 44px rgba(79, 70, 229, 0.2);
        }

        .item-storage-screen .storage-item.rarity-hero {
            background: linear-gradient(135deg, #fdf2f8 0%, #fce7f3 100%);
            border-color: rgba(236, 72, 153, 0.45);
            box-shadow: 0 24px 48px rgba(236, 72, 153, 0.22);
        }

        .item-storage-screen .storage-item.rarity-legendary {
            background: linear-gradient(135deg, #fff7ed 0%, #fde68a 100%);
            border-color: rgba(217, 119, 6, 0.55);
            box-shadow: 0 26px 52px rgba(217, 119, 6, 0.24);
        }

        /* ÌÖåÎßàÎ≥Ñ Î∞∞Í≤Ω Í∑∏ÎùºÎç∞Ïù¥ÏÖò */
        body.theme-orange {
            background: linear-gradient(135deg, #ff7043 0%, #ff5722 100%) !important;
        }

        body.theme-green {
            background: linear-gradient(135deg, #66bb6a 0%, #2e7d32 100%) !important;
        }

        body.theme-gray {
            background: linear-gradient(135deg, #78909c 0%, #37474f 100%) !important;
        }

        body.theme-yellow {
            background: linear-gradient(135deg, #ffeb3b 0%, #ff8f00 100%) !important;
        }

        body.theme-pink {
            background: linear-gradient(135deg, #f06292 0%, #ad1457 100%) !important;
        }

        body.theme-purple {
            background: linear-gradient(135deg, #ba68c8 0%, #7b1fa2 100%) !important;
        }

        /* ÌÖåÎßà ÏÑ†ÌÉù Î≤ÑÌäº */
        .theme-selector {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            flex-wrap: wrap;
        }
        
        .code-input-container {
            display: flex;
            gap: 10px;
            margin-top: 8px;
            align-items: center;
        }

        .theme-button {
            width: 30px;
            height: 30px;
            border: 2px solid #fff;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .theme-button:hover {
            transform: scale(1.1);
            border-color: #007bff;
        }
        .theme-button.active {
            border-color: #007bff;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.3);
        }
        .theme-button.default {
            background: linear-gradient(135deg, #42a5f5 0%, #1976d2 100%);
        }

        .theme-button.orange {
            background: linear-gradient(135deg, #ff8a65 0%, #ff5722 100%);
        }

        .theme-button.green {
            background: linear-gradient(135deg, #81c784 0%, #4caf50 100%);
        }

        .theme-button.gray {
            background: linear-gradient(135deg, #90a4ae 0%, #607d8b 100%);
        }

        .theme-button.yellow {
            background: linear-gradient(135deg, #fff176 0%, #ffc107 100%);
        }

        .theme-button.pink {
            background: linear-gradient(135deg, #f48fb1 0%, #e91e63 100%);
        }

        .theme-button.purple {
            background: linear-gradient(135deg, #ba68c8 0%, #7b1fa2 100%);
        }

        .storage-row {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        .storage-item {
            background: linear-gradient(160deg, rgba(255, 255, 255, 0.95) 0%, rgba(241, 245, 249, 0.95) 100%);
            padding: 18px 16px 56px;
            border-radius: 18px;
            border: 1px solid rgba(148, 163, 184, 0.25);
            width: 240px;
            min-width: 240px;
            transition: transform 0.25s ease, box-shadow 0.25s ease, border-color 0.25s ease;
            position: relative;
            box-shadow: 0 20px 36px rgba(15, 23, 42, 0.12);
        }

        /* Î≥¥Í¥ÄÏÜå ÏïÑÏù¥ÌÖú ÏÑ†ÌÉù Ïãú ÏÇ¥Ïßù Ïó∞Ìï¥ Î≥¥Ïù¥ÎèÑÎ°ù */
        .storage-item.selected { transform: translateY(-4px); box-shadow: 0 26px 46px rgba(30, 64, 175, 0.18); border-color: rgba(99, 102, 241, 0.35); }
        /* Ïò§Î≤Ñ ÏãúÏóêÎèÑ Ïó∞Ìï¥ Î≥¥Ïù¥ÎèÑÎ°ù */
        .storage-item:hover { transform: translateY(-4px); box-shadow: 0 26px 46px rgba(30, 64, 175, 0.18); border-color: rgba(99, 102, 241, 0.28); }

        /* Î≥¥Í¥ÄÏÜå ÏïÑÏù¥ÌÖú ÎÇ¥ Ïï°ÏÖò Î≤ÑÌäºÎì§ */
        .storage-item .action-btn {
            position: absolute;
            bottom: 12px;
            padding: 7px 12px;
            font-size: 0.82em;
            font-weight: 700;
            border-radius: 999px;
            color: #0f172a;
            cursor: pointer;
            user-select: none;
            display: none; /* Í∏∞Î≥∏ Ïà®ÍπÄ */
            background: rgba(248, 250, 252, 0.85);
            border: 1px solid rgba(148, 163, 184, 0.35);
            box-shadow: 0 8px 16px rgba(15, 23, 42, 0.18);
        }
        .storage-item .action-back {
            left: 16px;
            color: #b91c1c;
            border-color: rgba(248, 113, 113, 0.35);
            background: rgba(254, 226, 226, 0.9);
        }
        .storage-item .action-upgrade {
            right: 16px;
            color: #1d4ed8;
            border-color: rgba(99, 102, 241, 0.4);
            background: rgba(224, 231, 255, 0.92);
        }
        .storage-item .enhance-info {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            bottom: 50px; /* Î≤ÑÌäºÎì§ ÏúÑÏóê ÌëúÏãú */
            background: rgba(15, 23, 42, 0.8);
            color: #f8fafc;
            padding: 8px 14px;
            border-radius: 10px;
            font-size: 0.78em;
            white-space: nowrap;
            display: none; /* Í∏∞Î≥∏ Ïà®ÍπÄ */
            box-shadow: 0 16px 30px rgba(15, 23, 42, 0.3);
        }

        /* Ïò§Î≤Ñ Ïãú Ïª®Ìä∏Î°§Í≥º Ï†ïÎ≥¥ ÌëúÏãú */
        .storage-item:hover .action-btn { display: block; }
        .storage-item:hover .enhance-info { display: block; }

        /* Í∏∞Î≥∏ ÎßàÏö∞Ïä§ Ïò§Î≤Ñ Ìö®Í≥º Ï†úÍ±∞ - Í∞ïÌôîÎêú ÏïÑÏù¥ÌÖúÎßå Ìö®Í≥º Ï†ÅÏö© */

        .storage-item.diamond {
            background: linear-gradient(160deg, rgba(118, 185, 253, 0.73) 0%, rgba(83, 150, 247, 0.71) 48%, rgba(49, 106, 227, 0.69) 100%);
            border-color: rgba(37, 99, 235, 0.5);
            color: #e2f0ff;
            box-shadow: 0 28px 46px rgba(37, 99, 235, 0.28), inset 0 1px 0 rgba(255, 255, 255, 0.6);
        }

        .storage-item.golden {
            background: linear-gradient(155deg, #ffd700 0%, #fbbf24 100%);
            border-color: rgba(217, 119, 6, 0.52);
            color: #78350f;
            box-shadow: 0 30px 48px rgba(217, 119, 6, 0.32);
        }

        .storage-item.sparkling {
            background: linear-gradient(155deg, rgba(255, 224, 178, 0.98) 0%, rgba(253, 186, 116, 0.98) 100%);
            border-color: rgba(251, 146, 60, 0.45);
            color: #92400e;
            box-shadow: 0 28px 44px rgba(251, 146, 60, 0.28);
        }

        .storage-item.shining {
            background: linear-gradient(155deg, rgba(255, 242, 204, 0.96) 0%, rgba(254, 225, 120, 0.96) 100%);
            border-color: rgba(234, 179, 8, 0.36);
            color: #b45309;
            box-shadow: 0 27px 42px rgba(234, 179, 8, 0.22);
        }

        .storage-item.rainbow {
            background: linear-gradient(150deg, rgba(250, 245, 255, 0.96) 0%, rgba(236, 254, 255, 0.96) 50%, rgba(255, 240, 245, 0.96) 100%);
            border-color: rgba(165, 180, 252, 0.4);
            color: #374151;
            animation: rainbowCycle 2.4s linear infinite;
            box-shadow: 0 26px 42px rgba(165, 180, 252, 0.28);
            filter: brightness(1);
        }

        .storage-item .name {
            font-weight: 800;
            font-size: 1.32em;
            color: #1e293b;
            word-break: break-word;
        }

        .storage-item .item-description {
            font-size: 0.9em;
            color: #475569;
            font-style: italic;
            margin-top: 4px;
            margin-bottom: 6px;
            line-height: 1.25;
            word-break: break-word;
        }

        .storage-item .probability {
            color: #4c1d95;
            font-size: 0.9em;
            margin-top: 6px;
            font-weight: 700;
        }

        .storage-item .time {
            color: #64748b;
            font-size: 0.85em;
            margin-top: 6px;
        }
        .storage-item .count {
            position: absolute;
            bottom: 14px;
            right: 16px;
            background: rgba(79, 70, 229, 0.12);
            color: #312e81;
            padding: 6px 10px;
            border-radius: 999px;
            font-size: 0.82em;
            font-weight: 700;
            min-width: 24px;
            text-align: center;
            border: 1px solid rgba(99, 102, 241, 0.25);
        }

        .storage-item .sell-button {
            position: absolute;
            top: 14px;
            left: 14px;
            width: 30px;
            height: 30px;
            background: rgba(220, 38, 38, 0.92);
            border: 1px solid rgba(185, 28, 28, 0.65);
            border-radius: 999px;
            color: #fff1f2;
            font-size: 13px;
            cursor: pointer;
            display: none;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s ease, background 0.2s ease, border-color 0.2s ease;
            z-index: 10;
            box-shadow: 0 14px 26px rgba(220, 38, 38, 0.28);
        }

        .storage-item .sell-button:hover {
            background: rgba(185, 28, 28, 0.95);
            border-color: rgba(248, 113, 113, 0.55);
            transform: translateY(-1px) scale(1.05);
        }

        .storage-item:hover .sell-button {
            display: flex;
        }

        .clear-storage {
            background: linear-gradient(120deg, #f87171 0%, #ef4444 100%);
            color: #ffffff;
            border: none;
            padding: 15px 34px;
            border-radius: 999px;
            cursor: pointer;
            margin-top: 28px;
            font-size: 1.05em;
            font-weight: 700;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            box-shadow: 0 18px 32px rgba(239, 68, 68, 0.26);
        }

        .clear-storage:hover {
            transform: translateY(-2px);
            box-shadow: 0 24px 40px rgba(239, 68, 68, 0.3);
        }

        /* Í∞ïÌôî ÌôïÎ•†/ÌååÍ¥¥ ÌôïÎ•† ÌïòÎã® Ï¢åÏ∏° ÌëúÏãú */
        .storage-item .enhance-stats {
            position: absolute;
            bottom: 12px;
            left: 16px;
            background: rgba(15, 23, 42, 0.84);
            color: #e2e8f0;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.78em;
            line-height: 1.2;
            display: none;
            box-shadow: 0 12px 24px rgba(15, 23, 42, 0.28);
        }
         .storage-item:hover .enhance-stats { display: block; }

         /* Í∞ïÌôîÎê® ÎùºÎ≤® Ïä§ÌÉÄÏùº */
         .enhanced-label {
             color: #6c757d;
             font-size: 0.75em;
             font-style: italic;
             margin-top: 2px;
         }

         /* Í∞ïÌôî Îã®Í≥ÑÎ≥Ñ ÎàÑÏ†Å Ìö®Í≥º */
         
         /* 1Í∞ï: Ìö®Í≥º ÏóÜÏùå */
         
        /* 2Í∞ï: ÎßàÏö∞Ïä§ Ïò§Î≤ÑÏãú Í¥ëÌÉù Ìö®Í≥º */
        .storage-item[data-enhance-level="2"]:hover {
             position: relative;
             overflow: hidden;
         }
        .storage-item[data-enhance-level="2"]:hover::after {
             content: '';
             position: absolute;
             top: -50%;
             left: -50%;
             width: 200%;
             height: 200%;
             background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shine 0.8s ease-in-out;
             pointer-events: none;
         }

         /* 3Í∞ï Ïù¥ÏÉÅ: ÎßàÏö∞Ïä§ Ïò§Î≤ÑÏãú Í¥ëÌÉù Ìö®Í≥º */
         .storage-item[data-enhance-level="3"]:hover,
         .storage-item[data-enhance-level="4"]:hover,
         .storage-item[data-enhance-level="5"]:hover {
             position: relative;
             overflow: hidden;
         }
         .storage-item[data-enhance-level="3"]:hover::after,
         .storage-item[data-enhance-level="4"]:hover::after,
         .storage-item[data-enhance-level="5"]:hover::after {
             content: '';
             position: absolute;
             top: -50%;
             left: -50%;
             width: 200%;
             height: 200%;
             background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
             animation: shine 0.8s ease-in-out;
             pointer-events: none;
         }

        /* 3Í∞ï: ÎßàÏö∞Ïä§ Ïò§Î≤ÑÏãú Ï†ÅÎãπÌûà Ïò¨ÎùºÍ∞ê */
        .storage-item[data-enhance-level="3"]:hover,
        .storage-item[data-enhance-level="4"]:hover,
        .storage-item[data-enhance-level="5"]:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }

        /* 4Í∞ï: Í≤ÄÏùÄÏÉâ ÌÖåÎëêÎ¶¨ÏôÄ ÎëêÍ∫ºÏö¥ Í∏ÄÏî® */
        .storage-item[data-enhance-level="4"] {
            border: 3px solid #000000;
            font-weight: bold;
        }
        .storage-item[data-enhance-level="4"] .name {
            font-weight: 900;
        }
        
        /* 4Í∞ï: ÎßàÏö∞Ïä§ Ïò§Î≤ÑÏãú Ï∂îÍ∞Ä Ìö®Í≥º */
        .storage-item[data-enhance-level="4"]:hover,
        .storage-item[data-enhance-level="5"]:hover {
            border: 3px solid #6c757d;
            transform: translateY(-4px);
        }

        /* 5Í∞ï: ÎßàÏö∞Ïä§ Ïò§Î≤ÑÏãú ÌùîÎì§Î¶º Ìö®Í≥º */
        .storage-item[data-enhance-level="5"]:hover {
            animation: maxLevelShake 0.8s ease-in-out infinite alternate;
            z-index: 1;
            position: relative;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            100% { transform: translateX(100%) translateY(100%) rotate(45deg); }
        }

        @keyframes autoShine {
            0% { 
                opacity: 0;
                transform: translateX(-100%) translateY(-100%) rotate(45deg); 
            }
            50% { 
                opacity: 1;
                transform: translateX(0%) translateY(0%) rotate(45deg); 
            }
            100% { 
                opacity: 0;
                transform: translateX(100%) translateY(100%) rotate(45deg); 
            }
        }

        @keyframes maxLevelShake {
            0% {
                transform: translateY(-4px) rotate(-1.5deg);
                box-shadow: 0 6px 18px rgba(0,0,0,0.12);
            }
            100% {
                transform: translateY(-4px) rotate(1.5deg);
                box-shadow: 0 8px 24px rgba(0,0,0,0.18);
            }
        }


         /* Í∞ïÌôîÎêú ÏÑ∏Ìò∏ ÌëúÏãú Ïä§ÌÉÄÏùº */
         .probability-item.enhanced {
             background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
             border-left: 4px solid #f39c12;
         }

         .probability-item.enhanced .participant-name {
             color: #d68910;
             font-weight: bold;
         }

         .enhancement-indicator {
             display: inline-block;
             background: #f39c12;
             color: white;
             padding: 2px 8px;
             border-radius: 12px;
             font-size: 0.75em;
             font-weight: bold;
             margin-left: 8px;
             animation: pulse 2s infinite;
        }

  </style>
</head>
<body>
    <div id="appLayoutRoot">
    <!-- ÏÑ∏Ìò∏ÏΩîÏù∏ & Î≤ÑÌîÑ UI -->
    <div id="coinBuffContainer" class="hud-drawer-item">
        <div class="buff-panel">
                    <div class="buff-panel-header">
                        <span class="buff-panel-title">ÌôúÏÑ± Î≤ÑÌîÑ</span>
        </div>
        <div id="buffContainer">
            <!-- Î≤ÑÌîÑ ÏïÑÏù¥ÏΩòÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>
        </div>
        <div class="coin-stack">
            <div id="coinDisplay">
                <div class="coin-icon">ü™ô</div>
                <div class="coin-text">
                    <span class="coin-label">ÏÑ∏Ìò∏ÏΩîÏù∏</span>
                    <span class="coin-amount" id="coinAmount">0</span>
                </div>
            </div>
            <button id="questButton" onclick="openQuest()" title="ÌÄòÏä§Ìä∏">üìú</button>
        </div>
    </div>

    <!-- ÌÄòÏä§Ìä∏ Ïò§Î≤ÑÎ†àÏù¥ -->
    <div id="questOverlay" class="quest-overlay" onclick="closeQuest()" aria-hidden="true">
        <div class="quest-container" onclick="event.stopPropagation()">
            <div class="quest-header">
                <div class="quest-tabs">
                    <button class="quest-tab-button active" data-tab="daily" onclick="switchQuestTab('daily')">ÏùºÏùº ÌÄòÏä§Ìä∏</button>
                    <button class="quest-tab-button" data-tab="event" onclick="switchQuestTab('event')">Ïù¥Î≤§Ìä∏ ÌÄòÏä§Ìä∏</button>
                </div>
                <button class="quest-close" onclick="closeQuest()" aria-label="Îã´Í∏∞">‚úï</button>
            </div>
            <div class="quest-meta">
                <div><strong>ÌÄòÏä§Ìä∏ Í∞±Ïã†</strong></div>
                <div id="dailyQuestTimer">00:00</div>
            </div>
            <div class="quest-content">
                <div id="dailyQuestContent" class="quest-tab-content active"></div>
                <div id="eventQuestContent" class="quest-tab-content"></div>
            </div>
        </div>
    </div>

    <!-- ÏÑ§Ï†ï Ìå®ÎÑê -->
    <div id="settingsPanel" class="collapsed hud-drawer-item">
        <button type="button" class="settings-toggle" onclick="toggleSettingsPanel()" aria-label="ÏÑ§Ï†ï Ïó¥Í∏∞">‚öôÔ∏è</button>
        <div class="settings-card" onclick="event.stopPropagation()">
            <div class="settings-header">
                <div class="settings-header-main">
                    <div class="settings-title">ÏÑ§Ï†ï</div>
                    <div class="settings-subtitle">ÌîåÎ†àÏù¥ ÌòÑÌô©Í≥º ÌÖåÎßàÎ•º Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî</div>
        </div>
                <button type="button" class="settings-close" onclick="toggleSettingsPanel()" aria-label="ÏÑ§Ï†ï Îã´Í∏∞">‚úï</button>
            </div>
            <div class="settings-stat-grid">
                <div class="settings-stat">
                    <div class="settings-stat-label">Ï¥ù ÎΩëÍ∏∞ ÌöüÏàò</div>
                    <div class="settings-stat-value" id="statTotalDraws">0</div>
                </div>
                <div class="settings-stat">
                    <div class="settings-stat-label">ÌîåÎ†àÏù¥ ÏãúÍ∞Ñ</div>
                    <div class="settings-stat-value" id="statPlaytime">00:00:00</div>
                </div>
            </div>
            <div class="settings-highlight">
                <span class="settings-highlight-label">Í∞ÄÏû• ÎÇÆÏùÄ ÌôïÎ•†Î°ú ÌöçÎìù</span>
                <span class="settings-highlight-value" id="statRarest">-</span>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">ÌÖåÎßà Î≥ÄÍ≤Ω</div>
                <div class="settings-section-content">
            <div class="theme-selector" id="themeSelector">
                <!-- ÌÖåÎßà Î≤ÑÌäºÎì§Ïù¥ Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
                    </div>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">ÌôîÎ©¥ Î™®Îìú</div>
                <div class="settings-section-content device-mode-settings">
                    <div class="settings-device-row">
                        <div class="device-mode-label">PC / Î™®Î∞îÏùº Î≥¥Í∏∞ Ï†ÑÌôò</div>
                        <div class="device-toggle">
                            <input type="checkbox" id="deviceModeToggle" role="switch" aria-checked="false" aria-label="PCÏôÄ Î™®Î∞îÏùº Î≥¥Í∏∞ Ï†ÑÌôò">
                            <div class="device-toggle-track">
                                <span class="device-toggle-option option-desktop">PC</span>
                                <span class="device-toggle-option option-mobile">Î™®Î∞îÏùº</span>
                            </div>
                            <div class="device-toggle-thumb"></div>
                        </div>
                    </div>
                    <div class="device-mode-caption">Ïä¨ÎùºÏù¥ÎçîÍ∞Ä ÌååÎûÄÏÉâÏùº ÎïåÎäî Î™®Î∞îÏùº Î™®ÎìúÏòàÏöî.</div>
                    <div class="device-mode-hint" id="deviceModeHint">ÌòÑÏû¨ ÌôîÎ©¥: ÏûêÎèô Í∞êÏßÄ Ï§ë</div>
                    <button type="button" class="device-mode-reset" id="deviceModeReset" disabled>ÏûêÎèô Í∞êÏßÄ Î≥µÏõê</button>
                </div>
            </div>
            <div class="settings-section">
                <div class="settings-section-title">ÏΩîÎìú ÏÇ¨Ïö©</div>
                <div class="code-input-container">
                    <input type="text" id="codeInput" class="settings-input" placeholder="ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî">
                    <button type="button" class="settings-primary" onclick="redeemCode()">ÏÇ¨Ïö©</button>
                </div>
                <div class="settings-helper">ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÍ≥† Î≥¥ÏÉÅÏùÑ Î∞õÏïÑÎ≥¥ÏÑ∏Ïöî.</div>
            </div>
            <button class="settings-reset" onclick="resetAllData()">Ï¥àÍ∏∞Ìôî</button>
        </div>
    </div>
    <div id="hudDrawerPanel" aria-hidden="true"></div>
    <div class="main-container" id="mainContainer">
        <!-- ÏïÑÏù¥ÌÖú Î≥¥Í¥ÄÏÜå ÌôîÎ©¥ (Îß® ÏôºÏ™Ω) -->
        <div class="screen storage-container item-storage-screen">
            <div class="container">
                <h1>üì¶ ÏïÑÏù¥ÌÖú Î≥¥Í¥ÄÏÜå</h1>
                <p class="storage-subtitle">Î≥¥Í¥Ä Ï§ëÏù∏ ÏïÑÏù¥ÌÖúÏùÑ ÌïúÎààÏóê ÌôïÏù∏ÌïòÍ≥† Í¥ÄÎ¶¨ÌïòÏÑ∏Ïöî.</p>
                <div id="itemStorageContent">
                    <div class="storage-list" id="itemStorageList">
                        <p>ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏäµÎãàÎã§.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÏÉÅÏ†ê ÌôîÎ©¥ -->
        <div class="screen">
            <div class="shop-container">
                <div class="shop-header">
                    <div class="shop-heading">
                <h2>üõí ÏÉÅÏ†ê</h2>
                        <div class="shop-subtitle">ÏùºÏ†ï ÏãúÍ∞ÑÎßàÎã§ Í∞±Ïã†ÎêòÎäî ÌäπÎ≥ÑÌïú ÌåêÎß§ Î™©Î°ùÏûÖÎãàÎã§.</div>
                    </div>
                    <div class="shop-metadata">
                        <div class="shop-timer" id="shopTimer">Í∞±Ïã†ÍπåÏßÄ: 20:00</div>
                    </div>
                </div>
                <div class="shop-probability" id="shopProbability">ÏùºÎ∞ò 45% | Ìù¨Í∑Ä 27.5% | Î†àÏñ¥ 17.5% | ÏòÅÏõÖ 7.5% | Ï†ÑÏÑ§ 2.5%</div>
                <div class="shop-items" id="shopItems">
                    <div class="shop-item">
                        <div class="shop-item-name">???</div>
                        <div class="shop-item-desc">Î¨ºÌíàÏùÑ Ï§ÄÎπÑÏ§ëÏûÖÎãàÎã§...</div>
                        <div class="shop-item-price">??? Í≥®Îìú</div>
                    </div>
                    <div class="shop-item">
                        <div class="shop-item-name">???</div>
                        <div class="shop-item-desc">Î¨ºÌíàÏùÑ Ï§ÄÎπÑÏ§ëÏûÖÎãàÎã§...</div>
                        <div class="shop-item-price">??? Í≥®Îìú</div>
                    </div>
                    <div class="shop-item">
                        <div class="shop-item-name">???</div>
                        <div class="shop-item-desc">Î¨ºÌíàÏùÑ Ï§ÄÎπÑÏ§ëÏûÖÎãàÎã§...</div>
                        <div class="shop-item-price">??? Í≥®Îìú</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÌôïÎ•†Ìëú ÌôîÎ©¥ -->
        <div class="screen">
            <div class="container">
                <h1>üìä ÌôïÎ•†Ìëú</h1>
                <div id="probabilityContent">
                    <p>Ï∞∏Í∞ÄÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>
                </div>
            </div>
        </div>

        <!-- ÎΩëÍ∏∞ ÌôîÎ©¥ (Í∞ÄÏö¥Îç∞) -->
        <div class="screen">
            <div class="container">
                <h1>üé≤ ÏÑ∏Ìò∏ÎΩëÍ∏∞</h1>
                
                <div class="draw-area">
                    <div id="resultDisplay" class="result-display">
                        ÎΩëÍ∏∞Î•º ÏãúÏûëÌï¥Î≥¥ÏÑ∏Ïöî!
                    </div>
                    
                    <button id="drawButton" class="draw-button" onclick="startDraw()">
                        üéØ ÎΩëÍ∏∞ ÏãúÏûë!
                    </button>
                    <div id="trumpCardInfo" style="margin-top: 10px; color: #64748b; font-size: 0.9em; text-align: center; display: none;">
                        <!-- Ìä∏ÎüºÌîÑÏπ¥Îìú Ï†ïÎ≥¥Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                    <div id="goldenStatueInfo" style="margin-top: 6px; color: #875f1a; font-size: 0.88em; text-align: center; display: none;">
                        <!-- Ìô©Í∏àÎèôÏÉÅ Ï†ïÎ≥¥Í∞Ä Ïó¨Í∏∞Ïóê ÌëúÏãúÎê©ÎãàÎã§ -->
                    </div>
                </div>
            </div>
  </div>

        <!-- Î≥¥Í¥ÄÏÜå ÌôîÎ©¥ (Ïò§Î•∏Ï™Ω) -->
        <div class="screen storage-container">
            <div class="container">
                <h1>üì¶ Î≥¥Í¥ÄÏÜå</h1>
                <div id="storageContent">
                    <div class="storage-list" id="storageList">
                        <p>ÎΩëÌûå Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê Ï†ÄÏû•Îê©ÎãàÎã§.</p>
                    </div>
                    <button class="clear-storage" onclick="clearStorage()">
                        üóëÔ∏è Ï†ÑÏ≤¥ ÏÇ≠Ï†ú
                    </button>
                </div>
            </div>
        </div>

        <!-- 4Î≤àÏß∏ ÌôîÎ©¥: üè∫ Ïú†Î¨º ÎΩëÍ∏∞ -->
        <div class="screen">
            <div class="container">
                <h1>üè∫ Ïú†Î¨º ÎΩëÍ∏∞</h1>
                <div class="draw-area">
                    <div class="result-display reset" id="artifactResult">Ïú†Î¨º ÎΩëÍ∏∞Î•º Ï§ÄÎπÑÌï¥Ï£ºÏÑ∏Ïöî!</div>
                    <button class="draw-button" id="artifactDrawButton" onclick="startArtifactDraw()">üè∫ Ïú†Î¨º ÎΩëÍ∏∞</button>
                    <div id="artifactCooldown" style="margin-top: 10px; color: #475569; font-size: 0.9em;"></div>
                    <div style="margin-top: 15px; color: #94a3b8; font-size: 0.82em; text-align: center; line-height: 1.45;">
                        (Ïú†Î¨ºÏùÑ ÎΩëÏùÑ ÌôïÎ•†ÏùÄ 50%Ïù¥Í≥†, Ïú†Î¨ºÎ≥Ñ ÌôïÎ•†ÏùÄ Î™®Îëê Í∑†ÏùºÌï©ÎãàÎã§)
                    </div>
                </div>
            </div>
        </div>

        <!-- 5Î≤àÏß∏ ÌôîÎ©¥: üè∫ Ïú†Î¨º Ïª¨Î†âÏÖò (Í∞ÄÎ°ú ÌöåÏ†Ñ Ï∫êÎü¨ÏÖÄ) -->
        <div class="screen artifact-collection-screen">
            <div class="container">
                <h1>üè∫ Ïú†Î¨º Ïª¨Î†âÏÖò</h1>
                <div id="artifactCarousel" class="artifact-carousel">
                    <div class="artifact-grid" id="artifactGrid"></div>
                </div>
            </div>
        </div>
  </div>

    <!-- ÎÑ§ÎπÑÍ≤åÏù¥ÏÖò ÎèÑÌä∏ -->
    <div class="navigation-dots">
         <div class="dot" id="dot-0" onclick="goToScreen(0)"></div>
         <div class="dot" id="dot-1" onclick="goToScreen(1)"></div>
         <div class="dot" id="dot-2" onclick="goToScreen(2)"></div>
         <div class="dot active" id="dot-3" onclick="goToScreen(3)"></div>
         <div class="dot" id="dot-4" onclick="goToScreen(4)"></div>
         <div class="dot" id="dot-5" onclick="goToScreen(5)"></div>
         <div class="dot" id="dot-6" onclick="goToScreen(6)"></div>
    </div>
    </div>
  <script>
        const TARGET_ASPECT_RATIO = 9 / 16;
        const MOBILE_BREAKPOINT = 960;
        let layoutUpdateFrame = null;

        function detectMobileDevice() {
            const ua = navigator.userAgent || '';
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua) || window.innerWidth <= MOBILE_BREAKPOINT;
        }

        function getPreferredLayoutMode() {
            if (layoutOverride === 'mobile' || layoutOverride === 'desktop') {
                return layoutOverride;
            }
            return detectMobileDevice() ? 'mobile' : 'desktop';
        }

        function isManualLayoutOverride() {
            return layoutOverride === 'mobile' || layoutOverride === 'desktop';
        }

        function applyResponsiveLayout() {
            if (!document.body) return;
            const targetMode = getPreferredLayoutMode();
            const isMobile = targetMode === 'mobile';
            document.body.classList.toggle('is-mobile', isMobile);
            document.body.dataset.deviceMode = targetMode;
            if (!isMobile) {
                document.body.classList.remove('hud-drawer-open');
            }
            const html = document.documentElement;
            if (isMobile) {
                const viewportWidth = window.innerWidth;
                const viewportHeight = window.innerHeight;
                const maxWidth = viewportWidth * 0.9;
                const maxHeight = viewportHeight * 0.9;
                let layoutHeight = Math.min(maxHeight, viewportWidth / TARGET_ASPECT_RATIO);
                let layoutWidth = layoutHeight * TARGET_ASPECT_RATIO;
                if (layoutWidth > maxWidth) {
                    layoutWidth = maxWidth;
                    layoutHeight = layoutWidth / TARGET_ASPECT_RATIO;
                }
                html.style.setProperty('--app-layout-width', `${layoutWidth}px`);
                html.style.setProperty('--app-layout-height', `${layoutHeight}px`);
            } else {
                html.style.removeProperty('--app-layout-width');
                html.style.removeProperty('--app-layout-height');
            }
            updateLayoutToggleUI(targetMode);
        }

        function queueResponsiveLayout() {
            if (layoutUpdateFrame) {
                cancelAnimationFrame(layoutUpdateFrame);
            }
            layoutUpdateFrame = requestAnimationFrame(() => {
                layoutUpdateFrame = null;
                applyResponsiveLayout();
            });
        }

        window.addEventListener('resize', queueResponsiveLayout);
        window.addEventListener('orientationchange', queueResponsiveLayout);

        function updateLayoutToggleUI(targetMode = getPreferredLayoutMode()) {
            const toggle = document.getElementById('deviceModeToggle');
            const hint = document.getElementById('deviceModeHint');
            const resetButton = document.getElementById('deviceModeReset');
            const isMobile = targetMode === 'mobile';

            if (toggle) {
                if (toggle.checked !== isMobile) {
                    toggle.checked = isMobile;
                }
                toggle.setAttribute('aria-checked', isMobile ? 'true' : 'false');
            }

            if (hint) {
                const modeText = isMobile ? 'Î™®Î∞îÏùº Î™®Îìú' : 'PC Î™®Îìú';
                hint.textContent = isManualLayoutOverride()
                    ? `ÌòÑÏû¨ ÌôîÎ©¥: ${modeText}`
                    : `ÌòÑÏû¨ ÌôîÎ©¥: ${modeText} (ÏûêÎèô Í∞êÏßÄ)`;
            }

            if (resetButton) {
                resetButton.disabled = !isManualLayoutOverride();
            }
        }

        function bindLayoutToggle() {
            const toggle = document.getElementById('deviceModeToggle');
            const resetButton = document.getElementById('deviceModeReset');

            if (toggle) {
                toggle.addEventListener('change', () => {
                    layoutOverride = toggle.checked ? 'mobile' : 'desktop';
                    updateLayoutToggleUI(layoutOverride);
                    queueResponsiveLayout();
                    saveState();
                });
            }

            if (resetButton) {
                resetButton.addEventListener('click', () => {
                    layoutOverride = null;
                    updateLayoutToggleUI();
                    queueResponsiveLayout();
                    saveState();
                });
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            bindLayoutToggle();
            updateLayoutToggleUI();
            applyResponsiveLayout();
            const hudPanel = document.getElementById('hudDrawerPanel');
            if (hudPanel) {
                hudPanel.addEventListener('click', () => {
                    document.body.classList.remove('hud-drawer-open');
                });
            }
        });

        // ÏÜåÏàò ÌëúÏãú Ìè¨Îß∑ÌÑ∞: Ïú†ÌïúÏÜåÏàòÎäî ÎÅùÏûêÎ¶¨ÍπåÏßÄ, Î¨¥ÌïúÏÜåÏàòÎäî ÏÜåÏàò 3ÏûêÎ¶¨ + '...'
        function formatFiniteOrEllipsis(value, maxCheckDecimals = 12) {
            const num = Number(value);
            if (!isFinite(num)) return String(value);
            const abs = Math.abs(num);
            if (Math.abs(abs - Math.round(abs)) < 1e-12) return String(Math.round(num));
            for (let k = 0; k <= maxCheckDecimals; k++) {
                const scaled = num * Math.pow(10, k);
                if (Math.abs(scaled - Math.round(scaled)) < 1e-9) {
                    const fixed = num.toFixed(k);
                    return fixed.replace(/\.?0+$/, '');
                }
            }
            return num.toFixed(3) + '...';
        }

        function formatDiffLabel(raw) {
            if (raw == null) return '+0%';
            let str = String(raw).trim();
            if (!str) return '+0%';

            if (str.endsWith('%')) {
                str = str.slice(0, -1).trim();
            }

            const addSign = (base) => {
                if (base.startsWith('+') || base.startsWith('-')) return base;
                if (base === '0' || base === '0.0' || base === '0.00' || base === '0...') return '+0';
                return '+' + base;
            };

            if (str.includes('...')) {
                return `${str.startsWith('-') ? '' : '+'}${str}%`;
            }

            const num = Number(str);
            if (Number.isFinite(num)) {
                if (Math.abs(num) < 1e-9) return '+0%';
                const formatted = str.replace(/^[-+]?/, (sign) => (sign === '-' ? '-' : ''));
                const withSign = num > 0 ? addSign(formatted) : formatted;
                return `${withSign}%`;
            }

            return `${addSign(str)}%`;
        }

        // ÌôïÎ•†Ìëú: Ìï≠Î™© ÌÅ¥Î¶≠ÏúºÎ°ú ÌååÏÉù ÌôïÎ•† ÌÜ†Í∏Ä Ï†ÑÌôò
        function attachProbabilityToggle(hostId) {
            const host = document.getElementById(hostId);
            if (!host) return;

            host.querySelectorAll('.probability-item').forEach(item => {
                const detail = item.querySelector('.shining-info');
                if (!detail) return;

                item.classList.remove('no-hover');
                item.classList.remove('expanded');

                detail.style.maxHeight = '0px';
                detail.style.opacity = '0';
                detail.style.marginTop = '0';
                detail.style.padding = '0 18px';
                detail.style.pointerEvents = 'none';

                if (item.dataset.toggleInit === 'true') {
                    return;
                }

                item.dataset.toggleInit = 'true';

                item.addEventListener('click', (evt) => {
                    if (item.classList.contains('no-hover')) return;
                    evt.preventDefault();
                    evt.stopPropagation();

                    const willExpand = !item.classList.contains('expanded');

                    const host = item.closest('.probability-panel');
                    if (host) {
                        host.querySelectorAll('.probability-item.expanded').forEach(openItem => {
                            if (openItem === item) return;
                            const openDetail = openItem.querySelector('.shining-info');
                            openItem.classList.remove('expanded');
                            if (openDetail) {
                                openDetail.style.pointerEvents = 'none';
                                openDetail.style.opacity = '0';
                                openDetail.style.marginTop = '0';
                                openDetail.style.padding = '0 18px';
                                openDetail.style.maxHeight = '0px';
                            }
                        });
                    }

                    if (willExpand) {
                        item.classList.add('expanded');
                        detail.style.pointerEvents = 'auto';
                        detail.style.opacity = '1';
                        detail.style.marginTop = '16px';
                        detail.style.padding = '16px 18px';
                        detail.style.maxHeight = detail.scrollHeight + 'px';
                    } else {
                        item.classList.remove('expanded');
                        detail.style.pointerEvents = 'none';
                        detail.style.opacity = '0';
                        detail.style.marginTop = '0';
                        detail.style.padding = '0 18px';
                        detail.style.maxHeight = '0px';
                    }
                });

                detail.addEventListener('click', (evt) => {
                    evt.stopPropagation();
                });
            });

            if (!window.__probabilityResizeBound) {
                window.addEventListener('resize', () => {
                    document.querySelectorAll('.probability-item.expanded .shining-info').forEach(detail => {
                        detail.style.maxHeight = detail.scrollHeight + 'px';
                    });
                });
                window.__probabilityResizeBound = true;
            }
        }

        // Ï∞∏Í∞ÄÏûê Î™©Î°ùÍ≥º ÌôïÎ•† ÏÑ§Ï†ï (ÏÑ∏Ìò∏ÎΩëÍ∏∞ ÌôïÎ•†: ÍΩù 70%, 10Î™ÖÏùò ÏÑ∏Ìò∏ Í∞ÅÍ∞Å 3%)
        let participants = [
            { name: "ÍΩù", weight: 70 },
            { name: "ÏÑ∏Ìò∏Î°úÎ¶¨", weight: 3 },
            { name: "ÏÑ∏Ìò∏Í≤åÏù¥", weight: 3 },
            { name: "ÏÑ∏Ìò∏ÌçºÎ¶¨", weight: 3 },
            { name: "ÏîπÎçïÏÑ∏Ìò∏", weight: 3 },
            { name: "ÎßàÏ£†Ïù¥Ïä§Ìä∏ ÏÑ∏Ìò∏", weight: 3 },
            { name: "ÌèâÎ≤îÌïú ÏÑ∏Ìò∏", weight: 3 },
            { name: "TSÏÑ∏Ìò∏", weight: 3 },
            { name: "ÏáºÌÉÄÏÑ∏Ìò∏", weight: 3 },
            { name: "ÏóêÍ≤êÏÑ∏Ìò∏", weight: 3 },
            { name: "ÎãàÍ±∞ÏÑ∏Ìò∏", weight: 3 }
        ];
        // ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò 7Î™©Í±∏Ïù¥ Í∏∞Î∞ò Ïú†Ìö® ÌôïÎ•†(Í∞ÄÏ§ëÏπò) Í≥ÑÏÇ∞: Î†àÎ≤®Îãπ ÍΩù 8% Í∞êÏÜå
        function getEffectiveParticipants() {
            const necklace = artifactStorage.find(item => item.name === 'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò 7Î™©Í±∏Ïù¥');
            const level = necklace ? necklace.level : 0;
            let adjusted = participants.map(p => ({ ...p }));
            
            // ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò 7Î™©Í±∏Ïù¥ Ìö®Í≥º Ï†ÅÏö© - Î†àÎ≤®Îãπ 8%p Ï†àÎåÄÍ∞í Í∞êÏÜåÌïòÍ≥† Ï§ÑÏñ¥Îì† ÎßåÌÅºÏùÑ ÏÑ∏Ìò∏ÏóêÍ≤å Î∂ÑÎ∞∞
            if (level) {
            const miss = adjusted.find(p => p.name === 'ÍΩù');
                if (miss) {
                    const totalWeight = adjusted.reduce((sum, p) => sum + p.weight, 0);
                    const reductionPercent = 3 * level; // Î†àÎ≤®Îãπ 3%p (Ï†àÎåÄÍ∞í)
                    const reducedWeight = totalWeight * (reductionPercent / 100); // Ï†ÑÏ≤¥ Í∞ÄÏ§ëÏπòÏùò 8%
                    miss.weight = Math.max(0, miss.weight - reducedWeight);
                    // Ï§ÑÏñ¥Îì† ÌôïÎ•†ÏùÑ Î™®Îì† ÏÑ∏Ìò∏ÏóêÍ≤å Í∑†Îì± Î∂ÑÎ∞∞
                    const sehos = adjusted.filter(p => p.name !== 'ÍΩù');
                    const perSeho = reducedWeight / sehos.length;
                    sehos.forEach(p => p.weight += perSeho);
                }
            }
            
            // ÏÉ§Ïò§ÎØ∏Ìè∞ Ìö®Í≥º Ï†ÅÏö© - ÍΩù ÌôïÎ•† 8% Í∞êÏÜå
            const xiaomiBuff = activeBuffs.find(b => b.type === 'xiaomi_phone' && b.endTime > Date.now());
            if (xiaomiBuff) {
                const miss = adjusted.find(p => p.name === 'ÍΩù');
                if (miss) {
                    const totalWeight = adjusted.reduce((sum, p) => sum + p.weight, 0);
                    const reducedWeight = totalWeight * 0.08; // 8% Í∞êÏÜå
                    miss.weight = Math.max(0, miss.weight - reducedWeight);
                    
                    // Ï§ÑÏñ¥Îì† ÌôïÎ•†ÏùÑ Î™®Îì† ÏÑ∏Ìò∏ÏóêÍ≤å Í∑†Îì± Î∂ÑÎ∞∞
                    const sehos = adjusted.filter(p => p.name !== 'ÍΩù');
                    const perSeho = reducedWeight / sehos.length;
                    sehos.forEach(p => p.weight += perSeho);
                }
            }
            
            // ÌñâÏö¥ Ìè¨ÏÖò Ìö®Í≥º Ï†ÅÏö© - Ï†àÎåÄÍ∞íÏúºÎ°ú Ï§ÑÏù¥Í≥† Î∂ÑÎ∞∞
            const luckBuff = activeBuffs.find(b => b.type === 'luck' && b.endTime > Date.now());
            if (luckBuff) {
                const reductionPercent = [5, 10, 20][luckBuff.level - 1]; // 5%p, 10%p, 20%p
                const miss = adjusted.find(p => p.name === 'ÍΩù');
                if (miss) {
                    const totalWeight = adjusted.reduce((sum, p) => sum + p.weight, 0);
                    const reducedWeight = totalWeight * (reductionPercent / 100); // Ï†ÑÏ≤¥ Í∞ÄÏ§ëÏπòÏùò x%
                    miss.weight = Math.max(0, miss.weight - reducedWeight);
                    // Ï§ÑÏñ¥Îì† ÌôïÎ•†ÏùÑ Î™®Îì† ÏÑ∏Ìò∏ÏóêÍ≤å Í∑†Îì± Î∂ÑÎ∞∞
                    const sehos = adjusted.filter(p => p.name !== 'ÍΩù');
                    const perSeho = reducedWeight / sehos.length;
                    sehos.forEach(p => p.weight += perSeho);
                }
            }
            
            // Ìä∏ÎüºÌîÑÏπ¥Îìú Ìö®Í≥º Ï†ÅÏö©: ÍΩù Ï†úÏô∏
            if (shouldGuaranteeSpecialEffect()) {
                adjusted = adjusted.filter(p => p.name !== 'ÍΩù');
            }
            
            // Ïö©ÏÇ¨Ïùò Ïã¨Ìåê Ìö®Í≥º Ï†ÅÏö©
            if (specialItemCount > 0) {
                // ÍΩù Ï†úÍ±∞
                adjusted = adjusted.filter(p => p.name !== 'ÍΩù');
                
                // Î™®Îì† ÌäπÎ≥ÑÌö®Í≥º ÌôïÎ•†ÏùÑ 20%Î°ú ÏÑ§Ï†ï
                const specialEffects = adjusted.filter(p => 
                    p.name.includes('Î¨¥ÏßÄÍ∞ØÎπõ') || 
                    p.name.includes('Îã§Ïù¥ÏïÑÎ™¨ÎìúÏÉâ') || 
                    p.name.includes('Ìô©Í∏àÏÉâ') || 
                    p.name.includes('Î≤àÏ©çÏù¥Îäî') || 
                    p.name.includes('ÎπõÎÇòÎäî')
                );
                
                if (specialEffects.length > 0) {
                    // ÌäπÎ≥ÑÌö®Í≥ºÎì§Ïùò Í∞ÄÏ§ëÏπòÎ•º 20%Î°ú ÌÜµÏùº
                    const specialWeight = 20;
                    specialEffects.forEach(p => p.weight = specialWeight);
                    
                    // ÎÇòÎ®∏ÏßÄ ÌôïÎ•†ÏùÑ ÏùºÎ∞ò ÏÑ∏Ìò∏Îì§ÏóêÍ≤å Î∂ÑÎ∞∞
                    const normalSehos = adjusted.filter(p => !specialEffects.includes(p));
                    const remainingWeight = 100 - (specialEffects.length * specialWeight);
                    const normalWeight = remainingWeight / normalSehos.length;
                    normalSehos.forEach(p => p.weight = normalWeight);
                }
            }
            
            return adjusted;
        }
        let isDrawing = false;
        let currentScreen = 3; // 0: ÏïÑÏù¥ÌÖú Î≥¥Í¥ÄÏÜå, 1: ÏÉÅÏ†ê, 2: ÌôïÎ•†Ìëú, 3: ÎΩëÍ∏∞, 4: ÏÑ∏Ìò∏ Î≥¥Í¥ÄÏÜå, 5: Ïú†Î¨º ÎΩëÍ∏∞, 6: Ïú†Î¨º Ïª¨Î†âÏÖò
        
        // ÏÑ∏Ìò∏ÏΩîÏù∏ & Î≤ÑÌîÑ Í¥ÄÎ†® Î≥ÄÏàò
        let sehoCoin = 0; // Ï¥àÍ∏∞ ÏÑ∏Ìò∏ÏΩîÏù∏
        let activeBuffs = []; // ÌôúÏÑ± Î≤ÑÌîÑ Î™©Î°ù { type, level, endTime }
        let nextBuffId = 1; // Î≤ÑÌîÑ Í≥†Ïú† ID ÏãúÌÄÄÏä§
        const buffFlipStates = {}; // Î≤ÑÌîÑ Ïπ¥Îìú ÌîåÎ¶Ω ÏÉÅÌÉú
        let purchasedThemes = []; // Íµ¨Îß§Ìïú ÌÖåÎßà Î™©Î°ù
         let currentTheme = 'default'; // ÌòÑÏû¨ ÌÖåÎßà
         let specialItemCount = 0; // Ïö©ÏÇ¨Ïùò Ïã¨Ìåê Í∞úÏàò
         let noCooldownCount = 0; // Ï£ºÎßê Ìö®Í≥º Ïπ¥Ïö¥ÌÑ∞
         let nameChangedItems = []; // Ïù¥Î¶ÑÏù¥ Î∞îÎÄê ÏïÑÏù¥ÌÖúÎì§ (Î≥ÄÌôòÍ∏∞ Ìö®Í≥º)
         let nameChangeTimer = null; // Ïù¥Î¶Ñ Î≥ÄÍ≤Ω Ìö®Í≥º ÌÉÄÏù¥Î®∏
        let layoutOverride = null; // 'mobile' | 'desktop' | null(ÏûêÎèô)

        function getWeekendBuff() {
            return activeBuffs.find(buff => buff.type === 'weekend');
        }

        function getArtifactLevel(artifactName) {
            if (!artifactName) return 0;
            const artifact = artifactStorage.find(item => item.name === artifactName);
            const level = artifact ? artifact.level || 0 : 0;
            return Math.max(0, Math.min(5, level));
        }

        function syncWeekendBuffState() {
            const weekendBuff = getWeekendBuff();
            if (weekendBuff) {
                ensureBuffId(weekendBuff);
                weekendBuff.remainingDraws = noCooldownCount;
                if (noCooldownCount <= 0) {
                    activeBuffs = activeBuffs.filter(buff => buff.type !== 'weekend');
                }
            } else if (noCooldownCount > 0) {
                // recreate buff if count persists but buff missing (data healed)
                const recreated = {
                    type: 'weekend',
                    endTime: Date.now() + (365 * 24 * 60 * 60 * 1000),
                    level: 1,
                    remainingDraws: noCooldownCount
                };
                ensureBuffId(recreated);
                activeBuffs.push(recreated);
            }
        }

        function ensureBuffId(buff) {
            if (!buff || typeof buff !== 'object') return null;
            if (typeof buff.id === 'string') {
                const match = buff.id.match(/^buff-(\d+)$/);
                if (match) {
                    const num = parseInt(match[1], 10);
                    if (!isNaN(num) && num >= nextBuffId) {
                        nextBuffId = num + 1;
                    }
                }
                return buff.id;
            }
            const newId = `buff-${nextBuffId++}`;
            buff.id = newId;
            return newId;
        }

        function generateSpeedBoostReduction() {
            return 0.15 + Math.random() * 0.35; // 15% ~ 50%
        }

        function ensureSpeedBoostReduction(buff) {
            if (!buff || buff.type !== 'speed_boost') return null;
            if (typeof buff.reduction !== 'number' || !isFinite(buff.reduction)) {
                buff.reduction = generateSpeedBoostReduction();
            }
            return buff.reduction;
        }

        function initializeBuffIds() {
            let changed = false;
            activeBuffs.forEach(buff => {
                const prevId = buff.id;
                const currentId = ensureBuffId(buff);
                if (!prevId && currentId) {
                    changed = true;
                }
                if (buff.type === 'speed_boost') {
                    const prevReduction = buff.reduction;
                    const ensured = ensureSpeedBoostReduction(buff);
                    if (ensured !== prevReduction) {
                        changed = true;
                    }
                }
            });
            cleanupBuffFlipStates();
            return changed;
        }

        function cleanupBuffFlipStates() {
            const activeIds = new Set(
                activeBuffs
                    .map(buff => ensureBuffId(buff))
                    .filter(Boolean)
            );
            Object.keys(buffFlipStates).forEach(id => {
                if (!activeIds.has(id)) {
                    delete buffFlipStates[id];
                }
            });
        }

        function resetBuffFlipStates() {
            Object.keys(buffFlipStates).forEach(id => delete buffFlipStates[id]);
            nextBuffId = 1;
        }

        function consumeWeekendCharge() {
            if (noCooldownCount <= 0) return false;
            noCooldownCount = Math.max(0, noCooldownCount - 1);
            syncWeekendBuffState();
            updateBuffDisplay();
            return true;
        }
        // ÌÄòÏä§Ìä∏ Í¥ÄÎ†® ÏÉÅÏàò Î∞è ÏÉÅÌÉú
        const QUEST_RESET_INTERVAL = 24 * 60 * 60 * 1000; // 24ÏãúÍ∞Ñ
        const DAILY_QUEST_POOL = [
            // ÎΩëÍ∏∞ ÌöüÏàò ÌÄòÏä§Ìä∏
            { key: 'draw_100', type: 'draw', target: 100, title: '100Ìöå ÎΩëÍ∏∞', description: 'ÏÑ∏Ìò∏ ÎΩëÍ∏∞Î•º 100Ìöå ÏßÑÌñâÌïòÏÑ∏Ïöî.', rewards: [
                { type: 'coin', amount: 100, label: 'ÏÑ∏Ìò∏ÏΩîÏù∏ 100Í∞ú' },
                { type: 'item', item: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö†', quantity: 8, label: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö† 8Í∞ú' },
                { type: 'item', item: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö†', quantity: 8, label: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö† 8Í∞ú' }
            ] },
            { key: 'draw_125', type: 'draw', target: 125, title: '125Ìöå ÎΩëÍ∏∞', description: 'ÏÑ∏Ìò∏ ÎΩëÍ∏∞Î•º 125Ìöå ÏßÑÌñâÌïòÏÑ∏Ïöî.', rewards: [
                { type: 'coin', amount: 125, label: 'ÏÑ∏Ìò∏ÏΩîÏù∏ 125Í∞ú' },
                { type: 'item', item: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö†', quantity: 10, label: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö† 10Í∞ú' },
                { type: 'item', item: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö†', quantity: 10, label: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö† 10Í∞ú' }
            ] },
            { key: 'draw_150', type: 'draw', target: 150, title: '150Ìöå ÎΩëÍ∏∞', description: 'ÏÑ∏Ìò∏ ÎΩëÍ∏∞Î•º 150Ìöå ÏßÑÌñâÌïòÏÑ∏Ïöî.', rewards: [
                { type: 'coin', amount: 150, label: 'ÏÑ∏Ìò∏ÏΩîÏù∏ 150Í∞ú' },
                { type: 'item', item: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö†', quantity: 12, label: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö† 12Í∞ú' },
                { type: 'item', item: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö†', quantity: 12, label: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö† 12Í∞ú' }
            ] },
            { key: 'draw_200', type: 'draw', target: 200, title: '200Ìöå ÎΩëÍ∏∞', description: 'ÏÑ∏Ìò∏ ÎΩëÍ∏∞Î•º 200Ìöå ÏßÑÌñâÌïòÏÑ∏Ïöî.', rewards: [
                { type: 'coin', amount: 200, label: 'ÏÑ∏Ìò∏ÏΩîÏù∏ 200Í∞ú' },
                { type: 'item', item: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö†', quantity: 14, label: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö† 14Í∞ú' },
                { type: 'item', item: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö†', quantity: 14, label: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö† 14Í∞ú' }
            ] },
            { key: 'draw_225', type: 'draw', target: 225, title: '225Ìöå ÎΩëÍ∏∞', description: 'ÏÑ∏Ìò∏ ÎΩëÍ∏∞Î•º 225Ìöå ÏßÑÌñâÌïòÏÑ∏Ïöî.', rewards: [
                { type: 'coin', amount: 225, label: 'ÏÑ∏Ìò∏ÏΩîÏù∏ 225Í∞ú' },
                { type: 'item', item: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö°', quantity: 6, label: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö° 6Í∞ú' },
                { type: 'item', item: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö°', quantity: 6, label: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö° 6Í∞ú' }
            ] },
            { key: 'draw_250', type: 'draw', target: 250, title: '250Ìöå ÎΩëÍ∏∞', description: 'ÏÑ∏Ìò∏ ÎΩëÍ∏∞Î•º 250Ìöå ÏßÑÌñâÌïòÏÑ∏Ïöî.', rewards: [
                { type: 'coin', amount: 250, label: 'ÏÑ∏Ìò∏ÏΩîÏù∏ 250Í∞ú' },
                { type: 'item', item: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö°', quantity: 7, label: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö° 7Í∞ú' },
                { type: 'item', item: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö°', quantity: 7, label: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö° 7Í∞ú' }
            ] },
            { key: 'draw_275', type: 'draw', target: 275, title: '275Ìöå ÎΩëÍ∏∞', description: 'ÏÑ∏Ìò∏ ÎΩëÍ∏∞Î•º 275Ìöå ÏßÑÌñâÌïòÏÑ∏Ïöî.', rewards: [
                { type: 'coin', amount: 275, label: 'ÏÑ∏Ìò∏ÏΩîÏù∏ 275Í∞ú' },
                { type: 'item', item: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö°', quantity: 8, label: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö° 8Í∞ú' },
                { type: 'item', item: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö°', quantity: 8, label: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö° 8Í∞ú' }
            ] },
            { key: 'draw_300', type: 'draw', target: 300, title: '300Ìöå ÎΩëÍ∏∞', description: 'ÏÑ∏Ìò∏ ÎΩëÍ∏∞Î•º 300Ìöå ÏßÑÌñâÌïòÏÑ∏Ïöî.', rewards: [
                { type: 'coin', amount: 300, label: 'ÏÑ∏Ìò∏ÏΩîÏù∏ 300Í∞ú' },
                { type: 'item', item: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö°', quantity: 9, label: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö° 9Í∞ú' },
                { type: 'item', item: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö°', quantity: 9, label: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö° 9Í∞ú' }
            ] },
            // ÌäπÎ≥ÑÌö®Í≥º ÌÄòÏä§Ìä∏
            { key: 'effect_golden', type: 'golden_effect', target: 1, title: 'Ìô©Í∏àÏÉâ ÏÑ∏Ìò∏ ÎΩëÍ∏∞', description: 'Ìô©Í∏àÏÉâ ÌäπÎ≥ÑÌö®Í≥º ÏÑ∏Ìò∏Î•º 1Ìöå ÎΩëÏúºÏÑ∏Ïöî.', rewards: [
                { type: 'coin', amount: 200, label: 'ÏÑ∏Ìò∏ÏΩîÏù∏ 200Í∞ú' },
                { type: 'item', item: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö†', quantity: 15, label: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö† 15Í∞ú' },
                { type: 'item', item: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö†', quantity: 15, label: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö† 15Í∞ú' }
            ] },
            { key: 'effect_diamond', type: 'diamond_effect', target: 1, title: 'Îã§Ïù¥ÏïÑÎ™¨ÎìúÏÉâ ÏÑ∏Ìò∏ ÎΩëÍ∏∞', description: 'Îã§Ïù¥ÏïÑÎ™¨ÎìúÏÉâ ÌäπÎ≥ÑÌö®Í≥º ÏÑ∏Ìò∏Î•º 1Ìöå ÎΩëÏúºÏÑ∏Ïöî.', rewards: [
                { type: 'coin', amount: 750, label: 'ÏÑ∏Ìò∏ÏΩîÏù∏ 750Í∞ú' },
                { type: 'item', item: '1339Ìè¨ÏÖò', quantity: 3, label: '1339Ìè¨ÏÖò 3Í∞ú' },
                { type: 'item', item: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö¢', quantity: 6, label: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö¢ 6Í∞ú' },
                { type: 'item', item: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö¢', quantity: 6, label: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö¢ 6Í∞ú' }
            ] },
            // ÏÉÅÏ†ê Íµ¨Îß§ ÌÄòÏä§Ìä∏
            { key: 'shop_buy_3', type: 'shop_purchase', target: 3, title: 'ÏÉÅÏ†ê Î¨ºÌíà 3Ìöå Íµ¨Îß§', description: 'ÏÉÅÏ†êÏóêÏÑú Î¨ºÌíàÏùÑ 3Ìöå Íµ¨Îß§ÌïòÏÑ∏Ïöî.', rewards: [
                { type: 'coin', amount: 100, label: 'ÏÑ∏Ìò∏ÏΩîÏù∏ 100Í∞ú' }
            ] },
            { key: 'shop_buy_5', type: 'shop_purchase', target: 5, title: 'ÏÉÅÏ†ê Î¨ºÌíà 5Ìöå Íµ¨Îß§', description: 'ÏÉÅÏ†êÏóêÏÑú Î¨ºÌíàÏùÑ 5Ìöå Íµ¨Îß§ÌïòÏÑ∏Ïöî.', rewards: [
                { type: 'coin', amount: 150, label: 'ÏÑ∏Ìò∏ÏΩîÏù∏ 150Í∞ú' }
            ] },
            { key: 'shop_buy_7', type: 'shop_purchase', target: 7, title: 'ÏÉÅÏ†ê Î¨ºÌíà 7Ìöå Íµ¨Îß§', description: 'ÏÉÅÏ†êÏóêÏÑú Î¨ºÌíàÏùÑ 7Ìöå Íµ¨Îß§ÌïòÏÑ∏Ïöî.', rewards: [
                { type: 'coin', amount: 200, label: 'ÏÑ∏Ìò∏ÏΩîÏù∏ 200Í∞ú' }
            ] },
            // ÌîåÎ†àÏù¥ÌÉÄÏûÑ ÌÄòÏä§Ìä∏
            { key: 'playtime_20', type: 'playtime', target: 20, title: '20Î∂Ñ ÌîåÎ†àÏù¥ÌïòÍ∏∞', description: 'Ï¥ù 20Î∂Ñ ÎèôÏïà Í≤åÏûÑÏùÑ ÌîåÎ†àÏù¥ÌïòÏÑ∏Ïöî.', rewards: [
                { type: 'item', item: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö†', quantity: 10, label: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö† 10Í∞ú' },
                { type: 'item', item: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö†', quantity: 10, label: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö† 10Í∞ú' }
            ] },
            { key: 'playtime_30', type: 'playtime', target: 30, title: '30Î∂Ñ ÌîåÎ†àÏù¥ÌïòÍ∏∞', description: 'Ï¥ù 30Î∂Ñ ÎèôÏïà Í≤åÏûÑÏùÑ ÌîåÎ†àÏù¥ÌïòÏÑ∏Ïöî.', rewards: [
                { type: 'item', item: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö†', quantity: 15, label: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö† 15Í∞ú' },
                { type: 'item', item: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö†', quantity: 15, label: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö† 15Í∞ú' }
            ] },
            { key: 'playtime_45', type: 'playtime', target: 45, title: '45Î∂Ñ ÌîåÎ†àÏù¥ÌïòÍ∏∞', description: 'Ï¥ù 45Î∂Ñ ÎèôÏïà Í≤åÏûÑÏùÑ ÌîåÎ†àÏù¥ÌïòÏÑ∏Ïöî.', rewards: [
                { type: 'item', item: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö†', quantity: 22, label: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö† 22Í∞ú' },
                { type: 'item', item: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö†', quantity: 22, label: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö† 22Í∞ú' }
            ] },
            { key: 'playtime_60', type: 'playtime', target: 60, title: '1ÏãúÍ∞Ñ ÌîåÎ†àÏù¥ÌïòÍ∏∞', description: 'Ï¥ù 1ÏãúÍ∞Ñ ÎèôÏïà Í≤åÏûÑÏùÑ ÌîåÎ†àÏù¥ÌïòÏÑ∏Ïöî.', rewards: [
                { type: 'item', item: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö°', quantity: 8, label: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö° 8Í∞ú' },
                { type: 'item', item: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö°', quantity: 8, label: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö° 8Í∞ú' }
            ] }
        ];

        const ARTIFACT_NAMES = [
            'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Î∂ÄÏ†Å', 'ÏÑ∏Ìò∏ÌçºÎ¶¨Ïùò Î∂ÄÏ†Å', 'ÏÑ∏Ìò∏Í≤åÏù¥Ïùò Î∂ÄÏ†Å',
            'ÎßàÏ£†Ïù¥Ïä§Ìä∏ÏÑ∏Ìò∏Ïùò Î∂ÄÏ†Å', 'ÏîπÎçïÏÑ∏Ìò∏Ïùò Î∂ÄÏ†Å', 'TSÏÑ∏Ìò∏Ïùò Î∂ÄÏ†Å',
            'ÏáºÌÉÄÏÑ∏Ìò∏Ïùò Î∂ÄÏ†Å', 'ÏóêÍ≤êÏÑ∏Ìò∏Ïùò Î∂ÄÏ†Å', 'ÎãàÍ±∞ÏÑ∏Ìò∏Ïùò Î∂ÄÏ†Å',
            'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò ÏãúÍ∞ÑÍ∞ÄÏÜçÍ∏∞', 'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò 7Î™©Í±∏Ïù¥',
            'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ïú†Î¨ºÏÑù', 'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Î¨¥ÏßÄÍ∞ØÎπõ Î≥¥ÏÑù',
            'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ïã†ÏÑ±Ìïú ÎßùÏπò', 'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ìä∏ÎüºÌîÑÏπ¥Îìú',
            'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ìô©Í∏àÎèôÏÉÅ', 'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Î¥áÏßê', 'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Î¨ºÏïΩ Ï†úÏ°∞Ïà†Ï±Ö'
        ];

        function generateQuestId(prefix = 'quest') {
            if (typeof crypto !== 'undefined' && typeof crypto.randomUUID === 'function') {
                return `${prefix}_${crypto.randomUUID()}`;
            }
            const random = Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
            return `${prefix}_${Date.now()}_${random}`;
        }

        function randomizeQuestReward(rewardOptions) {
            if (!Array.isArray(rewardOptions) || rewardOptions.length === 0) {
                return { type: 'coin', amount: 50, label: 'ÏÑ∏Ìò∏ÏΩîÏù∏ 50Í∞ú' };
            }
            const index = Math.floor(Math.random() * rewardOptions.length);
            const chosen = rewardOptions[index] || {};
            const type = chosen.type || 'coin';
            const amount = typeof chosen.amount === 'number' ? chosen.amount : 0;
            const item = chosen.item || null;
            const quantity = typeof chosen.quantity === 'number' ? chosen.quantity : 0;
            const label = chosen.label ||
                (type === 'coin'
                    ? `ÏÑ∏Ìò∏ÏΩîÏù∏ ${amount}Í∞ú`
                    : `${item || 'ÏïÑÏù¥ÌÖú'} ${quantity}Í∞ú`);
            return { type, amount, item, quantity, label };
        }

        function createDailyQuestFromDefinition(definition) {
            const rewards = Array.isArray(definition.rewards) ? definition.rewards : [];
            const selectedReward = randomizeQuestReward(rewards);
            return {
                id: generateQuestId('daily'),
                key: definition.key,
                type: definition.type,
                title: definition.title,
                description: definition.description,
                rewards,
                selectedReward,
                reward: selectedReward.label,
                progress: {
                    current: 0,
                    target: definition.target
                },
                completed: false
            };
        }

        function sampleDailyQuestDefinitions(count) {
            const shuffled = Array.from(DAILY_QUEST_POOL);
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled.slice(0, Math.min(count, shuffled.length));
        }

        function createArtifactCardElement(artifactName) {
            const card = document.createElement('div');
            card.className = 'artifact-card locked';
            card.dataset.artifactName = artifactName;

            card.addEventListener('click', () => {
                if (card.classList.contains('locked')) return;
                card.classList.toggle('flipped');
            });

            const front = document.createElement('div');
            front.className = 'artifact-front';

            const levelBadge = document.createElement('div');
            levelBadge.className = 'artifact-level-badge';
            levelBadge.textContent = 'Lv. 0';

            const bodyWrap = document.createElement('div');
            bodyWrap.className = 'artifact-front-body';

            const nameEl = document.createElement('div');
            nameEl.className = 'artifact-name';
            nameEl.textContent = artifactName;
            bodyWrap.appendChild(nameEl);

            const statusEl = document.createElement('div');
            statusEl.className = 'artifact-status';
            statusEl.setAttribute('data-status', 'locked');
            statusEl.textContent = 'ÎØ∏ÌöçÎìù';

            front.appendChild(levelBadge);
            front.appendChild(bodyWrap);
            front.appendChild(statusEl);

            const back = document.createElement('div');
            back.className = 'artifact-back';

            const backHeading = document.createElement('div');
            backHeading.className = 'artifact-back-heading';
            backHeading.textContent = artifactName;

            const backLevel = document.createElement('div');
            backLevel.className = 'artifact-back-level';
            backLevel.textContent = 'Î†àÎ≤® 0';

            const backDesc = document.createElement('div');
            backDesc.className = 'artifact-back-desc';
            backDesc.textContent = getArtifactStats(artifactName, 0);

            back.appendChild(backHeading);
            back.appendChild(backLevel);
            back.appendChild(backDesc);

            card.appendChild(front);
            card.appendChild(back);

            return card;
        }

        function buildArtifactGrid(targetId) {
            const grid = document.getElementById(targetId);
            if (!grid) return;
            grid.innerHTML = '';
            ARTIFACT_NAMES.forEach(name => {
                grid.appendChild(createArtifactCardElement(name));
            });
        }

        function getDefaultQuestState() {
            return {
                lastDailyReset: 0,
                dailyQuests: [],
                eventQuests: [],
                activeTab: 'daily',
                playtimeAnchorMs: 0
            };
        }

        let questState = getDefaultQuestState();
        let questTimerInterval = null;
        
        // ÏÉÅÏ†ê Í¥ÄÎ†® Î≥ÄÏàò
        let shopItems = []; // ÌòÑÏû¨ ÏÉÅÏ†êÏóê ÏûàÎäî Î¨ºÌíàÎì§
        let purchasedInCurrentShop = []; // ÌòÑÏû¨ ÏÉÅÏ†êÏóêÏÑú Íµ¨Îß§Ìïú ÏïÑÏù¥ÌÖú Ïù∏Îç±Ïä§
        let allShopItems = [
            // Ìè¨ÏÖòÎ•ò - ÏùºÎ∞ò Îì±Í∏â
            { name: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö†', price: 10, rarity: 'common', type: 'potion', effect: 'luck', level: 1, minQty: 1, maxQty: 10 },
            { name: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö†', price: 10, rarity: 'common', type: 'potion', effect: 'speed', level: 1, minQty: 1, maxQty: 10 },
            // Ìè¨ÏÖòÎ•ò - Ìù¨Í∑Ä Îì±Í∏â
            { name: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö°', price: 30, rarity: 'rare', type: 'potion', effect: 'luck', level: 2, minQty: 1, maxQty: 5 },
            { name: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö°', price: 30, rarity: 'rare', type: 'potion', effect: 'speed', level: 2, minQty: 1, maxQty: 5 },
            // Ìè¨ÏÖòÎ•ò - Î†àÏñ¥ Îì±Í∏â Í∑∏Î£π
            { name: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö¢', price: 100, rarity: 'epic', type: 'potion', effect: 'luck', level: 3, minQty: 1, maxQty: 3 },
            { name: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö¢', price: 100, rarity: 'epic', type: 'potion', effect: 'speed', level: 2, minQty: 1, maxQty: 3 },
            // Î†àÏñ¥ Îì±Í∏â ÏïÑÏù¥ÌÖú
            { name: 'Ï£ºÎßê', price: 250, rarity: 'epic', type: 'special', effect: 'remove_cooldown', minQty: 1, maxQty: 1 },
            { name: '1339Ìè¨ÏÖò', price: 250, rarity: 'epic', type: 'potion', effect: 'speed_boost', level: 4, minQty: 1, maxQty: 1 },
            { name: 'Î≥¥Ï°∞Î∞∞ÌÑ∞Î¶¨', price: 250, rarity: 'epic', type: 'special', effect: 'refresh_shop', minQty: 1, maxQty: 1 },
            { name: 'Îü≠ÌÇ§Î∞ïÏä§', price: 250, rarity: 'epic', type: 'special', effect: 'lucky_box', minQty: 1, maxQty: 1 },
            // ÌÖåÎßà - ÏòÅÏõÖ Îì±Í∏â
            { name: 'ÌÖåÎßà_Ï£ºÌô©', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'orange', oneTime: true },
            { name: 'ÌÖåÎßà_Ï¥àÎ°ù', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'green', oneTime: true },
            { name: 'ÌÖåÎßà_ÌöåÏÉâ', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'gray', oneTime: true },
            { name: 'ÌÖåÎßà_ÎÖ∏ÎûÄÏÉâ', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'yellow', oneTime: true },
            { name: 'ÌÖåÎßà_ÌïëÌÅ¨ÏÉâ', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'pink', oneTime: true },
            { name: 'ÌÖåÎßà_Î≥¥Îùº', price: 5000, rarity: 'hero', type: 'theme', themeColor: 'purple', oneTime: true },
            // ÌäπÏàò ÏïÑÏù¥ÌÖú - ÏòÅÏõÖ Îì±Í∏â
            { name: 'Ïö©ÏÇ¨Ïùò Ïã¨Ìåê', price: 5000, rarity: 'hero', type: 'potion', effect: 'guaranteed_special', minQty: 1, maxQty: 1 },
            { name: 'ÏÉ§Ïò§ÎØ∏Ìè∞', price: 75, rarity: 'rare', type: 'special', effect: 'xiaomi_phone', minQty: 1, maxQty: 1 },
            { name: 'ÏãúÏõêÌïú Î¨º', price: 75, rarity: 'rare', type: 'special', effect: 'cold_water', minQty: 1, maxQty: 1 }
        ]; // Ï†ÑÏ≤¥ ÏÉÅÏ†ê Î¨ºÌíà Î™©Î°ù
        let shopRefreshTime = 0; // Îã§Ïùå ÏÉÅÏ†ê Í∞±Ïã† ÏãúÍ∞Ñ (ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ)
        let shopTimerInterval = null;
        
        // ÌéòÏù¥ÏßÄ Î°úÎìú Ïãú ÎûúÎç§ÎΩëÍ∏∞ ÌôîÎ©¥ÏúºÎ°ú ÏãúÏûë
        window.onload = function() {
             // ÌÖåÏä§Ìä∏Ïö©: localStorage Ï¥àÍ∏∞Ìôî (Ìïú Î≤àÎßå Ïã§Ìñâ)
             // localStorage.removeItem('sehorory_state_v1');
             
             goToScreen(3); // ÎûúÎç§ÎΩëÍ∏∞ ÌôîÎ©¥(Í∞ÄÏö¥Îç∞)ÏúºÎ°ú ÏãúÏûë
            updateProbabilityTable(); // ÌôïÎ•†Ìëú Ï¥àÍ∏∞Ìôî
            loadState(); // Ï†ÄÏû•Îêú ÏÉÅÌÉú Î∂àÎü¨Ïò§Í∏∞
            sehoCoin = 0;
            updateCoinDisplay();
            saveState();
            startPlaytimeTicker();
             updateTrumpCardInfo(); // Ìä∏ÎüºÌîÑÏπ¥Îìú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
             updateGoldenStatueInfo();
             initShop(); // ÏÉÅÏ†ê Ï¥àÍ∏∞Ìôî
             updateItemStorageDisplay(); // ÏïÑÏù¥ÌÖú Î≥¥Í¥ÄÏÜå Ï¥àÍ∏∞Ìôî
            initQuestSystem();
            
            // ÏÇ¨Ïö©Ïûê ÌôúÎèô Í∞êÏßÄ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Ï∂îÍ∞Ä
            setupActivityListeners();
            
            updateCoinDisplay(); // ÏÑ∏Ìò∏ÏΩîÏù∏ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            updateBuffDisplay(); // Î≤ÑÌîÑ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            startBuffTimer(); // Î≤ÑÌîÑ ÌÉÄÏù¥Î®∏ ÏãúÏûë
            updateDotStates(); // ÎèÑÌä∏ ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            // ÌÖåÎßà ÏÑ†ÌÉùÍ∏∞ Ï¥àÍ∏∞Ìôî (DOMÏù¥ Ï§ÄÎπÑÎêú ÌõÑ)
            setTimeout(() => {
                initThemeSelector();
                applyTheme(currentTheme);
            }, 100);
        };
        // ÏÇ¨Ïö©Ïûê ÌôúÎèô Í∞êÏßÄ Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà ÏÑ§Ï†ï
        function setupActivityListeners() {
            // ÎΩëÍ∏∞ Î≤ÑÌäº ÌÅ¥Î¶≠
            const drawButton = document.getElementById('drawButton');
            if (drawButton) {
                drawButton.addEventListener('click', updateActivity);
            }
            
            // ÏÉÅÏ†ê Î≤ÑÌäº ÌÅ¥Î¶≠
            const shopButton = document.getElementById('shopButton');
            if (shopButton) {
                shopButton.addEventListener('click', updateActivity);
            }
            
            // ÏÑ§Ï†ï Î≤ÑÌäº ÌÅ¥Î¶≠
            const settingsButton = document.getElementById('settingsButton');
            if (settingsButton) {
                settingsButton.addEventListener('click', updateActivity);
            }
            
            // ÏÉÅÏ†ê ÏïÑÏù¥ÌÖú Íµ¨Îß§
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('shop-item') || e.target.closest('.shop-item')) {
                    updateActivity();
                }
            });
            
            // ÌÖåÎßà Î≥ÄÍ≤Ω
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('theme-button') || e.target.closest('.theme-button')) {
                    updateActivity();
                }
            });
            
            // ÏïÑÏù¥ÌÖú ÏÇ¨Ïö©
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('use-item') || e.target.closest('.use-item')) {
                    updateActivity();
                }
            });
            
            // ÌÇ§Î≥¥Îìú ÏûÖÎ†• (Ïä§ÌéòÏù¥Ïä§Î∞î ÎΩëÍ∏∞ Îì±)
            document.addEventListener('keydown', function(e) {
                if (e.code === 'Space' || e.code === 'Enter') {
                    updateActivity();
                }
            });
            
            // ÎßàÏö∞Ïä§ ÏõÄÏßÅÏûÑ
            document.addEventListener('mousemove', updateActivity);
            
            // Ïä§ÌÅ¨Î°§
            document.addEventListener('scroll', updateActivity);
        }
        let storage = []; // ÎΩëÌûå Í≤∞Í≥º Ï†ÄÏû•ÏÜå
        let startX = 0;
        let startY = 0;
        let artifactStorage = []; // Ïú†Î¨º Ï†ÄÏû•ÏÜå

        function getDailyQuestDefinitionByKey(key) {
            if (!key) return null;
            return DAILY_QUEST_POOL.find(def => def.key === key) || null;
        }
        let lastArtifactDraw = 0; // ÎßàÏßÄÎßâ Ïú†Î¨º ÎΩëÍ∏∞ ÏãúÍ∞Ñ
        let baseArtifactCooldown = 300; // Í∏∞Î≥∏ Ïú†Î¨º ÎΩëÍ∏∞ Ïø®Îã§Ïö¥ (Ï¥à)
        let totalDraws = 0; // Ï¥ù ÎΩëÍ∏∞ ÌöüÏàò
        let rarestItem = null; // { name, realProbabilityNum }
        let startTime = Date.now();
        let playtimeTimer = null;
        let lastEnhancementTime = 0; // ÎßàÏßÄÎßâ Í∞ïÌôî ÏãúÍ∞Ñ
        let pausedTime = 0; // ÏùºÏãúÏ†ïÏßÄÎêú ÏãúÍ∞Ñ ÎàÑÏ†Å
        let lastPauseTime = 0; // ÎßàÏßÄÎßâ ÏùºÏãúÏ†ïÏßÄ ÏãúÏ†ê
        let lastActivityTime = Date.now(); // ÎßàÏßÄÎßâ ÏÇ¨Ïö©Ïûê ÌôúÎèô ÏãúÍ∞Ñ
        let activityTimeout = null; // ÌôúÎèô ÌÉÄÏûÑÏïÑÏõÉ
        let enhancementCooldown = 1000; // Í∞ïÌôî Ïø®Îã§Ïö¥ (1Ï¥à)
        let sehoDrawCount = 0; // ÏÑ∏Ìò∏ ÎΩëÍ∏∞ ÌöüÏàò Ï∂îÏ†Å

        // ÏÉÅÌÉú Ï†ÄÏû•/Î∂àÎü¨Ïò§Í∏∞ (localStorage)
        function saveState() {
            try {
                const data = {
                    storage,
                    artifactStorage,
                    lastArtifactDraw,
                    totalDraws,
                    rarestItem,
                     startTime,
                     pausedTime,
                     sehoDrawCount,
                     shopItems,
                     shopRefreshTime,
                     purchasedInCurrentShop,
                     sehoCoin,
                     activeBuffs,
                     purchasedThemes,
                     currentTheme,
                     itemStorage,
                     specialItemCount,
                     noCooldownCount,
                    nameChangedItems,
                    usedCodes,
                    layoutOverride,
                    questState: getQuestStateSnapshot()
                };
                localStorage.setItem('sehorory_state_v1', JSON.stringify(data));
            } catch (e) { console.log('save failed'); }
        }
        // ÌÖåÏä§Ìä∏Ïö© Ïú†Î¨º Ï¥àÍ∏∞Ìôî Ìï®Ïàò

        function loadState() {
            try {
                const raw = localStorage.getItem('sehorory_state_v1');
                if (!raw) {
                    // Ï†ÄÏû•Îêú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ Í∏∞Î≥∏ ÏÉÅÌÉú Ïú†ÏßÄ
                    updateStorageDisplay();
                    initArtifactCarousel();
                    updateSettingsStats();
                    updateTrumpCardInfo();
                    updateGoldenStatueInfo();
                    return;
                }
                const data = JSON.parse(raw);
                if (Array.isArray(data.storage)) storage = data.storage;
                if (Array.isArray(data.artifactStorage)) artifactStorage = data.artifactStorage;
                if (typeof data.lastArtifactDraw === 'number') lastArtifactDraw = data.lastArtifactDraw;
                if (typeof data.totalDraws === 'number') totalDraws = data.totalDraws;
                if (data.rarestItem) rarestItem = data.rarestItem;
                if (typeof data.startTime === 'number') startTime = data.startTime;
                if (typeof data.pausedTime === 'number') pausedTime = data.pausedTime;
                if (typeof data.sehoDrawCount === 'number') sehoDrawCount = data.sehoDrawCount;
                if (Array.isArray(data.shopItems)) shopItems = data.shopItems;
                if (typeof data.shopRefreshTime === 'number') shopRefreshTime = data.shopRefreshTime;
                if (Array.isArray(data.purchasedInCurrentShop)) purchasedInCurrentShop = data.purchasedInCurrentShop;
                if (typeof data.sehoCoin === 'number') sehoCoin = data.sehoCoin;
                if (Array.isArray(data.activeBuffs)) activeBuffs = data.activeBuffs;
                if (Array.isArray(data.purchasedThemes)) purchasedThemes = data.purchasedThemes;
                if (typeof data.currentTheme === 'string') currentTheme = data.currentTheme;
                 if (Array.isArray(data.itemStorage)) itemStorage = data.itemStorage;
                 if (typeof data.specialItemCount === 'number') specialItemCount = data.specialItemCount;
                 if (typeof data.noCooldownCount === 'number') noCooldownCount = data.noCooldownCount;
                 if (Array.isArray(data.nameChangedItems)) nameChangedItems = data.nameChangedItems;
                sanitizeThemeState();
                 if (Array.isArray(data.usedCodes)) usedCodes = data.usedCodes;
                if (data.layoutOverride === 'mobile' || data.layoutOverride === 'desktop') {
                    layoutOverride = data.layoutOverride;
                } else {
                    layoutOverride = null;
                }
                syncWeekendBuffState();
                const buffStateChanged = initializeBuffIds();
                if (data.questState) {
                    questState = {
                        ...getDefaultQuestState(),
                        ...data.questState
                    };
                    sanitizeQuestState();
                }
                
                updateStorageDisplay();
                initArtifactCarousel();
                updateSettingsStats();
                updateTrumpCardInfo();
                updateGoldenStatueInfo();
                // Ïú†Î¨º ÎΩëÍ∏∞ Ïø®Îã§Ïö¥ Î≥µÍµ¨
                const now = Date.now();
                const remainingMs = getArtifactCooldown() * 1000 - (now - lastArtifactDraw);
                if (remainingMs > 0) startArtifactCooldown();
                if (buffStateChanged) {
                    saveState();
                }
                updateLayoutToggleUI();
                queueResponsiveLayout();
            } catch (e) { console.log('load failed'); }
        }

        // Í∞ÄÏ§ëÏπò Í∏∞Î∞ò ÎûúÎç§ ÏÑ†ÌÉù Ìï®Ïàò
        function getWeightedRandom() {
            const pool = getEffectiveParticipants();
            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            let random = Math.random() * totalWeight;
            
            for (let participant of pool) {
                random -= participant.weight;
                if (random <= 0) {
                    return participant;
                }
            }
            return pool[pool.length - 1]; // fallback
        }
        // ÎΩëÍ∏∞ ÏãúÏûë
        function startDraw() {
            if (isDrawing) return;
            
            if (participants.length === 0) {
                document.getElementById('resultDisplay').textContent = 'Ï∞∏Í∞ÄÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§!';
                return;
            }

            const skipAnimation = noCooldownCount > 0;
            isDrawing = true;
            const button = document.getElementById('drawButton');
            button.disabled = true;

            if (skipAnimation) {
                finishDraw();
                return;
            }

            button.textContent = 'ÎΩëÎäî Ï§ë...';

            // Í≤∞Í≥º ÌëúÏãú ÏòÅÏó≠ Ï¥àÍ∏∞Ìôî
            const resultDisplay = document.getElementById('resultDisplay');
            resultDisplay.textContent = 'ÎΩëÎäî Ï§ë...';
            resultDisplay.className = 'result-display reset';
            resultDisplay.style.fontSize = '2.2em';

            // Ïï†ÎãàÎ©îÏù¥ÏÖò Ìö®Í≥º (ÏÜçÎèÑÌè¨ÏÖò Ï†ÅÏö©)
            let count = 0;
            const spinInterval = getSpinInterval();
            const interval = setInterval(() => {
                const randomParticipant = getWeightedRandom();
                resultDisplay.textContent = randomParticipant.name;
                resultDisplay.className = 'result-display reset';
                resultDisplay.style.fontSize = '2.2em';
                count++;
                
                if (count > 45) {
                    clearInterval(interval);
                    finishDraw();
                }
            }, spinInterval);
        }
        function handleGoldenStatueReward() {
            const level = getArtifactLevel('ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ìô©Í∏àÎèôÏÉÅ');
            if (level <= 0) return;
            if (sehoDrawCount <= 0 || sehoDrawCount % 10 !== 0) return;
            
            const coins = ARTIFACT_VALUES.GOLDEN_STATUE_COINS[Math.min(level, 5)] || 0;
            if (coins <= 0) return;
            
            sehoCoin += coins;
            updateCoinDisplay();
            updateGoldenStatueInfo();
        }
        // ÎΩëÍ∏∞ ÏôÑÎ£å
        function finishDraw() {
            const winner = getWeightedRandom(); // Í∞ÄÏ§ëÏπò Í∏∞Î∞ò ÎûúÎç§ ÏÑ†ÌÉù
            const resultDisplay = document.getElementById('resultDisplay');
            
            if (noCooldownCount > 0) {
                consumeWeekendCharge();
            }
            
            // ÍΩù Ï≤òÎ¶¨: ÌÜµÍ≥Ñ Ï¶ùÍ∞ÄÎßå ÌïòÍ≥† Ï¢ÖÎ£å
            if (winner && winner.name === 'ÍΩù') {
                resultDisplay.textContent = 'ÍΩù';
                resultDisplay.className = 'result-display miss';
                
                const prevDraws = totalDraws;
                totalDraws += 1;
                checkUnlockNotification(prevDraws, totalDraws);
                
                sehoDrawCount += 1;
                updateTrumpCardInfo();
                handleGoldenStatueReward();
                incrementQuestProgress('draw', 1);
                updateGoldenStatueInfo();
                updateSettingsStats();
                updateDotStates();
                
                const button = document.getElementById('drawButton');
                button.textContent = 'üéØ ÎΩëÍ∏∞ ÏãúÏûë!';
                button.disabled = false;
                isDrawing = false;
                saveState();
                return;
            }
            
            // ÏÑ∏Ìò∏ ÎΩëÍ∏∞ ÌöüÏàò Î∞è Ìä∏ÎüºÌîÑÏπ¥Îìú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            sehoDrawCount += 1;
            updateTrumpCardInfo();
            handleGoldenStatueReward();
            incrementQuestProgress('draw', 1);
            updateGoldenStatueInfo();
            
            // Ïú†Î¨º Ìö®Í≥º Ï†ÅÏö©
            const specialEffectBonus = getSpecialEffectBonus(winner.name);
            const rainbowBonus = getRainbowBonus();
            
            // ÎèÖÎ¶ΩÏ†ÅÏù∏ 5Îã®Í≥Ñ ÎΩëÍ∏∞: ÎπõÎÇòÎäî 20%, Î≤àÏ©çÏù¥Îäî 5%, Ìô©Í∏à 1%, Îã§Ïù¥ÏïÑ 0.2%, Î¨¥ÏßÄÍ∞ØÎπõ 0.02%
            const random1 = Math.random();
            const random2 = Math.random();
            const random3 = Math.random();
            const random4 = Math.random();
            const random5 = Math.random();
            let effectType = 'normal';
            let displayText = winner.name;
            
            // Ìä∏ÎüºÌîÑÏπ¥Îìú Ìö®Í≥º ÌôïÏù∏
            const isGuaranteedSpecial = shouldGuaranteeSpecialEffect();
            
            if (isGuaranteedSpecial) {
                const totalSpecialChance =
                    0.0002 * (1 + rainbowBonus) +
                    0.002 * (1 + specialEffectBonus) +
                    0.01 * (1 + specialEffectBonus) +
                    0.2 * (1 + specialEffectBonus) +
                    0.05 * (1 + specialEffectBonus);
                
                const normalizedRainbow = (0.0002 * (1 + rainbowBonus)) / totalSpecialChance;
                const normalizedDiamond = (0.002 * (1 + specialEffectBonus)) / totalSpecialChance;
                const normalizedGolden = (0.01 * (1 + specialEffectBonus)) / totalSpecialChance;
                const normalizedShining = (0.2 * (1 + specialEffectBonus)) / totalSpecialChance;
                const normalizedSparkling = (0.05 * (1 + specialEffectBonus)) / totalSpecialChance;
                
                const specialRandom = Math.random();
                let cumulative = 0;
                
                if (specialRandom < (cumulative += normalizedRainbow)) {
                    effectType = 'rainbow';
                    displayText = `Î¨¥ÏßÄÍ∞ØÎπõ ${winner.name}`;
                } else if (specialRandom < (cumulative += normalizedDiamond)) {
                    effectType = 'diamond';
                    displayText = `Îã§Ïù¥ÏïÑÎ™¨ÎìúÏÉâ ${winner.name}`;
                } else if (specialRandom < (cumulative += normalizedGolden)) {
                    effectType = 'golden';
                    displayText = `Ìô©Í∏àÏÉâ ${winner.name}`;
                } else if (specialRandom < (cumulative += normalizedShining)) {
                    effectType = 'shining';
                    displayText = `ÎπõÎÇòÎäî ${winner.name}`;
                } else {
                    effectType = 'sparkling';
                    displayText = `Î≤àÏ©çÏù¥Îäî ${winner.name}`;
                }
            } else {
                if (random5 < 0.0002 * (1 + rainbowBonus)) {
                    effectType = 'rainbow';
                    displayText = `Î¨¥ÏßÄÍ∞ØÎπõ ${winner.name}`;
                } else if (random4 < 0.002 * (1 + specialEffectBonus)) {
                    effectType = 'diamond';
                    displayText = `Îã§Ïù¥ÏïÑÎ™¨ÎìúÏÉâ ${winner.name}`;
                } else if (random3 < 0.01 * (1 + specialEffectBonus)) {
                    effectType = 'golden';
                    displayText = `Ìô©Í∏àÏÉâ ${winner.name}`;
                } else if (random1 < 0.2 * (1 + specialEffectBonus)) {
                    effectType = 'shining';
                    displayText = `ÎπõÎÇòÎäî ${winner.name}`;
                } else if (random2 < 0.05 * (1 + specialEffectBonus)) {
                    effectType = 'sparkling';
                    displayText = `Î≤àÏ©çÏù¥Îäî ${winner.name}`;
                }
            }
            
            resultDisplay.textContent = displayText;
            
            if (effectType === 'rainbow') {
                resultDisplay.className = 'result-display rainbow';
                playRainbowSound();
            } else if (effectType === 'diamond') {
                resultDisplay.className = 'result-display diamond';
                playDiamondSound();
            } else if (effectType === 'golden') {
                resultDisplay.className = 'result-display golden';
                playGoldenSound();
            } else if (effectType === 'shining') {
                resultDisplay.className = 'result-display shining';
            } else if (effectType === 'sparkling') {
                resultDisplay.className = 'result-display sparkling';
            } else {
                resultDisplay.className = 'result-display winner';
            }

            if (effectType === 'golden') {
                incrementQuestProgress('golden_effect', 1);
            } else if (effectType === 'diamond') {
                incrementQuestProgress('diamond_effect', 1);
            }
            
            addToStorage(winner.name, effectType, winner);
            
            const prevDraws = totalDraws;
            totalDraws += 1;
            checkUnlockNotification(prevDraws, totalDraws);
            
            updateSettingsStats();
            updateDotStates();
            saveState();
            
            renderBelowProbability();
            updateStorageDisplay();
            
            const button = document.getElementById('drawButton');
            button.textContent = 'üéØ ÎΩëÍ∏∞ ÏãúÏûë!';
            button.disabled = false;
            isDrawing = false;
        }

        // Î≥¥Í¥ÄÏÜåÏóê Ï∂îÍ∞Ä
        function addToStorage(winner, effectType = 'normal', participant = null) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('ko-KR');
            
            // ÏõêÎ≥∏ ÌôïÎ•† Í≥ÑÏÇ∞
            const pool = getEffectiveParticipants();
            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            const participantData = participant || pool.find(p => p.name === winner);
            const baseProbabilityNum = participantData ? ((participantData.weight / totalWeight) * 100) : 0;
            const baseProbability = formatFiniteOrEllipsis(baseProbabilityNum);
            
            // Ïã§Ï†ú ÌôïÎ•† Í≥ÑÏÇ∞ (Ìö®Í≥º Ìè¨Ìï®, Í∞ïÌôî Ìö®Í≥º Î∞òÏòÅ)
            let realProbabilityNum = baseProbabilityNum;
            // participant.nameÏùÑ ÏÇ¨Ïö©ÌïòÏó¨ ÏõêÎ≥∏ ÏÑ∏Ìò∏ Ïù¥Î¶ÑÏúºÎ°ú ÌäπÎ≥ÑÌö®Í≥º Î≥¥ÎÑàÏä§ Í≥ÑÏÇ∞
            const specialEffectBonus = getSpecialEffectBonus(participant ? participant.name : winner);
            
            if (effectType === 'rainbow') {
                // Î¨¥ÏßÄÍ∞ØÎπõÏùò Ïã§ÌôïÎ•† (ÎèÖÎ¶Ω Îã®Í≥Ñ) ÌëúÍ∏∞: Í∏∞Î≥∏ ÌôïÎ•† * 0.0002 * (1 + Î¨¥ÏßÄÍ∞ØÎπõ Î≥¥ÏÑù Î≥¥ÎÑàÏä§)
                realProbabilityNum = baseProbabilityNum * 0.0002 * (1 + getRainbowBonus());
            } else if (effectType === 'diamond') {
                realProbabilityNum = baseProbabilityNum * 0.002 * (1 + specialEffectBonus);
            } else if (effectType === 'golden') {
                realProbabilityNum = baseProbabilityNum * 0.01 * (1 + specialEffectBonus);
            } else if (effectType === 'shining') {
                realProbabilityNum = baseProbabilityNum * 0.2 * (1 + specialEffectBonus);
            } else if (effectType === 'sparkling') {
                realProbabilityNum = baseProbabilityNum * 0.05 * (1 + specialEffectBonus);
            }
            const realProbability = formatFiniteOrEllipsis(realProbabilityNum);
            // Î†àÏñ¥ÎèÑ Í∞±Ïã† (Í∞ÄÏû• ÎÇÆÏùÄ Ïã§ÌôïÎ•†)
            try {
                const rp = Number(realProbabilityNum);
                if (!isNaN(rp) && rp >= 0) {
                    if (!rarestItem || rp < rarestItem.realProbabilityNum) {
                        // ÏõêÎ≥∏ Ïù¥Î¶ÑÍ≥º effectTypeÏùÑ Ìï®Íªò Ï†ÄÏû•
                        let displayName = winner;
                        if (effectType === 'rainbow') {
                            displayName = `üåà ${winner} üåà`;
                        } else if (effectType === 'diamond') {
                            displayName = `üíé Îã§Ïù¥ÏïÑÎ™¨ÎìúÏÉâ ${winner} üíé`;
                        } else if (effectType === 'golden') {
                            displayName = `üèÜ Ìô©Í∏àÏÉâ ${winner} üèÜ`;
                        } else if (effectType === 'sparkling') {
                            displayName = `‚ö° Î≤àÏ©çÏù¥Îäî ${winner} ‚ö°`;
                        } else if (effectType === 'shining') {
                            displayName = `‚ú® ÎπõÎÇòÎäî ${winner} ‚ú®`;
                        }
                        rarestItem = { name: displayName, realProbabilityNum: rp };
                    }
                }
            } catch (e) {}
            
            // Í∞ôÏùÄ ÏïÑÏù¥ÌÖúÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏ (Í∞ïÌôî Îã®Í≥ÑÎèÑ Í≥†Î†§)
            // ÎΩëÍ∏∞Î°ú ÏñªÏùÄ ÏïÑÏù¥ÌÖúÏùÄ Ìï≠ÏÉÅ Í∞ïÌôî Îã®Í≥Ñ 0Ïù¥ÎØÄÎ°ú, Í∞ïÌôî Îã®Í≥Ñ 0Ïù∏ Í≤ÉÎßå Ï∞æÏùå
            const existingItem = storage.find(item => 
                item.name === winner && 
                item.effectType === effectType &&
                (item.enhanceLevel || 0) === 0
            );
            
            if (existingItem) {
                // Í∞ôÏùÄ ÏïÑÏù¥ÌÖúÏù¥ ÏûàÏúºÎ©¥ Í∞úÏàò Ï¶ùÍ∞Ä
                existingItem.count = (existingItem.count || 1) + 1;
                existingItem.time = timeString; // ÏµúÏã† ÏãúÍ∞ÑÏúºÎ°ú ÏóÖÎç∞Ïù¥Ìä∏
                existingItem.date = now.toLocaleDateString('ko-KR');
            } else {
                // ÏÉàÎ°úÏö¥ ÏïÑÏù¥ÌÖú Ï∂îÍ∞Ä
            storage.push({
                name: winner,
                time: timeString,
                date: now.toLocaleDateString('ko-KR'),
                effectType: effectType,
                baseProbability: baseProbability,
                    realProbability: realProbability,
                count: 1,
                enhanceLevel: 0
            });
            }
            
            // Ïö©ÏÇ¨Ïùò Ïã¨Ìåê Ìö®Í≥º ÏÇ¨Ïö©
            if (specialItemCount > 0) {
                specialItemCount--;
        }

            updateStorageDisplay();
            saveState();
        }
        // Î≥¥Í¥ÄÏÜå ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
        function updateStorageDisplay() {
            // Î©îÏù∏ Î≥¥Í¥ÄÏÜå ÏòÅÏó≠ (Í∏∞Ï°¥)
            const storageList = document.getElementById('storageList');
            // Ïò§Î≤ÑÎ†àÏù¥ Î≥¥Í¥ÄÏÜå ÏòÅÏó≠Îì§
            const storageSehoOverlay = document.querySelector('#sehoOverlay #sehoStor .storage-list');
            const storageArtiOverlay = document.querySelector('#artiOverlay #artiStor .storage-list');
            
            if (storage.length === 0) {
                if (storageList) storageList.innerHTML = '<p>ÎΩëÌûå Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê Ï†ÄÏû•Îê©ÎãàÎã§.</p>';
                if (storageSehoOverlay) storageSehoOverlay.innerHTML = '<p>ÎΩëÌûå Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê Ï†ÄÏû•Îê©ÎãàÎã§.</p>';
                if (storageArtiOverlay) storageArtiOverlay.innerHTML = '<p>ÎΩëÌûå Í≤∞Í≥ºÍ∞Ä Ïó¨Í∏∞Ïóê Ï†ÄÏû•Îê©ÎãàÎã§.</p>';
                return;
            }

            // Ïù¥Î≤§Ìä∏ ÏúÑÏûÑÏúºÎ°ú Í∞ïÌôî Î≤ÑÌäº Ï≤òÎ¶¨ (Î©îÏù∏/Ïò§Î≤ÑÎ†àÏù¥ Í∞ÅÍ∞Å)
            function bindUpgradeDelegation(host) {
                if (!host) return;
                host.onclick = (e) => {
                    const target = e.target;
                    if (target && target.classList && target.classList.contains('action-upgrade')) {
                        const itemDiv = target.closest('.storage-item');
                        if (!itemDiv) return;
                        const idxAttr = itemDiv.getAttribute('data-index');
                        if (idxAttr == null) return;
                        const idx = parseInt(idxAttr, 10);
                        performUpgrade(idx);
                        e.stopPropagation();
                    }
                };
            }

            bindUpgradeDelegation(storageList);
            bindUpgradeDelegation(storageSehoOverlay);
            bindUpgradeDelegation(storageArtiOverlay);

            // ÌôïÎ•†Ïù¥ ÎÇÆÏùÄ ÏàúÏúºÎ°ú Ï†ïÎ†¨ (Í∞ïÌôîÎêú ÌôïÎ•† Í∏∞Ï§Ä)
            const sortedStorage = [...storage].sort((a, b) => {
                // Í∞ïÌôîÎêú ÌôïÎ•† Í≥ÑÏÇ∞
                const getEffectiveProbability = (item) => {
                    const baseProb = parseFloat(item.realProbability) || 0;
                    const level = item.enhanceLevel || 0;
                    if (level === 0) return baseProb;
                    
                    // Í∞ïÌôî Îã®Í≥ÑÏóê Îî∞Î•∏ ÏÑ±Í≥µ ÌôïÎ•†Îì§
                    const enhanceChances = [0.8, 0.7, 0.55, 0.35, 0.1];
                    let effectiveProb = baseProb;
                    
                    // Í∞Å Í∞ïÌôî Îã®Í≥ÑÏùò ÏÑ±Í≥µ ÌôïÎ•†ÏùÑ Í≥±Ìï¥ÏÑú ÏµúÏ¢Ö ÌôïÎ•† Í≥ÑÏÇ∞
                    for (let i = 0; i < level; i++) {
                        effectiveProb *= enhanceChances[i] || 1;
                    }
                    
                    return effectiveProb;
                };
                
                const aProb = getEffectiveProbability(a);
                const bProb = getEffectiveProbability(b);
                
                // ÌôïÎ•†Ïù¥ ÎÇÆÏùÄ ÏàúÏúºÎ°ú Ï†ïÎ†¨
                return aProb - bProb;
            });

            if (storageList) storageList.innerHTML = '';
            if (storageSehoOverlay) storageSehoOverlay.innerHTML = '';
            if (storageArtiOverlay) storageArtiOverlay.innerHTML = '';
            
            // 2Í∞úÏî© Í∑∏Î£πÏúºÎ°ú ÎÇòÎàÑÏñ¥ ÌëúÏãú
            for (let i = 0; i < sortedStorage.length; i += 2) {
                const row = document.createElement('div');
                row.className = 'storage-row';
                
                for (let j = 0; j < 2 && i + j < sortedStorage.length; j++) {
                    const item = sortedStorage[i + j];
                    const div = document.createElement('div');
                    
                    div.className = `storage-item ${item.effectType}`;
                    const originalIndex = storage.indexOf(item);
                    div.setAttribute('data-index', String(originalIndex));
                     
                     // Ïù¥Î¶ÑÏù¥ Î∞îÎÄê ÏïÑÏù¥ÌÖú ÌëúÏãú
                     if (nameChangedItems.includes(originalIndex)) {
                         div.style.border = '3px solid #ff6b6b';
                         div.style.animation = 'pulse 1s ease-in-out infinite';
                     }
                    
                    // Í∞ïÌôî Îã®Í≥ÑÏóê Îî∞Î•∏ ÏãúÍ∞ÅÏ†Å Ìö®Í≥º Ï†ÅÏö©
                    const enhanceLevel = item.enhanceLevel || 0;
                    if (enhanceLevel > 0) {
                        div.setAttribute('data-enhance-level', String(enhanceLevel));
                    }
                    
                    let displayName = item.name;
                    const level = Math.max(0, item.enhanceLevel || 0);
                    if (level > 0) displayName = `${displayName} (+${level})`;
                    let probabilityText = `${item.realProbability}%`;
                    
                    if (item.effectType === 'rainbow') {
                        displayName = `üåà ${displayName} üåà`;
                    } else if (item.effectType === 'diamond') {
                        displayName = `üíé Îã§Ïù¥ÏïÑÎ™¨ÎìúÏÉâ ${displayName} üíé`;
                    } else if (item.effectType === 'golden') {
                        displayName = `üèÜ Ìô©Í∏àÏÉâ ${displayName} üèÜ`;
                    } else if (item.effectType === 'sparkling') {
                        displayName = `‚ö° Î≤àÏ©çÏù¥Îäî ${displayName} ‚ö°`;
                    } else if (item.effectType === 'shining') {
                        displayName = `‚ú® ÎπõÎÇòÎäî ${displayName} ‚ú®`;
                    }
                    
                    let countHtml = '';
                    if (item.count && item.count > 1) {
                        countHtml = `<div class="count">√ó${item.count}</div>`;
                    }
                    
                    const infoText = getEnhanceInfoText(level);
                    const rates = calculateEnhanceRates(level);
                    const enhancedLabel = level > 0 ? '<div class="enhanced-label">(Í∞ïÌôîÎê®)</div>' : '';
                    
                    // Ïú†Î¨º Ìö®Í≥ºÍ∞Ä ÏûàÏùÑ Îïå ÏÉâÏÉÅ Ï†ÅÏö©
                    const successColor = rates.hasArtifactEffect ? 'style="color: #87CEEB;"' : '';
                    const destroyColor = rates.hasArtifactEffect ? 'style="color: #87CEEB;"' : '';
                    
                    const itemDescription = getItemDescription(item.name);
                    const descriptionHtml = itemDescription ? `<div class=\"item-description\">${itemDescription}</div>` : '';
                    
                    div.innerHTML = `
                        <button class=\"sell-button\" onclick=\"sellItem(${originalIndex}, event)\" title=\"ÌåêÎß§\">üóëÔ∏è</button>
                        <div class=\"name\">${displayName}</div>
                        ${descriptionHtml}
                        <div class=\"probability\">${probabilityText}</div>
                        ${enhancedLabel}
                        <div class=\"time\">${item.date} ${item.time}</div>
                        ${countHtml}
                        <div class=\"enhance-stats\">ÏÑ±Í≥µÌôïÎ•†: <span ${successColor}>${formatPercent(rates.success)}</span><br>ÌååÍ¥¥ÌôïÎ•†: <span ${destroyColor}>${formatPercent(rates.destroy)}</span></div>
                        <div class=\"action-btn action-upgrade\">Í∞ïÌôîÌïòÍ∏∞</div>
                    `;

                    const upgBtn = div.querySelector('.action-upgrade');
                    if (upgBtn) {
                        if (level >= 5) {
                            upgBtn.style.opacity = '0.5';
                            upgBtn.style.cursor = 'not-allowed';
                            upgBtn.disabled = true;
                        } else {
                            // Í∞ïÌôî Ïø®ÌÉÄÏûÑ ÌôïÏù∏
                            const now = Date.now();
                            if (now - lastEnhancementTime < enhancementCooldown) {
                                const remainingTime = Math.ceil((enhancementCooldown - (now - lastEnhancementTime)) / 1000);
                                upgBtn.disabled = true;
                                upgBtn.style.opacity = '0.5';
                                upgBtn.style.cursor = 'not-allowed';
                                upgBtn.style.backgroundColor = '#adb5bd';
                                upgBtn.textContent = remainingTime > 0 ? `Ïø®ÌÉÄÏûÑ (${remainingTime}s)` : 'Ïø®ÌÉÄÏûÑ';
                            } else {
                                upgBtn.disabled = false;
                                upgBtn.style.opacity = '1';
                                upgBtn.style.cursor = 'pointer';
                                upgBtn.style.backgroundColor = '#28a745';
                                upgBtn.textContent = 'Í∞ïÌôîÌïòÍ∏∞';
                                upgBtn.onclick = (e) => { performUpgrade(originalIndex); e.stopPropagation(); };
                            }
                        }
                    }
                    row.appendChild(div);
                }
                
                if (storageList) storageList.appendChild(row);
                if (storageSehoOverlay) storageSehoOverlay.appendChild(row.cloneNode(true));
                if (storageArtiOverlay) storageArtiOverlay.appendChild(row.cloneNode(true));
            }
        }

        // Ïò§Î≤ÑÎ†àÏù¥ Ï¥àÍ∏∞Ìôî/Ï†úÏñ¥
        function initOverlayPanels() {
            // ÏÑ∏Ìò∏ Ïò§Î≤ÑÎ†àÏù¥
            const sehoOverlay = document.createElement('div');
            sehoOverlay.id = 'sehoOverlay';
            sehoOverlay.className = 'overlay';
            sehoOverlay.innerHTML = `
                <div class="overlay-header">
                    <button class="tab-button active" data-target="sehoProb" onclick="switchOverlayTab(event, 'sehoOverlay')">ÌôïÎ•†Ìëú</button>
                    <button class="tab-button" data-target="sehoStor" onclick="switchOverlayTab(event, 'sehoOverlay')">Î≥¥Í¥ÄÏÜå</button>
                </div>
                <div id="sehoProb" class="panel-content"></div>
                <div id="sehoStor" class="panel-content" style="display:none"><div class="storage-list"></div></div>
            `;
            document.body.appendChild(sehoOverlay);

            // Ïú†Î¨º Ïò§Î≤ÑÎ†àÏù¥
            const artiOverlay = document.createElement('div');
            artiOverlay.id = 'artiOverlay';
            artiOverlay.className = 'overlay';
            artiOverlay.innerHTML = `
                <div class="overlay-header">
                    <button class="tab-button active" data-target="artiColl" onclick="switchOverlayTab(event, 'artiOverlay')">Ïú†Î¨º Ïª¨Î†âÏÖò</button>
                    <button class="tab-button" data-target="artiStor" onclick="switchOverlayTab(event, 'artiOverlay')">Î≥¥Í¥ÄÏÜå</button>
                </div>
                <div id="artiColl" class="panel-content"><div class="artifact-grid" id="artifactGridOverlay"></div></div>
                <div id="artiStor" class="panel-content" style="display:none"><div class="storage-list"></div></div>
            `;
            document.body.appendChild(artiOverlay);

            renderOverlayProbability();
            updateStorageDisplay();
            initArtifactCollection();
        }

        // Í∞ïÌôî ÏãúÏä§ÌÖú
        const enhanceChances = [0.8, 0.7, 0.55, 0.35, 0.1]; // 0->1 ... 4->5 (ÏõêÎûò ÌôïÎ•†)

        function formatPercent(p) { return Math.round(p * 1000) / 10 + '%'; }

        // ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ïã†ÏÑ±Ìïú ÎßùÏπò Ïú†Î¨º Ìö®Í≥º ÌôïÏù∏
        function getHammerArtifactEffect() {
            return getArtifactLevel('ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ïã†ÏÑ±Ìïú ÎßùÏπò');
        }

        // ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ìä∏ÎüºÌîÑÏπ¥Îìú Ïú†Î¨º Ìö®Í≥º ÌôïÏù∏
        function getTrumpCardArtifactEffect() {
            return getArtifactLevel('ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ìä∏ÎüºÌîÑÏπ¥Îìú');
        }

        // Ìä∏ÎüºÌîÑÏπ¥Îìú Ìö®Í≥ºÎ°ú ÌäπÎ≥ÑÌö®Í≥º Î≥¥Ïû• Ïó¨Î∂Ä ÌôïÏù∏
        function shouldGuaranteeSpecialEffect() {
            const trumpLevel = getTrumpCardArtifactEffect();
            if (trumpLevel === 0) return false;
            const intervals = ARTIFACT_VALUES.TRUMP_GUARANTEE_INTERVAL;
            const guaranteeInterval = intervals[Math.min(trumpLevel, 5)] || 0;
            if (guaranteeInterval <= 0) return false;
            const upcomingDrawCount = totalDraws + 1;
            return upcomingDrawCount > 0 && upcomingDrawCount % guaranteeInterval === 0;
        }
        // Ìä∏ÎüºÌîÑÏπ¥Îìú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateTrumpCardInfo() {
            const trumpCardInfo = document.getElementById('trumpCardInfo');
            const trumpLevel = getTrumpCardArtifactEffect();
            
            if (trumpLevel > 0) {
                const intervals = ARTIFACT_VALUES.TRUMP_GUARANTEE_INTERVAL;
                const guaranteeInterval = intervals[Math.min(trumpLevel, 5)] || 0;
                if (guaranteeInterval > 0) {
                    const drawsCompleted = totalDraws;
                    const progress = drawsCompleted % guaranteeInterval;
                    const nextGuarantee = guaranteeInterval - progress;
                    
                    if (nextGuarantee === 1) {
                        trumpCardInfo.innerHTML = `üé¥ Ìä∏ÎüºÌîÑÏπ¥Îìú Ìö®Í≥º: Ï§ÄÎπÑ ÏôÑÎ£å! Îã§Ïùå ÎΩëÍ∏∞ÏóêÏÑú ÌäπÎ≥ÑÌö®Í≥º Î≥¥Ïû•`;
                    } else {
                        trumpCardInfo.innerHTML = `üé¥ Ìä∏ÎüºÌîÑÏπ¥Îìú Ìö®Í≥º: ${nextGuarantee}Ìöå ÌõÑ ÌäπÎ≥ÑÌö®Í≥º Î≥¥Ïû•`;
                    }
                } else {
                    trumpCardInfo.innerHTML = `üé¥ Ìä∏ÎüºÌîÑÏπ¥Îìú Ìö®Í≥º: ÌôúÏÑ±ÌôîÎê®`;
                }
                trumpCardInfo.style.display = 'block';
            } else {
                trumpCardInfo.style.display = 'none';
            }
        }

        function updateGoldenStatueInfo() {
            const statueInfo = document.getElementById('goldenStatueInfo');
            if (!statueInfo) return;
            
            const statueLevel = getArtifactLevel('ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ìô©Í∏àÎèôÏÉÅ');
            if (statueLevel <= 0) {
                statueInfo.style.display = 'none';
                statueInfo.textContent = '';
                return;
            }
            
            const coins = ARTIFACT_VALUES.GOLDEN_STATUE_COINS[Math.min(statueLevel, 5)] || 0;
            if (coins <= 0) {
                statueInfo.style.display = 'none';
                statueInfo.textContent = '';
                return;
            }
            
            const interval = 10;
            const progress = sehoDrawCount % interval;
            const remaining = progress === 0 ? interval : interval - progress;
            
            let message = `ü™ô Ìô©Í∏àÎèôÏÉÅ: ${interval}ÌöåÎßàÎã§ ÏÑ∏Ìò∏ÏΩîÏù∏ ${coins}Í∞ú ÏßÄÍ∏â`;
            if (remaining === interval) {
                message += ` (Îã§Ïùå ÏßÄÍ∏âÍπåÏßÄ ${interval}Ìöå)`;
            } else if (remaining === 1) {
                message += ` (Îã§Ïùå ÏßÄÍ∏âÍπåÏßÄ 1Ìöå ÎÇ®Ïùå)`;
            } else {
                message += ` (Îã§Ïùå ÏßÄÍ∏âÍπåÏßÄ ${remaining}Ìöå)`;
            }
            
            statueInfo.textContent = message;
            statueInfo.style.display = 'block';
        }

        // Í∞ïÌôî ÌôïÎ•† Í≥ÑÏÇ∞ (Ïú†Î¨º Ìö®Í≥º Ìè¨Ìï®)
        function calculateEnhanceRates(level) {
            const baseSuccess = enhanceChances[level] || 0;
            const baseFail = 1 - baseSuccess;
            const baseDestroy = baseFail * 0.10;
            
            const hammerLevel = getArtifactLevel('ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ïã†ÏÑ±Ìïú ÎßùÏπò');
            let finalSuccess = baseSuccess;
            let finalDestroy = baseDestroy;
            
            if (hammerLevel > 0) {
                const destroyReduction = ARTIFACT_VALUES.HAMMER_DESTRUCTION_REDUCTION[Math.min(hammerLevel, 5)] || 0;
                const reducedDestroy = Math.max(0, baseDestroy - destroyReduction);
                const destroyReductionAmount = baseDestroy - reducedDestroy;
                
                // Í∞êÏÜåÎêú ÌååÍ¥¥ÌôïÎ•†ÏùÑ ÏÑ±Í≥µÌôïÎ•†Ïóê Ï∂îÍ∞Ä
                finalSuccess = baseSuccess + destroyReductionAmount;
                finalDestroy = reducedDestroy;
            }
            
            return { success: finalSuccess, destroy: finalDestroy, hasArtifactEffect: hammerLevel > 0 };
        }

        function getEnhanceInfoText(level) {
            if (level >= 5) return 'ÏµúÎåÄ Í∞ïÌôî Îã®Í≥Ñ(5Í∞ï)ÏûÖÎãàÎã§.';
            const rates = calculateEnhanceRates(level);
            const colorStyle = rates.hasArtifactEffect ? 'style="color: #87CEEB;"' : '';
            return `Í∞ïÌôî ÌôïÎ•†: <span ${colorStyle}>${formatPercent(rates.success)}</span> / ÌååÍ¥¥ ÌôïÎ•†: <span ${colorStyle}>${formatPercent(rates.destroy)}</span> (Ïã§Ìå® Ïãú 1Îã®Í≥Ñ ÌïòÎùΩ, 0Í∞ï ÎØ∏Îßå ÌïòÎùΩ ÏóÜÏùå)`;
        }

        // ÏïÑÏù¥ÌÖú ÏÑ§Î™Ö Î∞òÌôò Ìï®Ïàò (ÏÉÅÏ†ê ÏïÑÏù¥ÌÖúÎßå)
        function getItemDescription(itemName) {
            // ÏÑ∏Ìò∏Î•òÎäî ÏÑ§Î™Ö ÏóÜÏùå
            const sehoTypes = ['ÏÑ∏Ìò∏Î°úÎ¶¨', 'ÏÑ∏Ìò∏Í≤åÏù¥', 'ÏÑ∏Ìò∏ÌçºÎ¶¨', 'ÏîπÎçïÏÑ∏Ìò∏', 'ÎßàÏ£†Ïù¥Ïä§Ìä∏ÏÑ∏Ìò∏', 
                             'ÌèâÎ≤îÌïúÏÑ∏Ìò∏', 'TSÏÑ∏Ìò∏', 'ÏáºÌÉÄÏÑ∏Ìò∏', 'ÏóêÍ≤êÏÑ∏Ìò∏', 'ÎãàÍ±∞ÏÑ∏Ìò∏', 'ÍΩù'];
            
            // ÌäπÎ≥ÑÌö®Í≥º Ï†úÍ±∞ ÌõÑ Í∏∞Î≥∏ Ïù¥Î¶ÑÏúºÎ°ú Í≤ÄÏÉâ
            let cleanName = itemName.replace(/‚ú® ÎπõÎÇòÎäî |‚ö° Î≤àÏ©çÏù¥Îäî |üèÜ Ìô©Í∏àÏÉâ |üíé Îã§Ïù¥ÏïÑÎ™¨ÎìúÏÉâ |üåà Î¨¥ÏßÄÍ∞ØÎπõ |üåà/g, '');
            
            // Í∏∞Ï°¥ ÏàòÏãùÏñ¥Îì§ Ï†úÍ±∞
            const existingPrefixes = ['ÏÑ∏Ìò∏Î°úÎ¶¨', 'ÏÑ∏Ìò∏Í≤åÏù¥', 'ÏÑ∏Ìò∏ÌçºÎ¶¨', 'ÏîπÎçïÏÑ∏Ìò∏', 'ÎßàÏ£†Ïù¥Ïä§Ìä∏ÏÑ∏Ìò∏', 
                                   'ÌèâÎ≤îÌïúÏÑ∏Ìò∏', 'TSÏÑ∏Ìò∏', 'ÏáºÌÉÄÏÑ∏Ìò∏', 'ÏóêÍ≤êÏÑ∏Ìò∏', 'ÎãàÍ±∞ÏÑ∏Ìò∏'];
            
            for (const prefix of existingPrefixes) {
                if (cleanName.startsWith(prefix)) {
                    cleanName = cleanName.substring(prefix.length);
                    break;
                }
            }

            // ÏÑ∏Ìò∏Î•òÎÇò ÍΩùÏù¥Î©¥ ÏÑ§Î™Ö ÏóÜÏùå
            for (const sehoType of sehoTypes) {
                if (cleanName.includes(sehoType)) {
                    return null;
                }
            }

            // ÏÉÅÏ†ê ÏïÑÏù¥ÌÖú ÏÑ§Î™Ö
            const descriptions = {
                'ÌñâÏö¥Ìè¨ÏÖò‚Ö†': 'ÍΩù ÌôïÎ•† 5% Í∞êÏÜå',
                'ÌñâÏö¥Ìè¨ÏÖò‚Ö°': 'ÍΩù ÌôïÎ•† 10% Í∞êÏÜå',
                'ÌñâÏö¥Ìè¨ÏÖò‚Ö¢': 'ÍΩù ÌôïÎ•† 20% Í∞êÏÜå',
                'ÏÜçÎèÑÌè¨ÏÖò‚Ö†': 'ÎΩëÍ∏∞ ÏÜçÎèÑ 7.5% Ï¶ùÍ∞Ä',
                'ÏÜçÎèÑÌè¨ÏÖò‚Ö°': 'ÎΩëÍ∏∞ ÏÜçÎèÑ 15% Ï¶ùÍ∞Ä',
                'ÏÜçÎèÑÌè¨ÏÖò‚Ö¢': 'ÎΩëÍ∏∞ ÏÜçÎèÑ 30% Ï¶ùÍ∞Ä',
                '1339Ìè¨ÏÖò': 'ÎΩëÍ∏∞ ÏÜçÎèÑ 15-50% Ï¶ùÍ∞Ä',
                'Ï£ºÎßê': 'Îã§Ïùå 75Ìöå ÎΩëÍ∏∞ Ïø®ÌÉÄÏûÑ ÏÇ≠Ï†ú',
                'Î≥¥Ï°∞Î∞∞ÌÑ∞Î¶¨': 'ÏÉÅÏ†ê Ï¶âÏãú Í∞±Ïã†',
                'Îü≠ÌÇ§Î∞ïÏä§': 'ÌñâÏö¥Ìè¨ÏÖò‚Ö°, ÏÜçÎèÑÌè¨ÏÖò‚Ö° ÎûúÎç§ ÌöçÎìù',
                'Ïö©ÏÇ¨Ïùò Ïã¨Ìåê': 'Îã§Ïùå ÎΩëÍ∏∞ ÌäπÎ≥ÑÌö®Í≥º ÌôïÎ•† 20%',
                'ÏÉ§Ïò§ÎØ∏Ìè∞': 'ÍΩù ÌôïÎ•† 8% Í∞êÏÜå, 10Ï¥àÎßàÎã§ 8% ÌôïÎ•†Î°ú Ï†úÍ±∞',
                'ÏãúÏõêÌïú Î¨º': 'ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ÎΩëÍ∏∞ÏÜçÎèÑ +1% (Î¨¥Ï†úÌïú Ï§ëÏ≤©)'
            };

            // ÏÉÅÏ†ê ÏïÑÏù¥ÌÖú ÏÑ§Î™Ö Ï∞æÍ∏∞
            for (const [key, description] of Object.entries(descriptions)) {
                if (cleanName.includes(key)) {
                    return description;
                }
            }

            return null;
        }
        function injectEnhanceControls(container, index) {
            const item = storage[index];
            if (!item) return;
            const level = Math.max(0, item.enhanceLevel || 0);
            const info = document.createElement('div');
            info.className = 'enhance-info';
            info.textContent = getEnhanceInfoText(level);
            container.appendChild(info);

            const back = document.createElement('div');
            back.className = 'action-btn action-back';
            back.textContent = 'Îí§Î°úÍ∞ÄÍ∏∞';
            back.onclick = (e) => {
                container.classList.remove('selected');
                if (info) info.remove();
                back.remove();
                if (upg) upg.remove();
                e.stopPropagation();
            };
            container.appendChild(back);

            const upg = document.createElement('div');
            upg.className = 'action-btn action-upgrade';
            upg.textContent = 'Í∞ïÌôîÌïòÍ∏∞';
            if (level >= 5) {
                upg.style.opacity = '0.5';
                upg.style.cursor = 'not-allowed';
            } else {
                upg.onclick = (e) => {
                    performUpgrade(index);
                    e.stopPropagation();
                };
            }
            container.appendChild(upg);
        }
        function performUpgrade(index) {
            const item = storage[index];
            if (!item) return;
            
            // Í∞ïÌôî Ïø®ÌÉÄÏûÑ ÌôïÏù∏
            const now = Date.now();
             if (now - lastEnhancementTime < enhancementCooldown) {
                const remainingTime = Math.ceil((enhancementCooldown - (now - lastEnhancementTime)) / 1000);
                alert(`Í∞ïÌôî Ïø®ÌÉÄÏûÑ Ï§ëÏûÖÎãàÎã§. ${remainingTime}Ï¥à ÌõÑÏóê Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.`);
                return;
             }
            
            // Í∞ïÌôî ÏãúÏûë ÏÇ¨Ïö¥Îìú
            playEnhanceStartSound();
            
            let level = Math.max(0, item.enhanceLevel || 0);
            if (level >= 5) return;
            
            // Ïú†Î¨º Ìö®Í≥ºÎ•º Ìè¨Ìï®Ìïú Í∞ïÌôî ÌôïÎ•† Í≥ÑÏÇ∞
            const rates = calculateEnhanceRates(level);
            const success = rates.success;
            const destroy = rates.destroy;
            const r = Math.random();
            if (r < success) {
                level += 1;
                
                // Í∞ïÌôî ÏÑ±Í≥µ Ïãú - Í∞ôÏùÄ Í∞ïÌôî Îã®Í≥Ñ ÏïÑÏù¥ÌÖúÏù¥ ÏûàÏúºÎ©¥ Ìï©ÏπòÍ∏∞
                const now = new Date();
                const timeString = now.toLocaleTimeString('ko-KR');
                
                // Í∞ôÏùÄ Í∞ïÌôî Îã®Í≥ÑÏùò ÏïÑÏù¥ÌÖúÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                const existingEnhancedItem = storage.find(storageItem => 
                    storageItem.name === item.name && 
                    storageItem.effectType === item.effectType &&
                    (storageItem.enhanceLevel || 0) === level
                );
                
                if (existingEnhancedItem) {
                    // Í∞ôÏùÄ Í∞ïÌôî Îã®Í≥ÑÍ∞Ä ÏûàÏúºÎ©¥ Í∞úÏàò Ï¶ùÍ∞Ä
                    existingEnhancedItem.count = (existingEnhancedItem.count || 1) + 1;
                    existingEnhancedItem.time = timeString;
                    existingEnhancedItem.date = now.toLocaleDateString('ko-KR');
                } else {
                    // ÏÉàÎ°úÏö¥ Í∞ïÌôî Îã®Í≥Ñ ÏïÑÏù¥ÌÖú Ï∂îÍ∞Ä
                    const newItem = {
                        name: item.name,
                        time: timeString,
                        date: now.toLocaleDateString('ko-KR'),
                        effectType: item.effectType,
                        baseProbability: item.baseProbability,
                        realProbability: item.realProbability,
                        count: 1,
                        enhanceLevel: level
                    };
                    storage.push(newItem);
                }
                
                // Í∏∞Ï°¥ ÏïÑÏù¥ÌÖú Í∞úÏàò Í∞êÏÜå ÎòêÎäî Ï†úÍ±∞
                if ((item.count || 1) > 1) {
                    item.count -= 1;
                } else {
                    storage.splice(index, 1);
                }
                
                // Í∞ïÌôî ÏÑ±Í≥µ ÏÇ¨Ïö¥Îìú (5Í∞ïÏùÄ ÌäπÎ≥ÑÌïú ÏÇ¨Ïö¥Îìú)
                if (level === 5) {
                    setTimeout(() => playMaxEnhanceSuccessSound(), 200);
                } else {
                    setTimeout(() => playEnhanceSuccessSound(), 200);
                }
            } else {
                // Ïã§Ìå®
                const r2 = Math.random();
                if (r2 < destroy) {
                    // ÌååÍ¥¥: ÎèôÏùº Ìï≠Î™© ÏàòÎüâ Í∞êÏÜå ÎòêÎäî Ï†úÍ±∞
                    if ((item.count || 1) > 1) {
                        item.count -= 1;
                    } else {
                        storage.splice(index, 1);
                    }
                    // ÌååÍ¥¥ ÏÇ¨Ïö¥Îìú
                    setTimeout(() => playEnhanceDestroySound(), 200);
                } else {
                    // ÌïòÎùΩ: 0 ÎØ∏ÎßåÏúºÎ°úÎäî ÎÇ¥Î†§Í∞ÄÏßÄ ÏïäÏùå
                    const newLevel = Math.max(0, level - 1);
                    
                    if (newLevel !== level) {
                        // Í∞ïÌôî Îã®Í≥ÑÍ∞Ä Î∞îÎÄåÎäî Í≤ΩÏö∞
                        const now = new Date();
                        const timeString = now.toLocaleTimeString('ko-KR');
                        
                        // Í∞ôÏùÄ Í∞ïÌôî Îã®Í≥ÑÏùò ÏïÑÏù¥ÌÖúÏù¥ ÏûàÎäîÏßÄ ÌôïÏù∏
                        const existingItem = storage.find(storageItem => 
                            storageItem.name === item.name && 
                            storageItem.effectType === item.effectType &&
                            (storageItem.enhanceLevel || 0) === newLevel
                        );
                        
                        if (existingItem) {
                            // Í∞ôÏùÄ Í∞ïÌôî Îã®Í≥ÑÍ∞Ä ÏûàÏúºÎ©¥ Í∞úÏàò Ï¶ùÍ∞Ä
                            existingItem.count = (existingItem.count || 1) + 1;
                            existingItem.time = timeString;
                            existingItem.date = now.toLocaleDateString('ko-KR');
                        } else {
                            // ÏÉàÎ°úÏö¥ Í∞ïÌôî Îã®Í≥Ñ ÏïÑÏù¥ÌÖú Ï∂îÍ∞Ä
                            const newItem = {
                                name: item.name,
                                time: timeString,
                                date: now.toLocaleDateString('ko-KR'),
                                effectType: item.effectType,
                                baseProbability: item.baseProbability,
                                realProbability: item.realProbability,
                                count: 1,
                                enhanceLevel: newLevel
                            };
                            storage.push(newItem);
                        }
                        
                        // Í∏∞Ï°¥ ÏïÑÏù¥ÌÖú Í∞úÏàò Í∞êÏÜå ÎòêÎäî Ï†úÍ±∞
                        if ((item.count || 1) > 1) {
                            item.count -= 1;
                        } else {
                            storage.splice(index, 1);
                        }
                    }
                    
                    // Ïã§Ìå® ÏÇ¨Ïö¥Îìú
                    setTimeout(() => playEnhanceFailSound(), 200);
                }
            }
            
            // Í∞ïÌôî ÏãúÍ∞Ñ Í∏∞Î°ù
            lastEnhancementTime = now;
            
            // Î™®Îì† Í∞ïÌôî Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            disableAllEnhanceButtons();
            
            // 1Ï¥à ÌõÑ Î≤ÑÌäº Îã§Ïãú ÌôúÏÑ±Ìôî
            setTimeout(() => {
                enableAllEnhanceButtons();
            }, enhancementCooldown);
            
            saveState();
            updateStorageDisplay();
        }

        // Î™®Îì† Í∞ïÌôî Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
        function disableAllEnhanceButtons() {
            const buttons = document.querySelectorAll('.action-upgrade');
            buttons.forEach(button => {
                button.disabled = true;
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
                button.style.backgroundColor = '#adb5bd';
                button.textContent = 'Í∞ïÌôîÏ§ë';
            });
        }

        // Î™®Îì† Í∞ïÌôî Î≤ÑÌäº ÌôúÏÑ±Ìôî
        function enableAllEnhanceButtons() {
            const buttons = document.querySelectorAll('.action-upgrade');
            buttons.forEach(button => {
                const itemDiv = button.closest('.storage-item');
                if (!itemDiv) return;
                
                const idxAttr = itemDiv.getAttribute('data-index');
                if (idxAttr == null) return;
                const idx = parseInt(idxAttr, 10);
                const item = storage[idx];
                
                if (item && (item.enhanceLevel || 0) < 5) {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                    button.style.backgroundColor = '#28a745';
                    button.textContent = 'Í∞ïÌôîÌïòÍ∏∞';
                }
            });
        }

        function switchOverlayTab(e, overlayId) {
            const overlay = document.getElementById(overlayId);
            overlay.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');
            const target = e.currentTarget.getAttribute('data-target');
            overlay.querySelectorAll('.panel-content').forEach(p => p.style.display = 'none');
            overlay.querySelector('#' + target).style.display = 'block';
            if (target.endsWith('Stor')) updateStorageDisplay();
            if (target === 'artiColl') initArtifactCollection();
        }

        function openOverlay(which) {
            if (which === 'seho') {
                document.getElementById('sehoOverlay').classList.add('open');
                renderOverlayProbability();
                updateStorageDisplay();
            } else if (which === 'arti') {
                document.getElementById('artiOverlay').classList.add('open');
                initArtifactCollection();
                updateStorageDisplay();
            }
        }

        function closeOverlays() {
            const s = document.getElementById('sehoOverlay');
            const a = document.getElementById('artiOverlay');
            if (s) s.classList.remove('open');
            if (a) a.classList.remove('open');
        }
        function renderOverlayProbability() {
            const probHost = document.querySelector('#sehoOverlay #sehoProb');
            if (!probHost) return;
            const pool = getEffectiveParticipants();
            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            const sortedParticipants = [...pool].sort((a, b) => b.weight - a.weight);
            let listHTML = `
                <div class="probability-list" id="probListOverlay">
            `;
            sortedParticipants.forEach(participant => {
                const probabilityNum = (participant.weight / totalWeight) * 100;
                const probability = probabilityNum.toFixed(2);
                    const luckBuff = activeBuffs.find(b => b.type === 'luck' && b.endTime > Date.now());
                let displayValue = `${probability}%`;
                if (participant.name === 'ÍΩù' && luckBuff) {
                        const reductionPercent = [5, 10, 20][luckBuff.level - 1];
                    displayValue = `${probability}% (-${reductionPercent}%)`;
                }

                const isMiss = participant.name === 'ÍΩù';
                let detailHTML = '';

                if (!isMiss) {
                const specialEffectBonus = getSpecialEffectBonus(participant.name);
                const rainbowBonus = getRainbowBonus();
                
                    const rainbowProbability = (probabilityNum * 0.0002 * (1 + rainbowBonus)).toFixed(5);
                    const diamondProbability = (probabilityNum * 0.002 * (1 + specialEffectBonus)).toFixed(4);
                    const goldenProbability = (probabilityNum * 0.01 * (1 + specialEffectBonus)).toFixed(3);
                    const shiningProbability = (probabilityNum * 0.2 * (1 + specialEffectBonus)).toFixed(2);
                    const sparklingProbability = (probabilityNum * 0.05 * (1 + specialEffectBonus)).toFixed(3);
                    const rainbowDiff = (rainbowProbability - (probabilityNum * 0.0002)).toFixed(5);
                    const diamondDiff = (diamondProbability - (probabilityNum * 0.002)).toFixed(4);
                    const goldenDiff = (goldenProbability - (probabilityNum * 0.01)).toFixed(3);
                    const shiningDiff = (shiningProbability - (probabilityNum * 0.2)).toFixed(2);
                    const sparklingDiff = (sparklingProbability - (probabilityNum * 0.05)).toFixed(3);

                    detailHTML = `
                        <div class="shining-info">
                            <div class="effect-title">
                                <span>‚ú®</span>
                                <span>ÌäπÎ≥Ñ Ìö®Í≥º ÌôïÎ•†</span>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">‚ú® ÎπõÎÇòÎäî ${participant.name}: ${shiningProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(shiningDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 20% ÌôïÎ•†)</small>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">‚ö° Î≤àÏ©çÏù¥Îäî ${participant.name}: ${sparklingProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(sparklingDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 5% ÌôïÎ•†)</small>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">üèÜ Ìô©Í∏àÏÉâ ${participant.name}: ${goldenProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(goldenDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 1% ÌôïÎ•†)</small>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">üíé Îã§Ïù¥ÏïÑÎ™¨ÎìúÏÉâ ${participant.name}: ${diamondProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(diamondDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 0.2% ÌôïÎ•†)</small>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">üåà Î¨¥ÏßÄÍ∞ØÎπõ ${participant.name}: ${rainbowProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(rainbowDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 0.02% ÌôïÎ•†)</small>
                            </div>
                        </div>
                    `;
                }
                
                listHTML += `
                    <div class="probability-item${isMiss ? ' no-hover' : ''}">
                        <div class="probability-layout">
                            <span class="probability-label">
                        <span class="participant-name">${participant.name}</span>
                                <span class="probability-value">${displayValue}</span>
                            </span>
                        </div>
                        ${detailHTML}
                    </div>
                `;
            });
            listHTML += `
                </div>`;
            probHost.innerHTML = listHTML;
            attachProbabilityToggle('probListOverlay');
        }

        // ÏÑ∏Ìò∏ Ïù∏ÎùºÏù∏ Ìå®ÎÑê Ï¥àÍ∏∞Ìôî Î∞è ÌÜ†Í∏Ä/ÌÉ≠
        function initInlinePanels() {
            // Ï≤òÏùå Ïó¥Î¶¥ Îïå ÌòÑÏû¨ ÌôïÎ•†ÌëúÎ•º Ïù∏ÎùºÏù∏ÏóêÎèÑ Î†åÎçî
            renderInlineProbability();
        }

        function toggleSehoPanel() {
            const panel = document.getElementById('sehoExtraPanel');
            panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
            if (panel.style.display === 'block') {
                // Ïó¥Î¶¥ Îïå ÏµúÏã† Îç∞Ïù¥ÌÑ∞Î°ú Í∞±Ïã†
                renderInlineProbability();
                updateStorageDisplay();
            }
        }

        function switchSehoTab(e) {
            document.querySelectorAll('#sehoExtraPanel .tab-button').forEach(btn => btn.classList.remove('active'));
            e.currentTarget.classList.add('active');
            const target = e.currentTarget.getAttribute('data-target');
            const prob = document.getElementById('probabilityContentInline');
            const stor = document.getElementById('storageListInline');
            if (target === 'probabilityContentInline') {
                prob.style.display = 'block';
                stor.style.display = 'none';
                renderInlineProbability();
            } else {
                prob.style.display = 'none';
                stor.style.display = 'block';
                updateStorageDisplay();
            }
        }
        function renderInlineProbability() {
            const inline = document.getElementById('probabilityContentInline');
            if (!inline) return;
            // Í∏∞Ï°¥ updateProbabilityTable Î°úÏßÅÏùÑ Ïû¨ÏÇ¨Ïö©ÌïòÏó¨ HTML ÏÉùÏÑ±
            const pool = getEffectiveParticipants();
            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            const sortedParticipants = [...pool].sort((a, b) => b.weight - a.weight);
            let listHTML = `
                <div class="probability-list" id="probListInline">
            `;
            sortedParticipants.forEach(participant => {
                const probNum = (participant.weight / totalWeight) * 100;
                const probability = formatFiniteOrEllipsis(probNum);
                    const luckBuff = activeBuffs.find(b => b.type === 'luck' && b.endTime > Date.now());
                let displayValue = `${probability}%`;
                if (participant.name === 'ÍΩù' && luckBuff) {
                        const reductionPercent = [5, 10, 20][luckBuff.level - 1];
                    displayValue = `${probability}% (-${reductionPercent}%)`;
                }

                const isMiss = participant.name === 'ÍΩù';
                let detailHTML = '';

                if (!isMiss) {
                const specialEffectBonus = getSpecialEffectBonus(participant.name);
                const rainbowBonus = getRainbowBonus();
                
                const rainbowProbability = formatFiniteOrEllipsis(probNum * 0.0002 * (1 + rainbowBonus));
                const diamondProbability = formatFiniteOrEllipsis(probNum * 0.002 * (1 + specialEffectBonus));
                const goldenProbability = formatFiniteOrEllipsis(probNum * 0.01 * (1 + specialEffectBonus));
                const shiningProbability = formatFiniteOrEllipsis(probNum * 0.2 * (1 + specialEffectBonus));
                const sparklingProbability = formatFiniteOrEllipsis(probNum * 0.05 * (1 + specialEffectBonus));
                    const shiningDiff = formatFiniteOrEllipsis(probNum * 0.2 * specialEffectBonus);
                    const sparklingDiff = formatFiniteOrEllipsis(probNum * 0.05 * specialEffectBonus);
                    const goldenDiff = formatFiniteOrEllipsis(probNum * 0.01 * specialEffectBonus);
                    const diamondDiff = formatFiniteOrEllipsis(probNum * 0.002 * specialEffectBonus);
                    const rainbowDiff = formatFiniteOrEllipsis(probNum * 0.0002 * rainbowBonus);
                
                    detailHTML = `
                        <div class="shining-info">
                            <div class="effect-title">
                                <span>‚ú®</span>
                                <span>ÌäπÎ≥Ñ Ìö®Í≥º ÌôïÎ•†</span>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">‚ú® ÎπõÎÇòÎäî ${participant.name}: ${shiningProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(shiningDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 20% ÌôïÎ•†)</small>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">‚ö° Î≤àÏ©çÏù¥Îäî ${participant.name}: ${sparklingProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(sparklingDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 5% ÌôïÎ•†)</small>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">üèÜ Ìô©Í∏àÏÉâ ${participant.name}: ${goldenProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(goldenDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 1% ÌôïÎ•†)</small>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">üíé Îã§Ïù¥ÏïÑÎ™¨ÎìúÏÉâ ${participant.name}: ${diamondProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(diamondDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 0.2% ÌôïÎ•†)</small>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">üåà Î¨¥ÏßÄÍ∞ØÎπõ ${participant.name}: ${rainbowProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(rainbowDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 0.02% ÌôïÎ•†)</small>
                            </div>
                        </div>
                    `;
                }
                
                listHTML += `
                    <div class="probability-item${isMiss ? ' no-hover' : ''}">
                        <div class="probability-layout">
                            <span class="probability-label">
                        <span class="participant-name">${participant.name}</span>
                                <span class="probability-value">${displayValue}</span>
                            </span>
                        </div>
                        ${detailHTML}
                    </div>
                `;
            });
            listHTML += `
                </div>`;
            inline.innerHTML = listHTML;
            attachProbabilityToggle('probListInline');
        }

        // Ïú†Î¨º Ïª¨Î†âÏÖò Í∑∏Î¶¨Îìú Ï¥àÍ∏∞Ìôî
        function initArtifactCarousel() {
            buildArtifactGrid('artifactGrid');
            buildArtifactGrid('artifactGridOverlay');
            updateArtifactDisplay();
        }

        function initArtifactCollection() {
            buildArtifactGrid('artifactGridOverlay');
            updateArtifactDisplay();
        }
        // Ïú†Î¨º ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
        function updateArtifactDisplay() {
            const targetGrids = ['artifactGrid', 'artifactGridOverlay']
                .map(id => document.getElementById(id))
                .filter(Boolean);

            targetGrids.forEach(grid => {
                Array.from(grid.children).forEach(card => {
                    const artifactName = card.dataset.artifactName;
                    if (!artifactName) return;

                    const levelBadge = card.querySelector('.artifact-level-badge');
                    const statusEl = card.querySelector('.artifact-status');
                    const nameEl = card.querySelector('.artifact-name');
                    const backHeading = card.querySelector('.artifact-back-heading');
                    const backLevel = card.querySelector('.artifact-back-level');
                    const backDesc = card.querySelector('.artifact-back-desc');

                    if (nameEl) nameEl.textContent = artifactName;
                    if (backHeading) backHeading.textContent = artifactName;

                    card.classList.remove('owned', 'locked', 'level-1', 'level-2', 'level-3', 'level-4', 'level-5', 'flipped');

                const ownedArtifact = artifactStorage.find(item => item.name === artifactName);
                if (ownedArtifact) {
                        const level = ownedArtifact.level || 1;
                        const levelClass = `level-${Math.min(level, 5)}`;
                        card.classList.add('owned', levelClass);
                        if (levelBadge) levelBadge.textContent = `Lv. ${level}`;
                        if (statusEl) {
                            statusEl.textContent = 'Î≥¥Ïú† Ï§ë';
                            statusEl.setAttribute('data-status', 'owned');
                        }
                        const description = getArtifactStats(artifactName, level);
                        if (backLevel) backLevel.textContent = `Î†àÎ≤® ${level}`;
                        if (backDesc) backDesc.textContent = description;
                } else {
                    card.classList.add('locked');
                        if (levelBadge) levelBadge.textContent = 'Lv. 0';
                        if (statusEl) {
                            statusEl.textContent = 'ÎØ∏ÌöçÎìù';
                            statusEl.setAttribute('data-status', 'locked');
                        }
                        if (backLevel) backLevel.textContent = 'Î†àÎ≤® 0';
                        if (backDesc) backDesc.textContent = getArtifactStats(artifactName, 0);
                    }
                });
            });
        }
        const ARTIFACT_VALUES = {
            BUJUK_SPECIAL_BONUS: [0, 0.10, 0.25, 0.45, 0.70, 1.00],
            RELIC_COOLDOWN_REDUCTION: [0, 0.05, 0.10, 0.15, 0.20, 0.30],
            RAINBOW_BONUS: [0, 0.50, 1.00, 1.50, 2.00, 3.00],
            HAMMER_DESTRUCTION_REDUCTION: [0, 0.0025, 0.005, 0.01, 0.02, 0.035],
            TRUMP_GUARANTEE_INTERVAL: [0, 30, 25, 20, 15, 7],
            GOLDEN_STATUE_COINS: [0, 5, 10, 20, 30, 50],
            BUNDLE_MINUTE_REDUCTION: [0, 1, 2, 3, 4, 5],
            POTION_DURATION_BONUS: [0, 10, 20, 30, 40, 60]
        };

        // Ïú†Î¨º Îä•Î†•Ïπò Î∞òÌôò
        function getArtifactStats(artifactName, level) {
            const baseStats = {
                'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Î∂ÄÏ†Å': 'ÌäπÎ≥ÑÌö®Í≥º ÌôïÎ•† Ï¶ùÍ∞Ä',
                'ÏÑ∏Ìò∏ÌçºÎ¶¨Ïùò Î∂ÄÏ†Å': 'ÌäπÎ≥ÑÌö®Í≥º ÌôïÎ•† Ï¶ùÍ∞Ä',
                'ÏÑ∏Ìò∏Í≤åÏù¥Ïùò Î∂ÄÏ†Å': 'ÌäπÎ≥ÑÌö®Í≥º ÌôïÎ•† Ï¶ùÍ∞Ä',
                'ÎßàÏ£†Ïù¥Ïä§Ìä∏ÏÑ∏Ìò∏Ïùò Î∂ÄÏ†Å': 'ÌäπÎ≥ÑÌö®Í≥º ÌôïÎ•† Ï¶ùÍ∞Ä',
                'ÏîπÎçïÏÑ∏Ìò∏Ïùò Î∂ÄÏ†Å': 'ÌäπÎ≥ÑÌö®Í≥º ÌôïÎ•† Ï¶ùÍ∞Ä',
                'TSÏÑ∏Ìò∏Ïùò Î∂ÄÏ†Å': 'ÌäπÎ≥ÑÌö®Í≥º ÌôïÎ•† Ï¶ùÍ∞Ä',
                'ÏáºÌÉÄÏÑ∏Ìò∏Ïùò Î∂ÄÏ†Å': 'ÌäπÎ≥ÑÌö®Í≥º ÌôïÎ•† Ï¶ùÍ∞Ä',
                'ÏóêÍ≤êÏÑ∏Ìò∏Ïùò Î∂ÄÏ†Å': 'ÌäπÎ≥ÑÌö®Í≥º ÌôïÎ•† Ï¶ùÍ∞Ä',
                'ÎãàÍ±∞ÏÑ∏Ìò∏Ïùò Î∂ÄÏ†Å': 'ÌäπÎ≥ÑÌö®Í≥º ÌôïÎ•† Ï¶ùÍ∞Ä',
                'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò ÏãúÍ∞ÑÍ∞ÄÏÜçÍ∏∞': 'ÎΩëÍ∏∞ ÏÜçÎèÑ Ï¶ùÍ∞Ä',
                'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò 7Î™©Í±∏Ïù¥': 'ÍΩù ÌôïÎ•† Í∞êÏÜå',
                'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ïú†Î¨ºÏÑù': 'Ïú†Î¨º ÎΩëÍ∏∞ ÎåÄÍ∏∞ÏãúÍ∞Ñ Í∞êÏÜå',
                'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Î¨¥ÏßÄÍ∞ØÎπõ Î≥¥ÏÑù': 'Î¨¥ÏßÄÍ∞ØÎπõ ÌôïÎ•† Ï¶ùÍ∞Ä',
                'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ïã†ÏÑ±Ìïú ÎßùÏπò': 'Í∞ïÌôî ÌååÍ¥¥ÌôïÎ•† Í∞êÏÜå',
                'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ìä∏ÎüºÌîÑÏπ¥Îìú': 'ÏÑ∏Ìò∏ ÌäπÎ≥ÑÌö®Í≥º Î≥¥Ïû•',
                'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ìô©Í∏àÎèôÏÉÅ': '10Ìöå ÎΩëÍ∏∞Îãπ ÏÑ∏Ìò∏ÏΩîÏù∏ ÏßÄÍ∏â',
                'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Î¥áÏßê': 'ÏÉÅÏ†ê Í∞±Ïã† ÏãúÍ∞Ñ Îã®Ï∂ï',
                'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Î¨ºÏïΩ Ï†úÏ°∞Ïà†Ï±Ö': 'ÌñâÏö¥/ÏÜçÎèÑ Ìè¨ÏÖò ÏßÄÏÜçÏãúÍ∞Ñ Ï¶ùÍ∞Ä'
            };
            
            const baseStat = baseStats[artifactName] || 'Ïïå Ïàò ÏóÜÎäî Îä•Î†•';
            
            if (level === 0) {
                return 'ÌöçÎìùÌïòÏßÄ ÏïäÏùå';
            }
            
            if (artifactName.includes('Î∂ÄÏ†Å')) {
                const bonus = ARTIFACT_VALUES.BUJUK_SPECIAL_BONUS[Math.min(level, 5)];
                return `${baseStat} (${Math.round(bonus * 100)}% Ï¶ùÍ∞Ä)`;
            }

            switch (artifactName) {
                case 'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ïú†Î¨ºÏÑù': {
                    const reduction = ARTIFACT_VALUES.RELIC_COOLDOWN_REDUCTION[Math.min(level, 5)];
                    return `${baseStat} (${Math.round(reduction * 100)}% Í∞êÏÜå)`;
                }
                case 'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Î¨¥ÏßÄÍ∞ØÎπõ Î≥¥ÏÑù': {
                    const bonus = ARTIFACT_VALUES.RAINBOW_BONUS[Math.min(level, 5)];
                    return `${baseStat} (${Math.round(bonus * 100)}% Ï¶ùÍ∞Ä)`;
                }
                case 'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ïã†ÏÑ±Ìïú ÎßùÏπò': {
                    const reduction = ARTIFACT_VALUES.HAMMER_DESTRUCTION_REDUCTION[Math.min(level, 5)];
                    return `${baseStat} (${(reduction * 100).toFixed(2)}%p Í∞êÏÜå)`;
                }
                case 'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ìä∏ÎüºÌîÑÏπ¥Îìú': {
                    const interval = ARTIFACT_VALUES.TRUMP_GUARANTEE_INTERVAL[Math.min(level, 5)];
                    return `${baseStat} (${interval}ÌöåÎßàÎã§ ÌäπÎ≥ÑÌö®Í≥º Î≥¥Ïû•)`;
                }
                case 'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ìô©Í∏àÎèôÏÉÅ': {
                    const coins = ARTIFACT_VALUES.GOLDEN_STATUE_COINS[Math.min(level, 5)];
                    return `${baseStat} (10Ìöå ÎΩëÍ∏∞ÎßàÎã§ ${coins} ÏÑ∏Ìò∏ÏΩîÏù∏)`;
                }
                case 'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Î¥áÏßê': {
                    const minutes = ARTIFACT_VALUES.BUNDLE_MINUTE_REDUCTION[Math.min(level, 5)];
                    return `${baseStat} (${minutes}Î∂Ñ Í∞êÏÜå)`;
                }
                case 'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Î¨ºÏïΩ Ï†úÏ°∞Ïà†Ï±Ö': {
                    const seconds = ARTIFACT_VALUES.POTION_DURATION_BONUS[Math.min(level, 5)];
                    return `${baseStat} (+${seconds}Ï¥à)`;
                }
                case 'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò ÏãúÍ∞ÑÍ∞ÄÏÜçÍ∏∞': {
                    const map = { 1: 5, 2: 10, 3: 15, 4: 20, 5: 30 };
                    const reduction = map[Math.min(level, 5)] || 5;
                    return `${baseStat} (${reduction}% Í∞êÏÜå)`;
                }
                case 'ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò 7Î™©Í±∏Ïù¥': {
                    const map = { 1: 3, 2: 6, 3: 9, 4: 12, 5: 15 };
                    const reduction = map[Math.min(level, 5)] || 3;
                    return `${baseStat} (${reduction}%p Í∞êÏÜå)`;
                }
                default:
                    return `${baseStat} (Î†àÎ≤® ${level})`;
            }
        }

        function toggleArtifactPanel() {
            const panel = document.getElementById('artifactPanel');
            panel.style.display = (panel.style.display === 'none' || panel.style.display === '') ? 'block' : 'none';
        }

        function switchArtifactTab(e) {
            document.querySelectorAll('#artifactPanel .tab-button').forEach(btn => btn.classList.remove('active'));
            e.currentTarget.classList.add('active');
        }
        function startArtifactDraw() {
            // ÌÖåÏä§Ìä∏Ïö©ÏúºÎ°ú Ïø®Îã§Ïö¥ Ï†úÍ±∞
             const now = Date.now();
             const cooldownTime = getArtifactCooldown() * 1000; // Ïú†Î¨º Ìö®Í≥º Ï†ÅÏö©Îêú Ïø®Îã§Ïö¥
             
            // // Ïø®Îã§Ïö¥ ÌôïÏù∏
             if (now - lastArtifactDraw < cooldownTime) {
                 const remainingTime = Math.ceil((cooldownTime - (now - lastArtifactDraw)) / 1000);
                 const button = document.getElementById('artifactDrawButton');
                 if (button) {
                     button.disabled = true;
                     button.classList.add('disabled');
                     button.textContent = `ÎåÄÍ∏∞Ï§ë... (${remainingTime}s)`;
                 }
                 return;
             }
            
            const button = document.getElementById('artifactDrawButton');
            const resultEl = document.getElementById('artifactResult');
            const cooldownEl = document.getElementById('artifactCooldown');
            
            if (!button || !resultEl) return;
            
            // Î≤ÑÌäº ÎπÑÌôúÏÑ±Ìôî
            button.disabled = true;
            button.textContent = 'ÎΩëÎäî Ï§ë...';
            button.classList.add('disabled');
            
            // ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïú†Î¨º Î™©Î°ù Í∏∞Î∞ò (Ï†ÑÏ≤¥ Ïú†Î¨º ÌöçÎìù ÌôïÎ•† 50%, Ïú†Î¨º Í∞Ñ Í∑†Îì± Î∂ÑÎ∞∞)
            const availableArtifacts = getAvailableArtifacts();
            
            // Ïï†ÎãàÎ©îÏù¥ÏÖò
            resultEl.className = 'result-display reset';
            let count = 0;
            const interval = setInterval(() => {
                const randomIndex = Math.floor(Math.random() * Math.max(availableArtifacts.length, 1));
                resultEl.textContent = availableArtifacts.length > 0 ? availableArtifacts[randomIndex] : 'ÍΩù';
                count++;
                
                if (count > 20) {
                    clearInterval(interval);
                    
                    // ÏµúÏ¢Ö Í≤∞Í≥º
                    const random = Math.random();
                    let result = 'ÍΩù';
                    let resultClass = 'result-display reset';
                    
                    if (random < 0.5) { // 50% ÌôïÎ•†Î°ú Ïú†Î¨º ÌöçÎìù (Ïú†Î¨º Í∞Ñ Í∑†Îì±)
                        if (availableArtifacts.length > 0) {
                            const artifactIndex = Math.floor(Math.random() * availableArtifacts.length);
                            result = availableArtifacts[artifactIndex];
                            resultClass = 'result-display golden';
                            
                            // Ïú†Î¨º Ï†ÄÏû•ÏÜåÏóê Ï∂îÍ∞Ä
                            addToArtifactStorage(result);
                        } else {
                            result = 'ÍΩù';
                            resultClass = 'result-display reset';
                        }
                    }
                    
                    resultEl.textContent = result;
                    resultEl.className = resultClass;
                    
                 lastArtifactDraw = now;
                 startArtifactCooldown();
                 saveState();
                }
            }, 80);
        }
        
        // Ïú†Î¨º Ï†ÄÏû•ÏÜåÏóê Ï∂îÍ∞Ä
        function addToArtifactStorage(artifactName) {
            const existingArtifact = artifactStorage.find(item => item.name === artifactName);
            
            if (existingArtifact) {
                // Í∞ôÏùÄ Ïú†Î¨ºÏù¥ ÏûàÏúºÎ©¥ Î†àÎ≤® Ï¶ùÍ∞Ä (ÏµúÎåÄ 3Î†àÎ≤®)
                if (existingArtifact.level < 5) {
                    existingArtifact.level = Math.min(5, (existingArtifact.level || 1) + 1);
                    existingArtifact.count = (existingArtifact.count || 1) + 1;
                } else {
                    // Ïù¥ÎØ∏ ÏµúÎåÄ Î†àÎ≤®Ïù¥Î©¥ Í∞úÏàòÎßå Ï¶ùÍ∞Ä
                    existingArtifact.count = (existingArtifact.count || 1) + 1;
                }
            } else {
                // ÏÉàÎ°úÏö¥ Ïú†Î¨º Ï∂îÍ∞Ä
                artifactStorage.push({
                    name: artifactName,
                    level: 1,
                    count: 1
                });
            }
            
            // Ïú†Î¨º Ïª¨Î†âÏÖò ÏóÖÎç∞Ïù¥Ìä∏
            updateArtifactDisplay();
            // Ìä∏ÎüºÌîÑÏπ¥Îìú Ï†ïÎ≥¥ ÏóÖÎç∞Ïù¥Ìä∏
            updateTrumpCardInfo();
            updateGoldenStatueInfo();
            saveState();
        }
        
        // Ïú†Î¨º ÎΩëÍ∏∞ Ïø®Îã§Ïö¥ ÏãúÏûë
        function startArtifactCooldown() {
            const cooldownEl = document.getElementById('artifactCooldown');
            const button = document.getElementById('artifactDrawButton');
            if (!cooldownEl) return;
            
            let remainingTime = Math.ceil((getArtifactCooldown() * 1000 - (Date.now() - lastArtifactDraw)) / 1000);
            if (isNaN(remainingTime) || remainingTime < 0) remainingTime = getArtifactCooldown();
            
            const updateCooldown = () => {
                if (remainingTime > 0) {
                    cooldownEl.textContent = `Îã§Ïùå ÎΩëÍ∏∞ÍπåÏßÄ ${remainingTime}Ï¥à`;
                    if (button) {
                        button.disabled = true;
                        button.classList.add('disabled');
                        button.textContent = `ÎåÄÍ∏∞Ï§ë... (${remainingTime}s)`;
                    }
                    remainingTime--;
                    setTimeout(updateCooldown, 1000);
                } else {
                    cooldownEl.textContent = 'Ïú†Î¨º ÎΩëÍ∏∞ Ï§ÄÎπÑ ÏôÑÎ£å!';
                    if (button) {
                        button.disabled = false;
                        button.classList.remove('disabled');
                        button.textContent = 'üè∫ Ïú†Î¨º ÎΩëÍ∏∞';
                    }
                    saveState();
                }
            };
            
            updateCooldown();
        }

        // ÏÑ§Ï†ï Ìå®ÎÑê ÌÜ†Í∏Ä Î∞è ÌÜµÍ≥Ñ Í∞±Ïã†/Ï¥àÍ∏∞Ìôî
        function toggleSettingsPanel() {
            const panel = document.getElementById('settingsPanel');
            if (!panel) return;
            const isOpen = panel.classList.contains('open');
            panel.classList.toggle('open', !isOpen);
            panel.classList.toggle('collapsed', isOpen);
        }

        function updateSettingsStats() {
            const td = document.getElementById('statTotalDraws');
            const rr = document.getElementById('statRarest');
            if (td) td.textContent = totalDraws;
            if (rr) {
                if (!rarestItem) rr.textContent = '-';
                else {
                    rr.textContent = `${rarestItem.name} (${formatFiniteOrEllipsis(rarestItem.realProbabilityNum)}%)`;
                }
            }
            const pt = document.getElementById('statPlaytime');
            if (pt) {
                const currentTime = Date.now();
                const timeSinceLastActivity = currentTime - lastActivityTime;
                
                // 10Ï¥à Ïù¥ÏÉÅ ÌôúÎèôÏù¥ ÏóÜÏúºÎ©¥ ÌîåÎ†àÏù¥ÌÉÄÏûÑ Ïπ¥Ïö¥Ìä∏ Î©àÏ∂§
                if (timeSinceLastActivity < 10000) {
                    const totalPlaytime = currentTime - startTime - pausedTime;
                    pt.textContent = formatElapsedTime(totalPlaytime);
                }
            }
        }

        function sanitizeQuestState() {
            if (!questState || typeof questState !== 'object') {
                questState = getDefaultQuestState();
                return;
            }

            questState.lastDailyReset = typeof questState.lastDailyReset === 'number' ? questState.lastDailyReset : 0;
            questState.dailyQuests = Array.isArray(questState.dailyQuests) ? questState.dailyQuests : [];
            questState.eventQuests = Array.isArray(questState.eventQuests) ? questState.eventQuests : [];
            questState.activeTab = questState.activeTab === 'event' ? 'event' : 'daily';
            questState.playtimeAnchorMs = typeof questState.playtimeAnchorMs === 'number' ? questState.playtimeAnchorMs : 0;

            const normalizeQuest = (quest, prefix, defaultDesc) => {
                const definition = getDailyQuestDefinitionByKey(quest && quest.key);
                const current = quest && quest.progress && typeof quest.progress.current === 'number' ? quest.progress.current : 0;
                const target = quest && quest.progress && typeof quest.progress.target === 'number' && quest.progress.target > 0 ? quest.progress.target : 1;
                const clampedCurrent = Math.min(Math.max(current, 0), target);
                let rewards = Array.isArray(quest && quest.rewards) ? quest.rewards : [];
                if ((!rewards || rewards.length === 0) && definition && Array.isArray(definition.rewards)) {
                    rewards = definition.rewards;
                }

                const rewardMatchesDefinition = (candidate) => {
                    if (!candidate || !rewards || rewards.length === 0) return false;
                    return rewards.some(option => {
                        if (option.label && candidate.label && option.label === candidate.label) {
                            return true;
                        }
                        if (option.type !== candidate.type) return false;
                        if (option.type === 'coin') {
                            return Number(option.amount) === Number(candidate.amount);
                        }
                        if (option.type === 'item') {
                            return option.item === candidate.item && Number(option.quantity) === Number(candidate.quantity);
                        }
                        return false;
                    });
                };

                let selectedReward = quest && quest.selectedReward ? quest.selectedReward : null;
                if (!selectedReward || !selectedReward.label || !rewardMatchesDefinition(selectedReward)) {
                    selectedReward = randomizeQuestReward(rewards);
                }

                return {
                    id: quest && quest.id ? quest.id : generateQuestId(prefix),
                    key: quest && quest.key ? quest.key : (quest && quest.type ? `${quest.type}_${Math.random().toString(36).slice(2, 8)}` : `${prefix}_unknown`),
                    type: quest && quest.type ? quest.type : 'unknown',
                    title: quest && quest.title ? quest.title : (prefix === 'daily' ? 'ÎØ∏Ï†ï ÌÄòÏä§Ìä∏' : 'Ïù¥Î≤§Ìä∏ ÌÄòÏä§Ìä∏'),
                    description: quest && quest.description ? quest.description : defaultDesc,
                    rewards,
                    selectedReward,
                    reward: selectedReward && selectedReward.label ? selectedReward.label : (quest && quest.reward ? quest.reward : 'Î≥¥ÏÉÅ ÎØ∏Ï†ï'),
                    progress: {
                        current: clampedCurrent,
                        target
                    },
                    completed: Boolean(quest && quest.completed)
                };
            };

            questState.dailyQuests = questState.dailyQuests.map(quest =>
                normalizeQuest(quest, 'daily', 'Í≥ß ÏóÖÎç∞Ïù¥Ìä∏Îê† ÏòàÏ†ïÏûÖÎãàÎã§.')
            );

            questState.eventQuests = questState.eventQuests.map(quest =>
                normalizeQuest(quest, 'event', 'Ï∂îÌõÑ Í≥µÍ∞úÎê† Ïù¥Î≤§Ìä∏ ÌÄòÏä§Ìä∏ÏûÖÎãàÎã§.')
            );
        }
        function generateDailyQuests() {
            return sampleDailyQuestDefinitions(3).map(createDailyQuestFromDefinition);
        }
        function resetDailyQuests(anchorTime = Date.now()) {
            questState.lastDailyReset = anchorTime;
            questState.playtimeAnchorMs = getActivePlaytimeMs();
            questState.dailyQuests = generateDailyQuests();
            saveState();
            renderDailyQuests();
        }
        function ensureDailyQuests(forceUpdate = false) {
            sanitizeQuestState();
            const now = Date.now();

            if (!questState.lastDailyReset) {
                resetDailyQuests(now);
                return;
            }

            if (!questState.dailyQuests || questState.dailyQuests.length === 0 || questState.dailyQuests.every(quest => !quest.type || quest.type === 'unknown')) {
                resetDailyQuests(now);
                return;
            }

            const elapsed = now - questState.lastDailyReset;
            if (elapsed >= QUEST_RESET_INTERVAL || forceUpdate) {
                const cyclesPassed = Math.floor(elapsed / QUEST_RESET_INTERVAL);
                const newAnchor = questState.lastDailyReset + (cyclesPassed * QUEST_RESET_INTERVAL);
                resetDailyQuests(newAnchor > now ? now : newAnchor);
            }
        }
        function renderQuestContent() {
            renderDailyQuests();
            renderEventQuests();
            updateQuestTabButtons();
            updateQuestTimer();
        }
        function renderDailyQuests() {
            const host = document.getElementById('dailyQuestContent');
            if (!host) return;

            if (!questState.dailyQuests || questState.dailyQuests.length === 0) {
                host.innerHTML = renderQuestEmptyState('ÌòÑÏû¨ ÌëúÏãúÌï† ÏùºÏùº ÌÄòÏä§Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }

            const listHTML = questState.dailyQuests.map(quest => {
                const target = Math.max(quest.progress?.target || 1, 1);
                const current = Math.max(Math.min(quest.progress?.current || 0, target), 0);
                const percent = quest.completed ? 100 : Math.round((current / target) * 100);
                const clampedPercent = Math.min(Math.max(percent, 0), 100);
                const isCompleted = Boolean(quest.completed);
                const isClaimed = Boolean(quest.claimed);
                const isReady = isCompleted && !isClaimed;
                const rewardLabel = quest.selectedReward?.label || quest.reward || 'Î≥¥ÏÉÅ ÎØ∏Ï†ï';
                const progressInfo = isClaimed ? 'Î≥¥ÏÉÅ ÏàòÎ†π ÏôÑÎ£å' : (isCompleted ? 'ÏôÑÎ£å' : `${current} / ${target}`);
                const claimButton = isReady
                    ? `<button class="quest-claim-button" onclick="claimQuestReward('${quest.id}', 'daily')">Î≥¥ÏÉÅ Î∞õÍ∏∞</button>`
                    : '';
                const classes = ['quest-item'];
                if (isCompleted) classes.push('completed');
                if (isReady) classes.push('ready');
                if (isClaimed) classes.push('claimed');

                return `
                    <div class="${classes.join(' ')}" data-quest-id="${quest.id}">
                        <div class="quest-item-header">
                            <div class="quest-item-title">${quest.title}</div>
                            <div class="quest-item-reward">${rewardLabel}</div>
                        </div>
                        <div class="quest-item-desc">${quest.description}</div>
                        <div class="quest-progress">
                            <div class="quest-progress-bar" style="width: ${clampedPercent}%"></div>
                        </div>
                        <div class="quest-progress-info">${progressInfo}</div>
                        ${claimButton}
                    </div>
                `;
            }).join('');

            host.innerHTML = `<div class="quest-list">${listHTML}</div>`;
        }
        function renderEventQuests() {
            const host = document.getElementById('eventQuestContent');
            if (!host) return;

            if (!questState.eventQuests || questState.eventQuests.length === 0) {
                host.innerHTML = renderQuestEmptyState('ÏßÑÌñâ Ï§ëÏù∏ Ïù¥Î≤§Ìä∏ ÌÄòÏä§Ìä∏Í∞Ä ÏóÜÏäµÎãàÎã§.');
                return;
            }

            const listHTML = questState.eventQuests.map(quest => {
                const target = Math.max(quest.progress?.target || 1, 1);
                const current = Math.max(Math.min(quest.progress?.current || 0, target), 0);
                const percent = quest.completed ? 100 : Math.round((current / target) * 100);
                const clampedPercent = Math.min(Math.max(percent, 0), 100);
                const isCompleted = Boolean(quest.completed);
                const isClaimed = Boolean(quest.claimed);
                const isReady = isCompleted && !isClaimed;
                const rewardLabel = quest.selectedReward?.label || quest.reward || 'Î≥¥ÏÉÅ ÎØ∏Ï†ï';
                const progressInfo = isClaimed ? 'Î≥¥ÏÉÅ ÏàòÎ†π ÏôÑÎ£å' : (isCompleted ? 'ÏôÑÎ£å' : `${current} / ${target}`);
                const claimButton = isReady
                    ? `<button class="quest-claim-button" onclick="claimQuestReward('${quest.id}', 'event')">Î≥¥ÏÉÅ Î∞õÍ∏∞</button>`
                    : '';
                const classes = ['quest-item'];
                if (isCompleted) classes.push('completed');
                if (isReady) classes.push('ready');
                if (isClaimed) classes.push('claimed');

                return `
                    <div class="${classes.join(' ')}" data-quest-id="${quest.id}">
                        <div class="quest-item-header">
                            <div class="quest-item-title">${quest.title}</div>
                            <div class="quest-item-reward">${rewardLabel}</div>
                        </div>
                        <div class="quest-item-desc">${quest.description}</div>
                        <div class="quest-progress">
                            <div class="quest-progress-bar" style="width: ${clampedPercent}%"></div>
                        </div>
                        <div class="quest-progress-info">${progressInfo}</div>
                        ${claimButton}
                    </div>
                `;
            }).join('');

            host.innerHTML = `<div class="quest-list">${listHTML}</div>`;
        }

        function renderQuestEmptyState(message) {
            return `<div class="quest-empty-state">${message}</div>`;
        }

        function getActivePlaytimeMs() {
            const currentTime = Date.now();
            const accumulatedPaused = pausedTime || 0;
            const ongoingPaused = lastPauseTime && lastPauseTime > 0 ? (currentTime - lastPauseTime) : 0;
            return Math.max(0, currentTime - startTime - accumulatedPaused - ongoingPaused);
        }

        function commitQuestProgressChanges(changedDaily, changedEvent) {
            if (changedDaily) renderDailyQuests();
            if (changedEvent) renderEventQuests();
            if (changedDaily || changedEvent) saveState();
        }

        function incrementQuestProgress(type, amount = 1) {
            if (!type) return;
            sanitizeQuestState();

            let changedDaily = false;
            let changedEvent = false;

            const applyIncrement = (quest) => {
                if (quest.type !== type || quest.completed) return false;
                const target = Math.max(quest.progress.target || 1, 1);
                const current = Math.max(quest.progress.current || 0, 0);

                const newCurrent = Math.min(current + amount, target);
                if (newCurrent === current) return false;

                quest.progress.current = newCurrent;
                if (newCurrent >= target) quest.completed = true;
                return true;
            };

            questState.dailyQuests.forEach(quest => {
                if (applyIncrement(quest)) changedDaily = true;
            });

            questState.eventQuests.forEach(quest => {
                if (applyIncrement(quest)) changedEvent = true;
            });

            commitQuestProgressChanges(changedDaily, changedEvent);
        }

        function updatePlaytimeQuestProgress() {
            sanitizeQuestState();

            const activeMs = getActivePlaytimeMs();
            const anchor = typeof questState.playtimeAnchorMs === 'number' ? questState.playtimeAnchorMs : 0;
            const elapsedMinutes = Math.max(0, Math.floor((activeMs - anchor) / 60000));

            let changedDaily = false;
            let changedEvent = false;

            const applyElapsed = (quest) => {
                if (quest.type !== 'playtime' || quest.completed) return false;
                const target = Math.max(quest.progress.target || 1, 1);
                const newCurrent = Math.min(elapsedMinutes, target);
                if (newCurrent === quest.progress.current) return false;
                quest.progress.current = newCurrent;
                if (newCurrent >= target) quest.completed = true;
                return true;
            };

            questState.dailyQuests.forEach(quest => {
                if (applyElapsed(quest)) changedDaily = true;
            });

            questState.eventQuests.forEach(quest => {
                if (applyElapsed(quest)) changedEvent = true;
            });

            commitQuestProgressChanges(changedDaily, changedEvent);
        }

        function applyQuestReward(reward) {
            if (!reward || typeof reward !== 'object') return;
            if (reward.type === 'coin') {
                const amount = Math.max(0, Number(reward.amount) || 0);
                if (amount > 0) {
                    sehoCoin += amount;
                    updateCoinDisplay();
                }
            } else if (reward.type === 'item') {
                const itemName = reward.item;
                const quantity = Math.max(1, Number(reward.quantity) || 0);
                if (itemName && quantity > 0) {
                    // quest ÏÉÅÌÉúÎäî Ïù¥ÎØ∏ ÏóÖÎç∞Ïù¥Ìä∏ ÎêòÏóàÏúºÎØÄÎ°ú Ï∂îÍ∞Ä Ï†ÄÏû•Ïù¥ Ï§ëÎ≥µÎêòÏßÄ ÏïäÎèÑÎ°ù Ï£ºÏùò
                    addToItemStorage(itemName, quantity);
                }
            }
        }

        function claimQuestReward(questId, questType = 'daily') {
            sanitizeQuestState();
            const isEvent = questType === 'event';
            const questList = isEvent ? questState.eventQuests : questState.dailyQuests;
            if (!Array.isArray(questList)) return;

            const quest = questList.find(q => q.id === questId);
            if (!quest) return;
            if (!quest.completed) {
                alert('ÏïÑÏßÅ ÏôÑÎ£åÎêòÏßÄ ÏïäÏùÄ ÌÄòÏä§Ìä∏ÏûÖÎãàÎã§.');
                return;
            }
            if (quest.claimed) {
                alert('Ïù¥ÎØ∏ Î≥¥ÏÉÅÏùÑ ÏàòÎ†πÌïú ÌÄòÏä§Ìä∏ÏûÖÎãàÎã§.');
                return;
            }

            const reward = quest.selectedReward || randomizeQuestReward(quest.rewards);
            quest.selectedReward = reward;
            quest.reward = reward.label || quest.reward || 'Î≥¥ÏÉÅ ÎØ∏Ï†ï';
            quest.claimed = true;

            applyQuestReward(reward);
            const rewardLabel = reward.label ||
                (reward.type === 'coin'
                    ? `ÏÑ∏Ìò∏ÏΩîÏù∏ ${Number(reward.amount || 0).toLocaleString()}Í∞ú`
                    : `${reward.item || 'ÏïÑÏù¥ÌÖú'} ${reward.quantity || 0}Í∞ú`);

            alert(`üéÅ Î≥¥ÏÉÅÏùÑ ÏàòÎ†πÌñàÏäµÎãàÎã§!\n${rewardLabel}`);

            saveState();
            renderQuestContent();
        }

        function updateQuestTabButtons() {
            document.querySelectorAll('.quest-tab-button').forEach(button => {
                const tab = button.getAttribute('data-tab');
                button.classList.toggle('active', tab === questState.activeTab);
            });

            document.querySelectorAll('.quest-tab-content').forEach(content => {
                const isDaily = content.id === 'dailyQuestContent';
                const tabName = isDaily ? 'daily' : 'event';
                content.classList.toggle('active', tabName === questState.activeTab);
            });
        }

        function openQuest() {
            ensureDailyQuests();
            renderQuestContent();

            const overlay = document.getElementById('questOverlay');
            if (!overlay) return;
            overlay.classList.add('show');
            overlay.setAttribute('aria-hidden', 'false');

            switchQuestTab(questState.activeTab || 'daily');
        }

        function closeQuest() {
            const overlay = document.getElementById('questOverlay');
            if (!overlay) return;
            overlay.classList.remove('show');
            overlay.setAttribute('aria-hidden', 'true');
        }

        function switchQuestTab(tab) {
            const normalizedTab = tab === 'event' ? 'event' : 'daily';
            questState.activeTab = normalizedTab;
            renderQuestContent();
            saveState();
        }

        function updateQuestTimer() {
            const timerEl = document.getElementById('dailyQuestTimer');
            if (!timerEl) return;

            ensureDailyQuests();
            updatePlaytimeQuestProgress();

            if (questState.activeTab === 'event') {
                timerEl.textContent = '???';
                return;
            }

            const now = Date.now();
            const nextReset = (questState.lastDailyReset || now) + QUEST_RESET_INTERVAL;
            const remaining = nextReset - now;

            if (remaining <= 0) {
                ensureDailyQuests(true);
                timerEl.textContent = '00:00';
                return;
            }

            timerEl.textContent = formatQuestCountdown(remaining);
        }

        function startQuestTimer() {
            if (questTimerInterval) return;
            updateQuestTimer();
            questTimerInterval = setInterval(updateQuestTimer, 60 * 1000);
        }
        function stopQuestTimer() {
            if (!questTimerInterval) return;
            clearInterval(questTimerInterval);
            questTimerInterval = null;
        }

        function formatQuestCountdown(diffMs) {
            const safeDiff = Math.max(0, diffMs);
            const totalMinutes = Math.floor(safeDiff / 60000);
            const hours = Math.floor(totalMinutes / 60);
            const minutes = totalMinutes % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}`;
        }

        function initQuestSystem() {
            sanitizeQuestState();
            ensureDailyQuests();
            renderQuestContent();
            startQuestTimer();
        }

        function getQuestStateSnapshot() {
            sanitizeQuestState();
            return {
                lastDailyReset: questState.lastDailyReset,
                dailyQuests: questState.dailyQuests,
                eventQuests: questState.eventQuests,
                activeTab: questState.activeTab,
                playtimeAnchorMs: questState.playtimeAnchorMs
            };
        }
        // ÏΩîÎìú ÏÇ¨Ïö© Ìï®Ïàò
        function redeemCode() {
            const input = document.getElementById('codeInput');
            const code = input.value.trim().toUpperCase();
            
            if (!code) {
                alert('ÏΩîÎìúÎ•º ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!');
                return;
            }
            
            // Ïù¥ÎØ∏ ÏÇ¨Ïö©Ìïú ÏΩîÎìú ÌôïÏù∏
            if (usedCodes.includes(code)) {
                alert('Ïù¥ÎØ∏ ÏÇ¨Ïö©Ìïú ÏΩîÎìúÏûÖÎãàÎã§!');
                input.value = '';
                return;
            }
            
            // Ïú†Ìö®Ìïú ÏΩîÎìú ÌôïÏù∏
            if (!redeemCodes[code]) {
                alert('Ïú†Ìö®ÌïòÏßÄ ÏïäÏùÄ ÏΩîÎìúÏûÖÎãàÎã§!');
                input.value = '';
                return;
            }
            
            const reward = redeemCodes[code];
            
            // ÏÇ¨Ïö© Í∏∞Í∞Ñ ÌôïÏù∏
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate()); // ÏãúÍ∞Ñ Ï†úÏô∏
            
            if (reward.startDate) {
                const startDate = new Date(reward.startDate);
                if (today < startDate) {
                    alert('Ïù¥ ÏΩîÎìúÎäî ÏïÑÏßÅ ÏÇ¨Ïö©Ìï† Ïàò ÏóÜÏäµÎãàÎã§.\nÏÇ¨Ïö© Í∞ÄÎä• ÏãúÏûëÏùº: ' + reward.startDate);
                    input.value = '';
                    return;
                }
            }
            
            if (reward.endDate) {
                const endDate = new Date(reward.endDate);
                if (today > endDate) {
                    alert('Ïù¥ ÏΩîÎìúÎäî Í∏∞Í∞ÑÏù¥ ÎßåÎ£åÎêòÏóàÏäµÎãàÎã§.\nÏÇ¨Ïö© Í∞ÄÎä• Ï¢ÖÎ£åÏùº: ' + reward.endDate);
                    input.value = '';
                    return;
                }
            }
            
            // Î≥¥ÏÉÅ ÏßÄÍ∏â
            let rewardMessage = 'üéÅ ÏΩîÎìú ÏÇ¨Ïö© ÏôÑÎ£å!\n\nÎ∞õÏùÄ Î≥¥ÏÉÅ:\n';
            
            if (reward.coins) {
                sehoCoin += reward.coins;
                rewardMessage += `üí∞ ÏÑ∏Ìò∏ÏΩîÏù∏ ${reward.coins}Í∞ú\n`;
            }
            
            if (reward.items) {
                reward.items.forEach(item => {
                    addToItemStorage(item.name, item.quantity);
                    rewardMessage += `üì¶ ${item.name} ${item.quantity}Í∞ú\n`;
                });
            }
            
            // ÏÇ¨Ïö©Ìïú ÏΩîÎìú Î™©Î°ùÏóê Ï∂îÍ∞Ä
            usedCodes.push(code);
            
            // UI ÏóÖÎç∞Ïù¥Ìä∏
            updateCoinDisplay();
            updateItemStorageDisplay();
            saveState();
            
            alert(rewardMessage);
            input.value = '';
        }

        function resetAllData() {
            if (!confirm('Ï†ïÎßê Ï¥àÍ∏∞ÌôîÌïòÏãúÍ≤†ÏäµÎãàÍπå? Î™®Îì† Í∏∞Î°ùÏù¥ ÏÇ≠Ï†úÎê©ÎãàÎã§.')) return;
            
            // Î™®Îì† Í≤åÏûÑ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
            storage = [];
            artifactStorage = [];
            lastArtifactDraw = 0;
            totalDraws = 0;
            rarestItem = null;
            startTime = Date.now();
            pausedTime = 0;
            lastPauseTime = 0;
            lastActivityTime = Date.now();
            sehoDrawCount = 0;
            
            // ÏÉÅÏ†ê Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
            shopItems = [];
            shopRefreshTime = 0;
            purchasedInCurrentShop = [];
            
            // ÏÑ∏Ìò∏ÏΩîÏù∏ & Î≤ÑÌîÑ Í¥ÄÎ†® Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
            sehoCoin = 0;
            activeBuffs = [];
            resetBuffFlipStates();
            purchasedThemes = [];
            currentTheme = 'default';
            
            // ÏïÑÏù¥ÌÖú Î≥¥Í¥ÄÏÜå Ï¥àÍ∏∞Ìôî
            itemStorage = [];
            
             // ÌäπÏàò ÏïÑÏù¥ÌÖú Ï¥àÍ∏∞Ìôî
             specialItemCount = 0;
             noCooldownCount = 0;
             
             // ÏΩîÎìú ÏÇ¨Ïö© ÎÇ¥Ïó≠ Ï¥àÍ∏∞Ìôî
             usedCodes = [];
             nameChangedItems = [];
             if (nameChangeTimer) clearTimeout(nameChangeTimer);

            // ÌÄòÏä§Ìä∏ Îç∞Ïù¥ÌÑ∞ Ï¥àÍ∏∞Ìôî
            stopQuestTimer();
            questState = getDefaultQuestState();
            sanitizeQuestState();
            
            updateTrumpCardInfo();
            updateGoldenStatueInfo();
            
            // ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
            updateStorageDisplay();
            updateItemStorageDisplay();
            initArtifactCarousel();
            updateSettingsStats();
            updateCoinDisplay();
            updateBuffDisplay();
            updateDotStates();
            updateShopDisplay();
            initThemeSelector();
            applyTheme(currentTheme);
            renderQuestContent();
            startQuestTimer();
            
            // localStorage ÏôÑÏ†Ñ ÏÇ≠Ï†ú
            localStorage.removeItem('sehorory_state_v1');
            
            saveState();
            alert('Î™®Îì† Îç∞Ïù¥ÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.');
        }
        
        // Ïú†Î¨º Ìö®Í≥º Í≥ÑÏÇ∞ Ìï®ÏàòÎì§
        function getArtifactCooldown() {
            const level = getArtifactLevel('ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Ïú†Î¨ºÏÑù');
            const reductions = ARTIFACT_VALUES.RELIC_COOLDOWN_REDUCTION;
            const reduction = reductions[Math.min(level, 5)] || 0;
            return Math.max(10, Math.round(baseArtifactCooldown * (1 - reduction)));
        }
        

        // ÏÜçÎèÑÌè¨ÏÖò Î†àÎ≤®Ïóê Îî∞Îùº ÎΩëÍ∏∞ Ïä§ÌïÄ Í∞ÑÍ≤© Í∞êÏÜå (Í∏∞Î≥∏ 40ms)
        function getSpinInterval() {
             const base = 50;
             let totalReduction = 0;
             
             // Ïú†Î¨º ÏãúÍ∞ÑÍ∞ÄÏÜçÍ∏∞ Ìö®Í≥º
             const speedLevel = getArtifactLevel('ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò ÏãúÍ∞ÑÍ∞ÄÏÜçÍ∏∞');
             if (speedLevel > 0) {
                 const map = { 1: 0.10, 2: 0.25, 3: 0.50, 4: 0.65, 5: 0.80 };
                 totalReduction += map[Math.min(speedLevel, 5)] || 0;
             }
             
             // ÏÜçÎèÑ Ìè¨ÏÖò Ìö®Í≥º
             const speedBuff = activeBuffs.find(b => b.type === 'speed' && b.endTime > Date.now());
             if (speedBuff) {
                 const buffReduction = [0.075, 0.15, 0.30][speedBuff.level - 1];
                 totalReduction += buffReduction;
                 console.log(`[ÏÜçÎèÑÌè¨ÏÖò] Î†àÎ≤® ${speedBuff.level}, Í∞êÏÜåÏú®: ${buffReduction * 100}%`);
             }
             
             // 1339Ìè¨ÏÖò Ìö®Í≥º (15~50% ÎûúÎç§ Í∞êÏÜå)
             const speedBoostBuff = activeBuffs.find(b => b.type === 'speed_boost' && b.endTime > Date.now());
             if (speedBoostBuff) {
                const appliedReduction = ensureSpeedBoostReduction(speedBoostBuff) || 0;
                totalReduction += appliedReduction;
             }
             
            // ÏãúÏõêÌïú Î¨º Ìö®Í≥º (ÏòÅÍµ¨ ÎΩëÍ∏∞ÏÜçÎèÑ Ï¶ùÍ∞Ä)
            const coldWaterBuff = activeBuffs.find(b => b.type === 'cold_water' && b.endTime > Date.now());
            if (coldWaterBuff) {
                totalReduction += coldWaterBuff.reduction || 0;
            }
             
             const finalInterval = Math.max(8, Math.round(base * (1 - totalReduction)));
             console.log(`[ÎΩëÍ∏∞ÏÜçÎèÑ] Í∏∞Î≥∏: ${base}ms, Í∞êÏÜåÏú®: ${(totalReduction * 100).toFixed(1)}%, ÏµúÏ¢Ö: ${finalInterval}ms`);
             return finalInterval;
         }

        // ÌòÑÏû¨ ÎΩëÍ∏∞ ÏÜçÎèÑ Í≥ÑÏÇ∞ (ÎΩëÍ∏∞ ÏãúÏûë ÌõÑ Îã§Ïùå ÎΩëÍ∏∞ÍπåÏßÄÏùò ÏãúÍ∞Ñ)
        function getCurrentDrawSpeed() {
            const interval = getSpinInterval();
            const totalTime = interval * 12; // 12Î≤à ÌöåÏ†Ñ ÌõÑ Í≤∞Í≥º ÌëúÏãú
            return totalTime;
        }
        
        function getSpecialEffectBonus(participantName) {
            // Ìï¥Îãπ ÏÑ∏Ìò∏Ïùò Î∂ÄÏ†ÅÎßå Ï†ÅÏö©
            const amuletName = `${participantName}Ïùò Î∂ÄÏ†Å`;
            const level = getArtifactLevel(amuletName);
            const bonus = ARTIFACT_VALUES.BUJUK_SPECIAL_BONUS[Math.min(level, 5)] || 0;
            return bonus;
        }
        
        function getRainbowBonus() {
            const level = getArtifactLevel('ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Î¨¥ÏßÄÍ∞ØÎπõ Î≥¥ÏÑù');
            const bonus = ARTIFACT_VALUES.RAINBOW_BONUS[Math.min(level, 5)] || 0;
            return bonus;
        }
        
        // ÏÇ¨Ïö© Í∞ÄÎä•Ìïú Ïú†Î¨º Î™©Î°ù Î∞òÌôò (3Î†àÎ≤® Îã¨ÏÑ±Ìïú Ïú†Î¨º Ï†úÏô∏)
        function getAvailableArtifacts() {
            return ARTIFACT_NAMES.filter(artifactName => {
                const artifact = artifactStorage.find(item => item.name === artifactName);
                return !artifact || artifact.level < 5;
            });
        }

        // Î≥¥Í¥ÄÏÜå Ï†ÑÏ≤¥ ÏÇ≠Ï†ú
        function clearStorage() {
            if (confirm('Î≥¥Í¥ÄÏÜåÎ•º Î™®Îëê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
                storage = [];
                updateStorageDisplay();
            }
        }

        // ÌôïÎ•†Ìëú ÏóÖÎç∞Ïù¥Ìä∏
        function updateProbabilityTable() {
            const content = document.getElementById('probabilityContent');
            
      if (participants.length === 0) {
                content.innerHTML = '<p>Ï∞∏Í∞ÄÏûêÍ∞Ä ÏóÜÏäµÎãàÎã§.</p>';
        return;
      }
            // Ïú†Î¨º Î∞è Ìè¨ÏÖò Ìö®Í≥ºÍ∞Ä Ï†ÅÏö©Îêú Ï∞∏Í∞ÄÏûê Î™©Î°ù ÏÇ¨Ïö©
            const effectiveParticipants = getEffectiveParticipants();
            const totalWeight = effectiveParticipants.reduce((sum, p) => sum + p.weight, 0);
            
            // ÌôïÎ•†ÏàúÏúºÎ°ú Ï†ïÎ†¨ (ÎÜíÏùÄ ÌôïÎ•†Î∂ÄÌÑ∞)
            const sortedParticipants = [...effectiveParticipants].sort((a, b) => b.weight - a.weight);
            
            let listHTML = `
                <div class="probability-list" id="probListMain">
            `;
            
            sortedParticipants.forEach(participant => {
                const probNum = (participant.weight / totalWeight) * 100;
                const probability = formatFiniteOrEllipsis(probNum);
                    const luckBuff = activeBuffs.find(b => b.type === 'luck' && b.endTime > Date.now());
                let displayValue = `${probability}%`;
                if (participant.name === 'ÍΩù' && luckBuff) {
                        const luckReduction = [5, 10, 20][luckBuff.level - 1];
                    displayValue = `${probability}% (-${luckReduction}%)`;
                }
                
                const isMiss = participant.name === 'ÍΩù';
                let detailHTML = '';

                if (!isMiss) {
                const specialEffectBonus = getSpecialEffectBonus(participant.name);
                const rainbowBonus = getRainbowBonus();
                
                const rainbowProbability = formatFiniteOrEllipsis(probNum * 0.0002 * (1 + rainbowBonus));
                const diamondProbability = formatFiniteOrEllipsis(probNum * 0.002 * (1 + specialEffectBonus));
                const goldenProbability = formatFiniteOrEllipsis(probNum * 0.01 * (1 + specialEffectBonus));
                const shiningProbability = formatFiniteOrEllipsis(probNum * 0.2 * (1 + specialEffectBonus));
                const sparklingProbability = formatFiniteOrEllipsis(probNum * 0.05 * (1 + specialEffectBonus));
                    const shiningDiff = formatFiniteOrEllipsis(probNum * 0.2 * specialEffectBonus);
                    const sparklingDiff = formatFiniteOrEllipsis(probNum * 0.05 * specialEffectBonus);
                    const goldenDiff = formatFiniteOrEllipsis(probNum * 0.01 * specialEffectBonus);
                    const diamondDiff = formatFiniteOrEllipsis(probNum * 0.002 * specialEffectBonus);
                    const rainbowDiff = formatFiniteOrEllipsis(probNum * 0.0002 * rainbowBonus);
                
                    detailHTML = `
                        <div class="shining-info">
                            <div class="effect-title">
                                <span>‚ú®</span>
                                <span>ÌäπÎ≥Ñ Ìö®Í≥º ÌôïÎ•†</span>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">‚ú® ÎπõÎÇòÎäî ${participant.name}: ${shiningProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(shiningDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 20% ÌôïÎ•†)</small>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">‚ö° Î≤àÏ©çÏù¥Îäî ${participant.name}: ${sparklingProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(sparklingDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 5% ÌôïÎ•†)</small>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">üèÜ Ìô©Í∏àÏÉâ ${participant.name}: ${goldenProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(goldenDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 1% ÌôïÎ•†)</small>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">üíé Îã§Ïù¥ÏïÑÎ™¨ÎìúÏÉâ ${participant.name}: ${diamondProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(diamondDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 0.2% ÌôïÎ•†)</small>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">üåà Î¨¥ÏßÄÍ∞ØÎπõ ${participant.name}: ${rainbowProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(rainbowDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 0.02% ÌôïÎ•†)</small>
                            </div>
                        </div>
                    `;
                }
                
                listHTML += `
                    <div class="probability-item${isMiss ? ' no-hover' : ''}">
                        <div class="probability-layout">
                            <span class="probability-label">
                        <span class="participant-name">${participant.name}</span>
                                <span class="probability-value">${displayValue}</span>
                            </span>
                        </div>
                        ${detailHTML}
                    </div>
                `;
            });
            
            listHTML += `
                </div>`;
            content.innerHTML = listHTML;
            attachProbabilityToggle('probListMain');
        }

         // Í∏∞Îä• Ìï¥Í∏à ÏïåÎ¶º
         function checkUnlockNotification(prevDraws, currentDraws) {
             // Ïú†Î¨º Í∏∞Îä• Ìï¥Í∏à (75Ìöå)
             if (prevDraws < 75 && currentDraws >= 75) {
                 setTimeout(() => {
                     alert('üéâ Ï∂ïÌïòÌï©ÎãàÎã§! Ï¥ù 75Ìöå ÎΩëÍ∏∞Î•º Îã¨ÏÑ±ÌïòÏó¨ Ïú†Î¨º Í∏∞Îä•Ïù¥ Ìï¥Í∏àÎêòÏóàÏäµÎãàÎã§!');
                 }, 500);
             }
             
             // ÏÉÅÏ†ê Í∏∞Îä• Ìï¥Í∏à (150Ìöå)
             if (prevDraws < 150 && currentDraws >= 150) {
                 setTimeout(() => {
                     alert('üéâ Ï∂ïÌïòÌï©ÎãàÎã§! Ï¥ù 150Ìöå ÎΩëÍ∏∞Î•º Îã¨ÏÑ±ÌïòÏó¨ ÏÉÅÏ†ê Í∏∞Îä•Ïù¥ Ìï¥Í∏àÎêòÏóàÏäµÎãàÎã§!');
                 }, 500);
             }
        }

         // ÎèÑÌä∏ ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏ (ÎΩëÍ∏∞ ÌöüÏàòÏóê Îî∞Î•∏ Ïû†Í∏à Ìï¥Ï†ú)
         function updateDotStates() {
            const dot0 = document.getElementById('dot-0');
            if (dot0) {
                dot0.classList.toggle('locked', totalDraws < 150);
            }
            
            const dot1 = document.getElementById('dot-1');
            if (dot1) {
                dot1.classList.toggle('locked', totalDraws < 150);
            }
            
            const dot5 = document.getElementById('dot-5');
            if (dot5) {
                dot5.classList.toggle('locked', totalDraws < 75);
            }
            
            const dot6 = document.getElementById('dot-6');
            if (dot6) {
                dot6.classList.toggle('locked', totalDraws < 75);
            }
        }

        // ÌôîÎ©¥ Ï†ÑÌôò
        function goToScreen(screenIndex) {
            if ((screenIndex === 5 || screenIndex === 6) && totalDraws < 75) {
                alert('Ïú†Î¨º Í¥ÄÎ†® Í∏∞Îä•ÏùÄ ÏÑ∏Ìò∏Î•º 75Ìöå Ïù¥ÏÉÅ ÎΩëÏïÑÏïº Ïù¥Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§!');
                return;
            }
            
            if ((screenIndex === 0 || screenIndex === 1) && totalDraws < 150) {
                alert('ÏÉÅÏ†ê Í¥ÄÎ†® Í∏∞Îä•ÏùÄ ÏÑ∏Ìò∏Î•º 150Ìöå Ïù¥ÏÉÅ ÎΩëÏïÑÏïº Ïù¥Ïö©Ìï† Ïàò ÏûàÏäµÎãàÎã§!');
                return;
            }
            
            currentScreen = screenIndex;
            if (screenIndex !== 3) {
                document.body.classList.remove('hud-drawer-open');
            }
            const container = document.getElementById('mainContainer');
            container.style.transform = `translateX(-${screenIndex * 100}%)`;
            
            // ÎèÑÌä∏ ÏóÖÎç∞Ïù¥Ìä∏
            document.querySelectorAll('.dot').forEach((dot, index) => {
                dot.classList.toggle('active', index === screenIndex);
            });
            if (screenIndex === 0) {
                 updateItemStorageDisplay();
            } else if (screenIndex === 2) {
                 updateProbabilityTable();
            } else if (screenIndex === 4) {
                 updateStorageDisplay();
             } else if (screenIndex === 6) {
                initArtifactCarousel();
            }
        }

        // ÌÑ∞Ïπò Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
        document.addEventListener('touchstart', function(e) {
            startX = e.touches[0].clientX;
            startY = e.touches[0].clientY;
        });

        document.addEventListener('touchend', function(e) {
            if (!startX || !startY) return;
            
            const endX = e.changedTouches[0].clientX;
            const endY = e.changedTouches[0].clientY;
            const diffX = startX - endX;
            const diffY = startY - endY;
            
            if (Math.abs(diffY) > Math.abs(diffX) && Math.abs(diffY) > 40) {
                if (diffY < -40) {
                    // ÏïÑÎûòÎ°ú Ïä§ÏôÄÏù¥ÌîÑ
                    if (currentScreen === 3 && document.body.classList.contains('is-mobile')) {
                        document.body.classList.add('hud-drawer-open');
                    }
                } else if (diffY > 40) {
                    // ÏúÑÎ°ú Ïä§ÏôÄÏù¥ÌîÑ
                    document.body.classList.remove('hud-drawer-open');
                }
                startX = 0;
                startY = 0;
                return;
            }

            // ÏàòÌèâ Ïä§ÏôÄÏù¥ÌîÑÍ∞Ä ÏàòÏßÅ Ïä§ÏôÄÏù¥ÌîÑÎ≥¥Îã§ ÌÅ¥ ÎïåÎßå Ï≤òÎ¶¨
            if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
                if (diffX > 0) {
                    // ÏôºÏ™ΩÏúºÎ°ú Ïä§ÏôÄÏù¥ÌîÑ (Îã§Ïùå ÌôîÎ©¥)
                    if (currentScreen < 6) {
                        goToScreen(currentScreen + 1);
                    }
                } else {
                    // Ïò§Î•∏Ï™ΩÏúºÎ°ú Ïä§ÏôÄÏù¥ÌîÑ (Ïù¥Ï†Ñ ÌôîÎ©¥)
                    if (currentScreen > 0) {
                        goToScreen(currentScreen - 1);
                    }
                }
            }
            
            startX = 0;
            startY = 0;
        });
        // ÏïÑÎûò Ìå®ÎÑê Î†åÎçîÎßÅ
        function renderBelowProbability() {
            const probHost = document.getElementById('sehoProbBelow');
            if (!probHost) return;
            const pool = getEffectiveParticipants();
            const totalWeight = pool.reduce((sum, p) => sum + p.weight, 0);
            const sortedParticipants = [...pool].sort((a, b) => b.weight - a.weight);
            let listHTML = `
                <div class="probability-list" id="probListBelow">
            `;
            sortedParticipants.forEach(participant => {
                const probNum = (participant.weight / totalWeight) * 100;
                const probability = formatFiniteOrEllipsis(probNum);
                    const luckBuff = activeBuffs.find(b => b.type === 'luck' && b.endTime > Date.now());
                let displayValue = `${probability}%`;
                if (participant.name === 'ÍΩù' && luckBuff) {
                        const luckReduction = [5, 10, 20][luckBuff.level - 1];
                    displayValue = `${probability}% (-${luckReduction}%)`;
                }

                const isMiss = participant.name === 'ÍΩù';
                let detailHTML = '';

                if (!isMiss) {
                const specialEffectBonus = getSpecialEffectBonus(participant.name);
                const rainbowBonus = getRainbowBonus();
                
                const rainbowProbability = formatFiniteOrEllipsis(probNum * 0.0002 * (1 + rainbowBonus));
                const diamondProbability = formatFiniteOrEllipsis(probNum * 0.002 * (1 + specialEffectBonus));
                const goldenProbability = formatFiniteOrEllipsis(probNum * 0.01 * (1 + specialEffectBonus));
                const shiningProbability = formatFiniteOrEllipsis(probNum * 0.2 * (1 + specialEffectBonus));
                const sparklingProbability = formatFiniteOrEllipsis(probNum * 0.05 * (1 + specialEffectBonus));
                    const shiningDiff = formatFiniteOrEllipsis(probNum * 0.2 * specialEffectBonus);
                    const sparklingDiff = formatFiniteOrEllipsis(probNum * 0.05 * specialEffectBonus);
                    const goldenDiff = formatFiniteOrEllipsis(probNum * 0.01 * specialEffectBonus);
                    const diamondDiff = formatFiniteOrEllipsis(probNum * 0.002 * specialEffectBonus);
                    const rainbowDiff = formatFiniteOrEllipsis(probNum * 0.0002 * rainbowBonus);
                
                    detailHTML = `
                        <div class="shining-info">
                            <div class="effect-title">
                                <span>‚ú®</span>
                                <span>ÌäπÎ≥Ñ Ìö®Í≥º ÌôïÎ•†</span>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">‚ú® ÎπõÎÇòÎäî ${participant.name}: ${shiningProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(shiningDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 20% ÌôïÎ•†)</small>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">‚ö° Î≤àÏ©çÏù¥Îäî ${participant.name}: ${sparklingProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(sparklingDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 5% ÌôïÎ•†)</small>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">üèÜ Ìô©Í∏àÏÉâ ${participant.name}: ${goldenProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(goldenDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 1% ÌôïÎ•†)</small>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">üíé Îã§Ïù¥ÏïÑÎ™¨ÎìúÏÉâ ${participant.name}: ${diamondProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(diamondDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 0.2% ÌôïÎ•†)</small>
                            </div>
                            <div class="effect-probability">
                                <div class="effect-prob-row">
                                    <span class="effect-label">üåà Î¨¥ÏßÄÍ∞ØÎπõ ${participant.name}: ${rainbowProbability}%</span>
                                    <span class="effect-boost">${formatDiffLabel(rainbowDiff)}</span>
                                </div>
                                <small>(ÎΩëÌûå ÌõÑ 0.02% ÌôïÎ•†)</small>
                            </div>
                        </div>
                    `;
                }
                
                listHTML += `
                    <div class="probability-item${isMiss ? ' no-hover' : ''}">
                        <div class="probability-layout">
                            <span class="probability-label">
                        <span class="participant-name">${participant.name}</span>
                                <span class="probability-value">${displayValue}</span>
                            </span>
                        </div>
                        ${detailHTML}
                    </div>`;
            });
            listHTML += `
                </div>`;
            probHost.innerHTML = listHTML;
            attachProbabilityToggle('probListBelow');
        }

        function openBottomPanel(which) {
            if (which === 'seho') {
                const panel = document.getElementById('sehoBottomPanel');
                if (panel) {
                    panel.style.display = 'block';
                    renderBelowProbability();
                    updateStorageDisplay();
                }
            } else if (which === 'arti') {
                const panel = document.getElementById('artiBottomPanel');
                const gridBelow = document.getElementById('artifactGridBelow');
                if (panel) {
                    panel.style.display = 'block';
                    if (gridBelow) {
                        gridBelow.innerHTML = '';
                        for (let i = 1; i <= 30; i++) {
                            const cell = document.createElement('div');
                            cell.className = 'artifact-cell locked';
                            cell.textContent = `Ïä¨Î°Ø ${i}`;
                            gridBelow.appendChild(cell);
                        }
                    }
                    updateStorageDisplay();
                }
                const topGrid = document.getElementById('artifactCollection');
                if (topGrid) topGrid.style.display = 'none';
            }
        }

        function closeBottomPanels() {
            const seho = document.getElementById('sehoBottomPanel');
            const arti = document.getElementById('artiBottomPanel');
            if (seho) seho.style.display = 'none';
            if (arti) arti.style.display = 'none';
        }

        // ÌÇ§Î≥¥Îìú Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨ (Ïª¥Ìì®ÌÑ∞Ïö©)
        document.addEventListener('keydown', function(e) {
            // ÌôîÏÇ¥Ìëú ÌÇ§Î°ú ÌôîÎ©¥ Ï†ÑÌôò
            if (e.key === 'ArrowLeft') {
                // ÏôºÏ™Ω ÌôîÏÇ¥Ìëú - Ïù¥Ï†Ñ ÌôîÎ©¥
                if (currentScreen > 0) {
                    goToScreen(currentScreen - 1);
                }
            } else if (e.key === 'ArrowRight') {
                // Ïò§Î•∏Ï™Ω ÌôîÏÇ¥Ìëú - Îã§Ïùå ÌôîÎ©¥
                if (currentScreen < 6) {
                    goToScreen(currentScreen + 1);
                }
            } else if (e.key === 'Escape') {
                closeQuest();
            }
        });

        // ÌäπÎ≥Ñ Ìö®Í≥º Ìï®ÏàòÎì§
        function createConfetti() {
            const colors = ['#ffd700', '#ff6b6b', '#4ecdc4', '#45b7d1', '#96ceb4', '#feca57', '#ff9ff3', '#54a0ff'];
            
            for (let i = 0; i < 50; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.left = Math.random() * 100 + 'vw';
                confetti.style.background = colors[Math.floor(Math.random() * colors.length)];
                confetti.style.animationDelay = Math.random() * 3 + 's';
                confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
                
                document.body.appendChild(confetti);
                
                // 5Ï¥à ÌõÑ Ï†úÍ±∞
                setTimeout(() => {
                    if (confetti.parentNode) {
                        confetti.parentNode.removeChild(confetti);
                    }
                }, 5000);
            }
        }

        function playGoldenSound() {
            // Ìô©Í∏àÏÉâ ÏÇ¨Ïö¥Îìú Ìö®Í≥º (Web Audio API ÏÇ¨Ïö©)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playDiamondSound() {
            // Îã§Ïù¥ÏïÑÎ™¨ÎìúÏÉâ ÏÇ¨Ïö¥Îìú Ìö®Í≥º (Îçî Í≥†Í∏âÏä§Îü¨Ïö¥ ÏÜåÎ¶¨)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator1 = audioContext.createOscillator();
                const oscillator2 = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator1.connect(gainNode);
                oscillator2.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // ÌïòÎ™®ÎãàÎ•º Ïù¥Î£®Îäî Îëê Ïùå
                oscillator1.frequency.setValueAtTime(880, audioContext.currentTime); // A5
                oscillator2.frequency.setValueAtTime(1108.73, audioContext.currentTime); // C#6
                
                oscillator1.frequency.setValueAtTime(1046.5, audioContext.currentTime + 0.1); // C6
                oscillator2.frequency.setValueAtTime(1318.51, audioContext.currentTime + 0.1); // E6
                
                oscillator1.frequency.setValueAtTime(1174.66, audioContext.currentTime + 0.2); // D6
                oscillator2.frequency.setValueAtTime(1479.98, audioContext.currentTime + 0.2); // F#6
                
                gainNode.gain.setValueAtTime(0.2, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.8);
                
                oscillator1.start(audioContext.currentTime);
                oscillator2.start(audioContext.currentTime);
                oscillator1.stop(audioContext.currentTime + 0.8);
                oscillator2.stop(audioContext.currentTime + 0.8);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playRainbowSound() {
            // Î¨¥ÏßÄÍ∞ØÎπõ ÏÇ¨Ïö¥Îìú Ìö®Í≥º (Î∞òÏßùÏù¥Îäî ÏÉÅÏäπ ÏïÑÎ•¥ÌéòÏßÄÏò§)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const gain = audioContext.createGain();
                gain.connect(audioContext.destination);
                gain.gain.setValueAtTime(0.28, audioContext.currentTime);
                const freqs = [659.25, 783.99, 987.77, 1318.51, 1567.98, 1975.53];
                freqs.forEach((f, i) => {
                    const o = audioContext.createOscillator();
                    o.type = 'triangle';
                    o.frequency.setValueAtTime(f, audioContext.currentTime + i * 0.07);
                    o.connect(gain);
                    const start = audioContext.currentTime + i * 0.07;
                    o.start(start);
                    o.stop(start + 0.22);
                });
            } catch (e) {
                console.log('Audio not supported');
            }
        }
        // Í∞ïÌôî Í¥ÄÎ†® ÏÇ¨Ïö¥Îìú Ìï®ÏàòÎì§ (ÎåÄÏû•Ïû•Ïù¥ ÎßùÏπò ÎäêÎÇå)
        function playEnhanceStartSound() {
            // Í∞ïÌôî ÏãúÏûë ÏÇ¨Ïö¥Îìú (ÎßùÏπò ÎÇ¥Î†§ÏπòÎäî ÏÜåÎ¶¨)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator1 = audioContext.createOscillator();
                const oscillator2 = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator1.connect(gainNode);
                oscillator2.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // ÎÇÆÏùÄ ÏùåÍ≥º ÎÜíÏùÄ ÏùåÏùò Ï°∞Ìï©ÏúºÎ°ú Í∏àÏÜç Ï∂©ÎèåÍ∞ê ÌëúÌòÑ
                oscillator1.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator2.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator1.type = 'sawtooth';
                oscillator2.type = 'square';
                
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                
                oscillator1.start(audioContext.currentTime);
                oscillator2.start(audioContext.currentTime);
                oscillator1.stop(audioContext.currentTime + 0.15);
                oscillator2.stop(audioContext.currentTime + 0.15);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playEnhanceSuccessSound() {
            // Í∞ïÌôî ÏÑ±Í≥µ ÏÇ¨Ïö¥Îìú (Í∞ÑÎã®Ìïú ÏÑ±Í≥µÏùå)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.12, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.15);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.15);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playEnhanceFailSound() {
            // Í∞ïÌôî Ïã§Ìå® ÏÇ¨Ïö¥Îìú (Í∞ÑÎã®Ìïú Ïã§Ìå®Ïùå)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playEnhanceDestroySound() {
            // Í∞ïÌôî ÌååÍ¥¥ ÏÇ¨Ïö¥Îìú (Í∞ÑÎã®Ìïú ÌååÍ¥¥Ïùå)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(80, audioContext.currentTime);
                oscillator.type = 'sawtooth';
                
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.25);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.25);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        function playMaxEnhanceSuccessSound() {
            // 5Í∞ï ÏÑ±Í≥µ ÌäπÎ≥Ñ ÏÇ¨Ïö¥Îìú (Í∞ÑÎã®Ìïú "Îù§" ÏÜåÎ¶¨)
            try {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                // Í∞ÑÎã®Ìïú "Îù§" ÏÜåÎ¶¨
                oscillator.frequency.setValueAtTime(1046.50, audioContext.currentTime);
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.15, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
            } catch (e) {
                console.log('Audio not supported');
            }
        }

        // ÏÇ¨Ïö©Ïûê ÌôúÎèô Í∞êÏßÄ Î∞è ÌîåÎ†àÏù¥ÌÉÄÏûÑ ÏóÖÎç∞Ïù¥Ìä∏
        function updateActivity() {
            lastActivityTime = Date.now();
            
            // Í∏∞Ï°¥ ÌÉÄÏûÑÏïÑÏõÉ ÌÅ¥Î¶¨Ïñ¥
            if (activityTimeout) {
                clearTimeout(activityTimeout);
            }
            
            // 10Ï¥à ÌõÑ ÌôúÎèô Ï§ëÏßÄÎ°ú Í∞ÑÏ£º
            activityTimeout = setTimeout(() => {
                // ÌôúÎèô Ï§ëÏßÄ ÏÉÅÌÉúÎ°ú Î≥ÄÍ≤Ω (ÌîåÎ†àÏù¥ÌÉÄÏûÑ Ïπ¥Ïö¥Ìä∏ Î©àÏ∂§)
            }, 10000);
        }

        function startPlaytimeTicker() {
            if (playtimeTimer) clearInterval(playtimeTimer);
            playtimeTimer = setInterval(() => {
                const pt = document.getElementById('statPlaytime');
                if (pt) {
                    const currentTime = Date.now();
                    const timeSinceLastActivity = currentTime - lastActivityTime;
                    
                    // 10Ï¥à Ïù¥ÏÉÅ ÌôúÎèôÏù¥ ÏóÜÏúºÎ©¥ ÌîåÎ†àÏù¥ÌÉÄÏûÑ Ïπ¥Ïö¥Ìä∏ Î©àÏ∂§
                    if (timeSinceLastActivity < 10000) {
                        const totalPlaytime = currentTime - startTime - pausedTime;
                        pt.textContent = formatElapsedTime(totalPlaytime);
                    }
                }
            }, 1000);
        }

        function formatElapsedTime(ms) {
            const totalSec = Math.max(0, Math.floor(ms / 1000));
            const h = String(Math.floor(totalSec / 3600)).padStart(2, '0');
            const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2, '0');
            return `${h}:${m}`;
        }
        // ÌéòÏù¥ÏßÄ Í∞ÄÏãúÏÑ± Î≥ÄÍ≤Ω Ï≤òÎ¶¨
        function handleVisibilityChange() {
            if (document.hidden) {
                // ÌéòÏù¥ÏßÄÍ∞Ä Ïà®Í≤®Ï°åÏùÑ Îïå - ÏùºÏãúÏ†ïÏßÄ ÏãúÍ∞Ñ Í∏∞Î°ù
                lastPauseTime = Date.now();
            } else {
                // ÌéòÏù¥ÏßÄÍ∞Ä Îã§Ïãú Î≥¥Ïùº Îïå - ÏùºÏãúÏ†ïÏßÄÎêú ÏãúÍ∞ÑÏùÑ ÎàÑÏ†Å
                if (lastPauseTime > 0) {
                    pausedTime += Date.now() - lastPauseTime;
                    lastPauseTime = 0;
                }
            }
        }
        // ÌéòÏù¥ÏßÄ Í∞ÄÏãúÏÑ± Ïù¥Î≤§Ìä∏ Î¶¨Ïä§ÎÑà Îì±Î°ù
        document.addEventListener('visibilitychange', handleVisibilityChange);
        // ========== ÏÉÅÏ†ê ÏãúÏä§ÌÖú ==========
        // ÏÉÅÏ†ê Ï¥àÍ∏∞Ìôî
        function initShop() {
            const now = Date.now();
            
            // Ï†ÄÏû•Îêú ÏÉÅÏ†ê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÍ±∞ÎÇò Í∞±Ïã† ÏãúÍ∞ÑÏù¥ ÏßÄÎÇ¨ÏùÑ ÎïåÎßå Í∞±Ïã†
            if (shopItems.length === 0 || now >= shopRefreshTime) {
                refreshShop();
            } else {
                // Ï†ÄÏû•Îêú ÏÉÅÏ†ê Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏Îßå
                updateShopDisplay();
            }
            
            // ÌÉÄÏù¥Î®∏ ÏãúÏûë
            startShopTimer();
        }
        // ÏÉÅÏ†ê Î¨ºÌíà Í∞±Ïã† (ÎûúÎç§ 3Í∞ú ÏÑ†ÌÉù)
        function refreshShop() {
            const now = Date.now();
            const bundleLevel = getArtifactLevel('ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Î¥áÏßê');
            const minuteReduction = ARTIFACT_VALUES.BUNDLE_MINUTE_REDUCTION[Math.min(bundleLevel, 5)] || 0;
            const baseMinutes = 20;
            const actualMinutes = Math.max(1, baseMinutes - minuteReduction);
            shopRefreshTime = now + actualMinutes * 60 * 1000;
            
            shopItems = [];
            purchasedInCurrentShop = []; // Íµ¨Îß§ Í∏∞Î°ù Ï¥àÍ∏∞Ìôî
            
            // Îì±Í∏âÎ≥Ñ ÌôïÎ•†: ÏùºÎ∞ò 45%, Ìù¨Í∑Ä 27.5%, Î†àÏñ¥ 17.5%, ÏòÅÏõÖ 7.5%, Ï†ÑÏÑ§ 2.5%
            const rarityProbabilities = {
                'common': 45,
                'rare': 27.5,
                'epic': 17.5,
                'hero': 7.5,
                'legendary': 2.5
            };
            
            // Îì±Í∏âÎ≥Ñ ÌôïÎ•†Ïóê Îî∞Îùº 3Í∞ú ÏÑ†ÌÉù
            for (let i = 0; i < 3; i++) {
                // 1Îã®Í≥Ñ: Îì±Í∏â ÏÑ†ÌÉù
                const random = Math.random() * 100;
                let selectedRarity = 'common';
                let cumulative = 0;
                
                for (const [rarity, probability] of Object.entries(rarityProbabilities)) {
                    cumulative += probability;
                    if (random <= cumulative) {
                        selectedRarity = rarity;
                        break;
                    }
                }
                
                // 2Îã®Í≥Ñ: Ìï¥Îãπ Îì±Í∏âÏùò ÏïÑÏù¥ÌÖú Ï§ëÏóêÏÑú ÎûúÎç§ ÏÑ†ÌÉù
                const availableItems = allShopItems.filter(item => {
                    // Íµ¨Îß§ Í∞ÄÎä•Ìïú ÏïÑÏù¥ÌÖúÎßå ÌïÑÌÑ∞ÎßÅ
                    if (item.oneTime && purchasedThemes.includes(item.name)) {
                        return false;
                    }
                    return item.rarity === selectedRarity;
                });
                
                if (availableItems.length === 0) {
                    // Ìï¥Îãπ Îì±Í∏âÏóê ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏúºÎ©¥ ÏùºÎ∞ò Îì±Í∏âÏúºÎ°ú ÎåÄÏ≤¥
                    const commonItems = allShopItems.filter(item => {
                        if (item.oneTime && purchasedThemes.includes(item.name)) {
                            return false;
                        }
                        return item.rarity === 'common';
                    });
                    if (commonItems.length > 0) {
                        const randomIndex = Math.floor(Math.random() * commonItems.length);
                        const selectedItem = commonItems[randomIndex];
                        
                        // Ìè¨ÏÖòÏù∏ Í≤ΩÏö∞ Í∞úÏàò ÎûúÎç§ Í≤∞Ï†ï
                        if (selectedItem.type === 'potion') {
                            const qty = Math.floor(Math.random() * (selectedItem.maxQty - selectedItem.minQty + 1)) + selectedItem.minQty;
                            shopItems.push({
                                ...selectedItem,
                                quantity: qty,
                                displayName: `${selectedItem.name} x${qty}`,
                                totalPrice: selectedItem.price * qty
                            });
                        } else {
                            shopItems.push({
                                ...selectedItem,
                                quantity: 1,
                                displayName: selectedItem.name,
                                totalPrice: selectedItem.price
                            });
                        }
                    }
                    continue;
                }
                
                // Ìï¥Îãπ Îì±Í∏âÏùò ÏïÑÏù¥ÌÖú Ï§ëÏóêÏÑú ÎûúÎç§ ÏÑ†ÌÉù
                const randomIndex = Math.floor(Math.random() * availableItems.length);
                const selectedItem = availableItems[randomIndex];
                
                // Ìè¨ÏÖòÏù∏ Í≤ΩÏö∞ Í∞úÏàò ÎûúÎç§ Í≤∞Ï†ï
                if (selectedItem.type === 'potion') {
                    const qty = Math.floor(Math.random() * (selectedItem.maxQty - selectedItem.minQty + 1)) + selectedItem.minQty;
                    shopItems.push({
                        ...selectedItem,
                        quantity: qty,
                        displayName: `${selectedItem.name} x${qty}`,
                        totalPrice: selectedItem.price * qty
                    });
                } else {
                    shopItems.push({
                        ...selectedItem,
                        quantity: 1,
                        displayName: selectedItem.name,
                        totalPrice: selectedItem.price
                    });
                }
            }
            
            updateShopDisplay();
            updateShopTimer(Math.max(0, shopRefreshTime - now));
            saveState();
        }
        // ÏÉÅÏ†ê ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateShopDisplay() {
            const container = document.getElementById('shopItems');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (shopItems.length === 0) {
                // Î¨ºÌíàÏù¥ ÏóÜÏùÑ Îïå
                for (let i = 0; i < 3; i++) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'shop-item';
                    itemDiv.innerHTML = `
                        <div class="shop-item-name">???</div>
                        <div class="shop-item-desc">Î¨ºÌíàÏùÑ Ï§ÄÎπÑÏ§ëÏûÖÎãàÎã§...</div>
                        <div class="shop-item-price">??? ÏÑ∏Ìò∏ÏΩîÏù∏</div>
                    `;
                    container.appendChild(itemDiv);
                }
            } else {
                // Î¨ºÌíà ÌëúÏãú
                shopItems.forEach((item, index) => {
                    const itemDiv = document.createElement('div');
                    // Îì±Í∏âÏóê Îî∞Î•∏ ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
                    const rarityClass = item.rarity || 'common';
                    const isSoldOut = purchasedInCurrentShop.includes(index);
                    itemDiv.className = `shop-item ${rarityClass}${isSoldOut ? ' sold-out' : ''}`;
                    
                     // ÏïÑÏù¥ÌÖú ÏÑ§Î™Ö ÏÉùÏÑ±
                     let description = '';
                     if (item.type === 'potion') {
                         if (item.effect === 'luck') {
                             const reduction = [5, 10, 20][item.level - 1];
                            description = `2Î∂ÑÎèôÏïà ÍΩù ÌôïÎ•† ${reduction}% Í∞êÏÜå`;
                         } else if (item.effect === 'speed') {
                             const reduction = [7.5, 15, 30][item.level - 1];
                            description = `2Î∂ÑÎèôÏïà ÎΩëÍ∏∞ ÏÜçÎèÑ ${reduction}% Í∞êÏÜå`;
                         } else if (item.effect === 'speed_boost') {
                             description = `10Î∂ÑÎèôÏïà ÎΩëÍ∏∞ ÏÜçÎèÑ 15~50% Í∞êÏÜå`;
                         }
                     } else if (item.type === 'theme') {
                         description = `Î∞∞Í≤Ω ÌÖåÎßà Î≥ÄÍ≤Ω (1Ìöå Íµ¨Îß§)`;
                     } else if (item.type === 'special') {
                         if (item.effect === 'guaranteed_special') {
                             description = `Îã§Ïùå ÎΩëÍ∏∞ÏóêÏÑú ÌäπÎ≥ÑÌö®Í≥º ÌôïÎ•† 20%Î°ú Í≥†Ï†ï (ÍΩù Ïãú ÌöüÏàò Í∞êÏÜå ÏïàÎê®)`;
                         } else if (item.effect === 'remove_cooldown') {
                             description = `Îã§Ïùå 75Ìöå ÎΩëÍ∏∞ Ïø®ÌÉÄÏûÑ ÏÇ≠Ï†ú`;
                         } else if (item.effect === 'refresh_shop') {
                             description = `3ÌöåÍπåÏßÄ ÏÇ¨Ïö©Í∞ÄÎä• / ÏÇ¨Ïö©Ïãú Ï¶âÏãú ÏÉÅÏ†ê Í∞±Ïã†`;
                        } else if (item.effect === 'lucky_box') {
                            description = `ÌñâÏö¥Ìè¨ÏÖò‚Ö° 1~10Í∞ú, ÏÜçÎèÑÌè¨ÏÖò‚Ö° 1~10Í∞ú ÌöçÎìù`;
                        }
                    }
                    
                    itemDiv.innerHTML = `
                        <div class="shop-item-name">${item.displayName || item.name}</div>
                        <div class="shop-item-desc">${description}</div>
                        <div class="shop-item-price">${item.totalPrice || item.price} ÏÑ∏Ìò∏ÏΩîÏù∏</div>
                        ${isSoldOut ? '<div class="sold-out-label">Îß§ÏßÑ</div>' : ''}
                    `;
                    
                    if (!isSoldOut) {
                        itemDiv.onclick = () => buyShopItem(item, index);
                    }
                    
                    container.appendChild(itemDiv);
                });
                
                // 3Í∞ú ÎØ∏ÎßåÏù¥Î©¥ Îπà Ïä¨Î°Ø Ï∂îÍ∞Ä
                for (let i = shopItems.length; i < 3; i++) {
                    const itemDiv = document.createElement('div');
                    itemDiv.className = 'shop-item';
                    itemDiv.innerHTML = `
                        <div class="shop-item-name">???</div>
                        <div class="shop-item-desc">Î¨ºÌíàÏùÑ Ï§ÄÎπÑÏ§ëÏûÖÎãàÎã§...</div>
                        <div class="shop-item-price">??? ÏÑ∏Ìò∏ÏΩîÏù∏</div>
                    `;
                    container.appendChild(itemDiv);
                }
            }
        }
        
        // ÏÉÅÏ†ê ÏïÑÏù¥ÌÖú Íµ¨Îß§
        function buyShopItem(item, itemIndex) {
            const cost = item.totalPrice || item.price;
            
            // Ïù¥ÎØ∏ Íµ¨Îß§Ìïú ÏïÑÏù¥ÌÖúÏù∏ÏßÄ ÌôïÏù∏
            if (purchasedInCurrentShop.includes(itemIndex)) {
                alert('Ïù¥ÎØ∏ Íµ¨Îß§Ìïú ÏïÑÏù¥ÌÖúÏûÖÎãàÎã§!');
                return;
            }
            
            // ÏÑ∏Ìò∏ÏΩîÏù∏ ÌôïÏù∏
            if (sehoCoin < cost) {
                alert(`ÏÑ∏Ìò∏ÏΩîÏù∏Ïù¥ Î∂ÄÏ°±Ìï©ÎãàÎã§! (ÌïÑÏöî: ${cost}, Î≥¥Ïú†: ${sehoCoin})`);
                return;
            }
            
            // Íµ¨Îß§ ÌôïÏù∏
            if (!confirm(`${item.displayName || item.name}ÏùÑ(Î•º) ${cost} ÏÑ∏Ìò∏ÏΩîÏù∏Ïóê Íµ¨Îß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå?`)) {
                return;
            }
            
            // ÏÑ∏Ìò∏ÏΩîÏù∏ Ï∞®Í∞ê
            sehoCoin -= cost;
            updateCoinDisplay();
            
            // Íµ¨Îß§ Í∏∞Î°ù Ï∂îÍ∞Ä
            purchasedInCurrentShop.push(itemIndex);
            incrementQuestProgress('shop_purchase', 1);
            
             // ÏïÑÏù¥ÌÖú ÌÉÄÏûÖÏóê Îî∞Îùº Ï≤òÎ¶¨
             if (item.type === 'potion') {
                 // Ìè¨ÏÖòÏùÄ ÏïÑÏù¥ÌÖú Î≥¥Í¥ÄÏÜåÏóê Ï∂îÍ∞Ä
                 addToItemStorage(item.name, item.quantity);
                 alert(`${item.displayName}ÏùÑ(Î•º) Íµ¨Îß§ÌñàÏäµÎãàÎã§! ÏïÑÏù¥ÌÖú Î≥¥Í¥ÄÏÜåÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.`);
              } else if (item.type === 'theme') {
                  // ÌÖåÎßàÎäî Íµ¨Îß§ Î™©Î°ùÏóê Ï∂îÍ∞Ä
                  if (!purchasedThemes.includes(item.themeColor)) {
                      purchasedThemes.push(item.themeColor);
                      sanitizeThemeState();
                      // ÌÖåÎßà ÏÑ†ÌÉùÍ∏∞ ÏóÖÎç∞Ïù¥Ìä∏
                      initThemeSelector();
                  }
                  alert(`${item.name}ÏùÑ(Î•º) Íµ¨Îß§ÌñàÏäµÎãàÎã§! ÏÑ§Ï†ïÏóêÏÑú ÌÖåÎßàÎ•º Î≥ÄÍ≤ΩÌï† Ïàò ÏûàÏäµÎãàÎã§.`);
              } else if (item.type === 'special') {
                  if (item.effect === 'guaranteed_special') {
                      // Ïö©ÏÇ¨Ïùò Ïã¨Ìåê
                      specialItemCount += item.quantity;
                      alert(`${item.name}ÏùÑ(Î•º) Íµ¨Îß§ÌñàÏäµÎãàÎã§! Îã§Ïùå ÎΩëÍ∏∞ÏóêÏÑú ÌäπÎ≥ÑÌö®Í≥ºÍ∞Ä Ï†ÅÏö©Îê©ÎãàÎã§.`);
                  } else {
                      // Í∏∞ÌÉÄ ÌäπÏàò ÏïÑÏù¥ÌÖúÎì§ÏùÄ ÏïÑÏù¥ÌÖú Î≥¥Í¥ÄÏÜåÏóê Ï∂îÍ∞Ä
                      addToItemStorage(item.name, item.quantity);
                      alert(`${item.displayName}ÏùÑ(Î•º) Íµ¨Îß§ÌñàÏäµÎãàÎã§! ÏïÑÏù¥ÌÖú Î≥¥Í¥ÄÏÜåÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî.`);
                  }
              }
            
            // ÌôîÎ©¥ Í∞±Ïã†
            updateShopDisplay();
            saveState();
        }
        
        // ÏÉÅÏ†ê ÌÉÄÏù¥Î®∏ ÏãúÏûë
        function startShopTimer() {
            if (shopTimerInterval) clearInterval(shopTimerInterval);

            const bundleLevel = getArtifactLevel('ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Î¥áÏßê');
            const minuteReduction = ARTIFACT_VALUES.BUNDLE_MINUTE_REDUCTION[Math.min(bundleLevel, 5)] || 0;
            const baseMinutes = 20;
            const actualMinutes = Math.max(1, baseMinutes - minuteReduction);
            const maxIntervalMs = actualMinutes * 60 * 1000;
            const nowInitial = Date.now();
            if (shopRefreshTime <= 0) {
                shopRefreshTime = nowInitial + maxIntervalMs;
            } else {
                const remainingInitial = shopRefreshTime - nowInitial;
                if (remainingInitial > maxIntervalMs) {
                    shopRefreshTime = nowInitial + maxIntervalMs;
                }
            }
            updateShopTimer(Math.max(0, shopRefreshTime - nowInitial));
            
            shopTimerInterval = setInterval(() => {
                const now = Date.now();
                const remaining = Math.max(0, shopRefreshTime - now);
                
                if (remaining === 0) {
                    // ÏãúÍ∞ÑÏù¥ Îã§ ÎêòÎ©¥ ÏÉÅÏ†ê Í∞±Ïã†
                    refreshShop();
                }
                
                // ÌÉÄÏù¥Î®∏ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
                updateShopTimer(remaining);
            }, 1000);
        }
        
        // ÏÉÅÏ†ê ÌÉÄÏù¥Î®∏ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
        function updateShopTimer(remainingMs) {
            const timerEl = document.getElementById('shopTimer');
            if (!timerEl) return;
            
            const totalSec = Math.floor(remainingMs / 1000);
            const minutes = Math.floor(totalSec / 60);
            const seconds = totalSec % 60;
            
            timerEl.textContent = `Í∞±Ïã†ÍπåÏßÄ: ${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        // ========== ÏïÑÏù¥ÌÖú Î≥¥Í¥ÄÏÜå ÏãúÏä§ÌÖú ==========
        
        let itemStorage = []; // ÏïÑÏù¥ÌÖú Î≥¥Í¥ÄÏÜå (ÎÇòÏ§ëÏóê Íµ¨ÌòÑ)
        let usedCodes = []; // ÏÇ¨Ïö©Ìïú ÏΩîÎìú Î™©Î°ù
        
        // ÏΩîÎìú Î™©Î°ù (ÏΩîÎìú: Î≥¥ÏÉÅ)
        // Í∞Å ÏΩîÎìúÎäî Îã§Ïùå ÌòïÏãùÏùÑ Í∞ÄÏßëÎãàÎã§:
        // 'CODE': {
        //     coins: ÏÑ∏Ìò∏ÏΩîÏù∏ ÏàòÎüâ,
        //     items: [{ name: 'ÏïÑÏù¥ÌÖúÎ™Ö', quantity: ÏàòÎüâ }],
        //     startDate: '2024-01-01',  // ÏãúÏûëÏùº (ÏÑ†ÌÉùÏÇ¨Ìï≠)
        //     endDate: '2024-12-31'     // Ï¢ÖÎ£åÏùº (ÏÑ†ÌÉùÏÇ¨Ìï≠)
        // }
        const redeemCodes = {
            // ÏÑ∏Ìò∏ÏΩîÏù∏ 200Í∞ú (ÏùºÏ£ºÏùº Ï†úÌïú)
            'K7X9M': {
                coins: 200,
                endDate: '2025-11-01'
            },
            // ÏÜçÎèÑÌè¨ÏÖò‚Ö† 10Í∞ú (ÏùºÏ£ºÏùº Ï†úÌïú)
            'P3V5T': {
                items: [
                    { name: 'ÏÜçÎèÑÌè¨ÏÖò‚Ö†', quantity: 10 }
                ],
                endDate: '2025-11-01'
            },
            // ÌñâÏö¥Ìè¨ÏÖò‚Ö† 10Í∞ú (ÏùºÏ£ºÏùº Ï†úÌïú)
            'H8N2Q': {
                items: [
                    { name: 'ÌñâÏö¥Ìè¨ÏÖò‚Ö†', quantity: 10 }
                ],
                endDate: '2025-11-01'
            }
        };
        // ÏïÑÏù¥ÌÖú Î≥¥Í¥ÄÏÜå ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
        function updateItemStorageDisplay() {
            const storageList = document.getElementById('itemStorageList');
            if (!storageList) return;
            
            if (itemStorage.length === 0) {
                storageList.innerHTML = '<p>ÏïÑÏù¥ÌÖúÏù¥ ÏóÜÏäµÎãàÎã§.</p>';
                return;
            }

            // ÏïÑÏù¥ÌÖú Î™©Î°ù ÏÉùÏÑ±
            let html = '';
            itemStorage.forEach((item, index) => {
                const name = item.name || '???';
                const count = item.count || 1;
                const itemData = allShopItems.find(si => si.name === name);
                const rarity = item.rarity || (itemData ? itemData.rarity : 'common');
                if (!item.rarity) item.rarity = rarity; // ÎàÑÎùΩÎêú Ïù¥Ï†Ñ Îç∞Ïù¥ÌÑ∞ Î≥¥Ï†ï
                const description = getItemDescription(name);
                const descriptionHtml = description ? `<div class="item-description">${description}</div>` : '';
                
                // Î≥¥Ï°∞Î∞∞ÌÑ∞Î¶¨Ïù∏ Í≤ΩÏö∞ ÎÇ®ÏùÄ ÏÇ¨Ïö© ÌöüÏàò ÌëúÏãú
                let displayName = name;
                if (name === 'Î≥¥Ï°∞Î∞∞ÌÑ∞Î¶¨' && item.usesLeft !== undefined) {
                    displayName = `Î≥¥Ï°∞Î∞∞ÌÑ∞Î¶¨(${item.usesLeft}Ìöå ÎÇ®Ïùå)`;
                }
                
                html += `
                    <div class="storage-item rarity-${rarity}" data-index="${index}" style="cursor: pointer;">
                        <div class="storage-item-header">
                            <span class="storage-item-name">${displayName}</span>
                            <span class="storage-item-count">x${count}</span>
                        </div>
                        ${descriptionHtml}
                    </div>
                `;
            });
            
            storageList.innerHTML = html;
            
            // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï∂îÍ∞Ä
            storageList.querySelectorAll('.storage-item').forEach((itemEl) => {
                itemEl.addEventListener('click', () => {
                    const index = parseInt(itemEl.getAttribute('data-index'));
                    useItemFromStorage(index);
                });
            });
        }

        // ========== ÏÑ∏Ìò∏ÏΩîÏù∏ & Î≤ÑÌîÑ ÏãúÏä§ÌÖú ==========
        
        // ÏÑ∏Ìò∏ÏΩîÏù∏ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
        function updateCoinDisplay() {
            const coinEl = document.getElementById('coinAmount');
            if (coinEl) {
                coinEl.textContent = sehoCoin.toLocaleString();
            }
        }

        // Î≤ÑÌîÑ ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
        function updateBuffDisplay() {
            const container = document.getElementById('buffContainer');
            if (!container) return;
            
            container.innerHTML = '';
            const now = Date.now();
            let visibleBuffCount = 0;
            const totalBefore = activeBuffs.length;
            const visibleBuffIds = new Set();

            syncWeekendBuffState();
            cleanupBuffFlipStates();

            activeBuffs.forEach((buff) => {
                const buffId = ensureBuffId(buff);
                const remaining = Math.max(0, buff.endTime - now);
                if (remaining === 0) return; // ÎßåÎ£åÎêú Î≤ÑÌîÑÎäî ÌëúÏãúÌïòÏßÄ ÏïäÏùå
                
                visibleBuffCount += 1;
                visibleBuffIds.add(buffId);
                const minutes = Math.floor(remaining / 60000);
                const seconds = Math.floor((remaining % 60000) / 1000);
                const timeStr = `${minutes}:${String(seconds).padStart(2, '0')}`;
                
                let buffName = '';
                let buffTitle = '';
                let buffEmoji = '‚ú®';
                let buffTagline = 'ÌäπÎ≥Ñ Ìö®Í≥º Ï†ÅÏö© Ï§ë';
                
                if (buff.type === 'luck') {
                    const luckReduction = [5, 10, 20][buff.level - 1];
                    buffName = `ÌñâÏö¥${buff.level}`;
                    buffTitle = `ÌñâÏö¥Ìè¨ÏÖò Lv.${buff.level}\nÍΩù ÌôïÎ•† ${luckReduction}% Í∞êÏÜå\nÎÇ®ÏùÄ ÏãúÍ∞Ñ: ${timeStr}`;
                    buffEmoji = 'üçÄ';
                    buffTagline = `ÍΩù ÌôïÎ•† ${luckReduction}% Í∞êÏÜå`;
                } else if (buff.type === 'speed') {
                    const speedReduction = [7.5, 15, 30][buff.level - 1];
                    buffName = `ÏÜçÎèÑ${buff.level}`;
                    buffTitle = `ÏÜçÎèÑÌè¨ÏÖò Lv.${buff.level}\nÎΩëÍ∏∞ ÏÜçÎèÑ ${speedReduction}% Í∞êÏÜå\nÎÇ®ÏùÄ ÏãúÍ∞Ñ: ${timeStr}`;
                    buffEmoji = '‚ö°';
                    buffTagline = `ÎΩëÍ∏∞ ÏÜçÎèÑ ${speedReduction}% Ìñ•ÏÉÅ`;
                } else if (buff.type === 'speed_boost') {
                    const appliedReduction = ensureSpeedBoostReduction(buff) || 0;
                    const appliedPercent = Math.round(appliedReduction * 100);
                    buffName = '1339';
                    buffTitle = `1339Ìè¨ÏÖò\nÎΩëÍ∏∞ ÏÜçÎèÑ ${appliedPercent}% Í∞êÏÜå\nÎÇ®ÏùÄ ÏãúÍ∞Ñ: ${timeStr}`;
                    buffEmoji = 'üöÄ';
                    buffTagline = `ÎΩëÍ∏∞ ÏÜçÎèÑ ${appliedPercent}% Í∞êÏÜå`;
                } else if (buff.type === 'xiaomi_phone') {
                    buffName = 'ÏÉ§Ïò§ÎØ∏Ìè∞';
                    buffTitle = `ÏÉ§Ïò§ÎØ∏Ìè∞\nÍΩù ÌôïÎ•† 8% Í∞êÏÜå\n10Ï¥àÎßàÎã§ 8% ÌôïÎ•†Î°ú Ï†úÍ±∞`;
                    buffEmoji = 'üì±';
                    buffTagline = 'ÍΩù ÌôïÎ•† 8% Í∞êÏÜå';
                } else if (buff.type === 'cold_water') {
                    const stacks = Math.round((buff.reduction || 0) * 100);
                    buffName = `ÏãúÏõêÌïúÎ¨º√ó${stacks}`;
                    buffTitle = `ÏãúÏõêÌïú Î¨º (${stacks}Ìöå Ï§ëÏ≤©)\nÏòÅÍµ¨ ÎΩëÍ∏∞ÏÜçÎèÑ +${stacks}%`;
                    buffEmoji = 'üíß';
                    buffTagline = `ÎΩëÍ∏∞ÏÜçÎèÑ +${stacks}%`;
                } else if (buff.type === 'weekend') {
                    buffName = 'Ï£ºÎßê';
                    buffTitle = `Ï£ºÎßê\nÏø®ÌÉÄÏûÑ ÏóÜÏùå\nÎÇ®ÏùÄ ÎΩëÍ∏∞: ${noCooldownCount}Ìöå`;
                    buffEmoji = 'üõéÔ∏è';
                    buffTagline = 'ÏùºÎ∞ò ÎΩëÍ∏∞ Ï¶âÏãú ÏôÑÎ£å';
                } else {
                    buffName = buff.name || 'ÌäπÏàò Î≤ÑÌîÑ';
                }

                let timerText = timeStr;
                if (buff.type === 'cold_water') {
                    timerText = 'ÏòÅÍµ¨';
                } else if (buff.type === 'xiaomi_phone') {
                    timerText = '‚àû';
                } else if (buff.type === 'weekend') {
                    timerText = `${noCooldownCount}Ìöå`;
                }

                const detailLines = buffTitle
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line && !line.startsWith('ÎÇ®ÏùÄ ÏãúÍ∞Ñ') && line !== buffName);
                const detailHtml = detailLines.length
                    ? detailLines.map(line => `<span>${line}</span>`).join('')
                    : `<span>${buffTitle.replace(/\n/g, '<br>')}</span>`;

                const buffDiv = document.createElement('div');
                buffDiv.className = `buff-icon ${buff.type}`;
                buffDiv.dataset.buffId = buffId;
                buffDiv.innerHTML = `
                    <div class="buff-face buff-front">
                        <span class="buff-name">${buffName}</span>
                        <span class="buff-timer">${timerText}</span>
                    </div>
                    <div class="buff-face buff-back">
                        <div class="buff-detail-tag">${buffEmoji} ${buffTagline}</div>
                        <div class="buff-detail-content">${detailHtml}</div>
                    </div>
                `;
                const isFlipped = !!buffFlipStates[buffId];
                if (isFlipped) {
                    buffDiv.classList.add('flipped');
                }
                buffDiv.setAttribute('role', 'button');
                buffDiv.setAttribute('tabindex', '0');
                buffDiv.setAttribute('aria-pressed', isFlipped ? 'true' : 'false');
                const toggleFlip = () => {
                    const flipped = !buffFlipStates[buffId];
                    buffFlipStates[buffId] = flipped;
                    buffDiv.classList.toggle('flipped', flipped);
                    buffDiv.setAttribute('aria-pressed', flipped ? 'true' : 'false');
                };
                buffDiv.addEventListener('click', (event) => {
                    event.preventDefault();
                    toggleFlip();
                });
                buffDiv.addEventListener('keydown', (event) => {
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        toggleFlip();
                    }
                });
                buffDiv.title = buffTitle;
                container.appendChild(buffDiv);
            });

            Object.keys(buffFlipStates).forEach(id => {
                if (!visibleBuffIds.has(id)) {
                    delete buffFlipStates[id];
                }
            });

            if (visibleBuffCount === 0) {
                const emptyState = document.createElement('div');
                emptyState.className = 'buff-empty';
                emptyState.textContent = 'ÌòÑÏû¨ ÌôúÏÑ±ÌôîÎêú Î≤ÑÌîÑÍ∞Ä ÏóÜÏñ¥Ïöî';
                container.appendChild(emptyState);
            }
            
            // Î≤ÑÌîÑ ÏÉÅÌÉúÍ∞Ä Î≥ÄÍ≤ΩÎêòÏóàÏùÑ Îïå ÌôïÎ•† ÌëúÏãú ÏóÖÎç∞Ïù¥Ìä∏
            if (visibleBuffCount === 0 && totalBefore > 0) {
                updateProbabilityTable();
                if (typeof renderInlineProbability === 'function') renderInlineProbability();
                if (typeof renderOverlayProbability === 'function') renderOverlayProbability(true);
                if (typeof renderBelowProbability === 'function') renderBelowProbability();
            }
            
            // ÎΩëÍ∏∞ ÏÜçÎèÑÍ∞Ä Î≥ÄÍ≤ΩÎê† Ïàò ÏûàÏúºÎØÄÎ°ú ÏÑ§Ï†ï ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            updateSettingsStats();
        }

        // Î≤ÑÌîÑ ÌÉÄÏù¥Î®∏ ÏãúÏûë
        let buffTimerInterval = null;
        function startBuffTimer() {
            if (buffTimerInterval) clearInterval(buffTimerInterval);
            
            buffTimerInterval = setInterval(() => {
                const now = Date.now();
                
                // ÏÉ§Ïò§ÎØ∏Ìè∞ Î≤ÑÌîÑ Ï†úÍ±∞ Î°úÏßÅ (10Ï¥àÎßàÎã§ 8% ÌôïÎ•†Î°ú Ï†úÍ±∞)
                activeBuffs.forEach((buff, index) => {
                    if (buff.type === 'xiaomi_phone' && buff.endTime > now) {
                        // 10Ï¥àÎßàÎã§ Ï≤¥ÌÅ¨ (Î≤ÑÌîÑÍ∞Ä ÏÉùÏÑ±Îêú ÏãúÏ†êÎ∂ÄÌÑ∞ 10Ï¥à Îã®ÏúÑÎ°ú)
                        const buffAge = now - (buff.endTime - (365 * 24 * 60 * 60 * 1000));
                        if (buffAge > 0 && Math.floor(buffAge / 10000) > Math.floor((buffAge - 1000) / 10000)) {
                            // 8% ÌôïÎ•†Î°ú Ï†úÍ±∞
                            if (Math.random() < 0.08) {
                                activeBuffs.splice(index, 1);
                                alert('ÏÉ§Ïò§ÎØ∏Ìè∞ Ìö®Í≥ºÍ∞Ä Ï†úÍ±∞ÎêòÏóàÏäµÎãàÎã§!');
                            }
                        }
                    }
                });
                
                // ÎßåÎ£åÎêú Î≤ÑÌîÑ Ï†úÍ±∞
                activeBuffs = activeBuffs.filter(buff => buff.endTime > now);
                updateBuffDisplay();
                saveState();
            }, 1000);
        }
         // Ìè¨ÏÖò ÏÇ¨Ïö©
         function usePotion(type, level) {
             const now = Date.now();
             let duration = 2 * 60 * 1000; // Í∏∞Î≥∏ 2Î∂Ñ
            const potionBookLevel = getArtifactLevel('ÏÑ∏Ìò∏Î°úÎ¶¨Ïùò Î¨ºÏïΩ Ï†úÏ°∞Ïà†Ï±Ö');
            const potionBonusSeconds = ARTIFACT_VALUES.POTION_DURATION_BONUS[Math.min(potionBookLevel, 5)] || 0;
             
             // 1339Ìè¨ÏÖòÏùÄ 5Î∂Ñ
             if (type === 'speed_boost') {
                 duration = 5 * 60 * 1000;
            } else if (type === 'luck' || type === 'speed') {
                duration += potionBonusSeconds * 1000;
             }
             
             // Í∞ôÏùÄ ÌÉÄÏûÖÏùò Îã§Î•∏ Î†àÎ≤® Ìè¨ÏÖòÏù¥ Ïù¥ÎØ∏ ÌôúÏÑ±ÌôîÎêòÏñ¥ ÏûàÎäîÏßÄ ÌôïÏù∏
             const existingDifferentLevel = activeBuffs.find(b => b.type === type && b.level !== level && b.endTime > now);
             if (existingDifferentLevel) {
                 alert('Ïù¥ÎØ∏ Í∞ôÏùÄ Ìö®Í≥ºÏùò Îã§Î•∏ Î†àÎ≤® Ìè¨ÏÖòÏùÑ ÏÇ¨Ïö© Ï§ëÏûÖÎãàÎã§!');
                 return false;
             }
             
             // Í∞ôÏùÄ Î†àÎ≤®Ïùò Ìè¨ÏÖòÏù¥ ÏûàÏúºÎ©¥ ÏãúÍ∞ÑÎßå Ïó∞Ïû•
             const existingSameLevel = activeBuffs.find(b => b.type === type && b.level === level && b.endTime > now);
             if (existingSameLevel) {
                ensureBuffId(existingSameLevel);
                const extendedMillis = duration;
                const extendMinutes = Math.floor(extendedMillis / 60000);
                const extendSeconds = Math.floor((extendedMillis % 60000) / 1000);
                const extendText = extendSeconds > 0
                    ? `${extendMinutes > 0 ? `${extendMinutes}Î∂Ñ ` : ''}${extendSeconds}Ï¥à`
                    : `${extendMinutes}Î∂Ñ`;
                if (type === 'speed_boost') {
                    const currentReduction = ensureSpeedBoostReduction(existingSameLevel) || generateSpeedBoostReduction();
                    existingSameLevel.endTime = Math.max(existingSameLevel.endTime, now) + duration;
                    alert(`Í∞ôÏùÄ Ìè¨ÏÖòÏùÑ ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§! ÏßÄÏÜçÏãúÍ∞ÑÏù¥ ${extendText} Ïó∞Ïû•ÎêòÏóàÏäµÎãàÎã§. ÌòÑÏû¨ Í∞êÏÜåÏú®: ${Math.round(currentReduction * 100)}%`);
                } else {
                    existingSameLevel.endTime = Math.max(existingSameLevel.endTime, now) + duration;
                    alert(`Í∞ôÏùÄ Ìè¨ÏÖòÏùÑ ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§! ÏßÄÏÜçÏãúÍ∞ÑÏù¥ ${extendText} Ïó∞Ïû•ÎêòÏóàÏäµÎãàÎã§.`);
                }
             } else {
                const newBuff = {
                     type: type,
                     level: level,
                     endTime: now + duration
                };
                if (type === 'speed_boost') {
                    newBuff.reduction = generateSpeedBoostReduction();
                }
                ensureBuffId(newBuff);
                if (type === 'speed_boost') {
                    const appliedPercent = Math.round(newBuff.reduction * 100);
                    alert(`1339Ìè¨ÏÖòÏùÑ ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§! ÎΩëÍ∏∞ ÏÜçÎèÑÍ∞Ä ${appliedPercent}% Í∞êÏÜåÌï©ÎãàÎã§!`);
                } else if (type === 'cold_water') {
                    alert('ÏãúÏõêÌïú Î¨ºÏùÑ ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§! ÎΩëÍ∏∞ ÏÜçÎèÑ 1% Í∞êÏÜå(ÏòÅÍµ¨ Ï†ÅÏö©)');
                } else {
                    alert(`${type === 'luck' ? 'ÌñâÏö¥Ìè¨ÏÖò' : type === 'speed' ? 'ÏÜçÎèÑÌè¨ÏÖò' : '1339Ìè¨ÏÖò'}ÏùÑ ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§!`);
                }
                activeBuffs.push(newBuff);
             }
             
            updateBuffDisplay();
            
            // ÌôïÎ•† ÌëúÏãú Ï¶âÏãú ÏóÖÎç∞Ïù¥Ìä∏
            updateProbabilityTable();
            if (typeof renderInlineProbability === 'function') renderInlineProbability();
            if (typeof renderOverlayProbability === 'function') renderOverlayProbability(true);
            if (typeof renderBelowProbability === 'function') renderBelowProbability();
            
            // ÎΩëÍ∏∞ ÏÜçÎèÑ Î≥ÄÍ≤Ω Ïãú ÏÑ§Ï†ï ÌÜµÍ≥Ñ ÏóÖÎç∞Ïù¥Ìä∏
            updateSettingsStats();
            
            saveState();
            return true;
         }

         // ÌäπÏàò ÏïÑÏù¥ÌÖú ÏÇ¨Ïö©
         function useSpecialItem(effect, item) {
             if (effect === 'remove_cooldown') {
                 // Ï£ºÎßê Ìö®Í≥º
                 noCooldownCount += 75;
                 syncWeekendBuffState();
                 updateBuffDisplay();
                 alert('Ï£ºÎßêÏùÑ ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§! Îã§Ïùå 75Ìöå ÎΩëÍ∏∞ÏóêÏÑú Ïø®ÌÉÄÏûÑÏù¥ ÏÇ≠Ï†úÎê©ÎãàÎã§.');
                 return true;
             } else if (effect === 'refresh_shop') {
                 // Î≥¥Ï°∞Î∞∞ÌÑ∞Î¶¨ Ìö®Í≥º
                 if (item.usesLeft === undefined) {
                     item.usesLeft = 3;
                 }
                 if (item.usesLeft > 0) {
                     item.usesLeft--;
                     refreshShop();
                     alert(`Î≥¥Ï°∞Î∞∞ÌÑ∞Î¶¨Î•º ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§! ÏÉÅÏ†êÏù¥ Í∞±Ïã†ÎêòÏóàÏäµÎãàÎã§. (ÎÇ®ÏùÄ ÏÇ¨Ïö© ÌöüÏàò: ${item.usesLeft})`);
                     return true;
                 } else {
                     alert('Î≥¥Ï°∞Î∞∞ÌÑ∞Î¶¨Ïùò ÏÇ¨Ïö© ÌöüÏàòÍ∞Ä Î™®Îëê ÏÜåÎ™®ÎêòÏóàÏäµÎãàÎã§!');
                     return false;
                 }
             } else if (effect === 'lucky_box') {
                 // Îü≠ÌÇ§Î∞ïÏä§ Ìö®Í≥º
                 const luckCount = Math.floor(Math.random() * 10) + 1;
                 const speedCount = Math.floor(Math.random() * 10) + 1;
                 
                 addToItemStorage('ÌñâÏö¥Ìè¨ÏÖò‚Ö°', luckCount);
                 addToItemStorage('ÏÜçÎèÑÌè¨ÏÖò‚Ö°', speedCount);
                 
                 // ÌôîÎ©¥ ÏÉÅÎã®Ïóê Í≤∞Í≥º ÌëúÏãú
                 showLuckyBoxResult(luckCount, speedCount);
                 alert(`Îü≠ÌÇ§Î∞ïÏä§Î•º ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§! ÌñâÏö¥Ìè¨ÏÖò‚Ö° ${luckCount}Í∞ú, ÏÜçÎèÑÌè¨ÏÖò‚Ö° ${speedCount}Í∞úÎ•º ÌöçÎìùÌñàÏäµÎãàÎã§!`);
                 return true;
             } else if (effect === 'xiaomi_phone') {
                 // ÏÉ§Ïò§ÎØ∏Ìè∞ Ìö®Í≥º
                 const xiaomiBuff = {
                     type: 'xiaomi_phone',
                     endTime: Date.now() + (365 * 24 * 60 * 60 * 1000), // 1ÎÖÑ ÌõÑ (Ïã§Ï†úÎ°úÎäî Ï†úÍ±∞ Î°úÏßÅÏóê ÏùòÌï¥ Í¥ÄÎ¶¨)
                     level: 1,
                     removeChance: 8 // 8% ÌôïÎ•†Î°ú Ï†úÍ±∞
                 };
                ensureBuffId(xiaomiBuff);
                 activeBuffs.push(xiaomiBuff);
                 updateBuffDisplay();
                 alert('ÏÉ§Ïò§ÎØ∏Ìè∞ÏùÑ ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§! ÍΩù ÌôïÎ•†Ïù¥ 8% Í∞êÏÜåÌñàÏäµÎãàÎã§. (10Ï¥àÎßàÎã§ 8% ÌôïÎ•†Î°ú Ï†úÍ±∞)');
                 return true;
            } else if (effect === 'cold_water') {
                let coldWaterBuff = activeBuffs.find(b => b.type === 'cold_water');
                if (coldWaterBuff) {
                    coldWaterBuff.reduction = (coldWaterBuff.reduction || 0) + 0.01;
                } else {
                    coldWaterBuff = {
                        type: 'cold_water',
                        endTime: Date.now() + (365 * 24 * 60 * 60 * 1000),
                        reduction: 0.01
                    };
                    ensureBuffId(coldWaterBuff);
                    activeBuffs.push(coldWaterBuff);
                }
                updateBuffDisplay();
                const currentStacks = Math.round((coldWaterBuff.reduction || 0) * 100);
                alert(`ÏãúÏõêÌïú Î¨ºÏùÑ ÏÇ¨Ïö©ÌñàÏäµÎãàÎã§! ÎΩëÍ∏∞ ÏÜçÎèÑÍ∞Ä ÏòÅÍµ¨Ï†ÅÏúºÎ°ú ${currentStacks}% Í∞êÏÜåÎê©ÎãàÎã§. (Î¨¥Ï†úÌïú Ï§ëÏ≤© Í∞ÄÎä•)`);
                 return true;
             }
             return false;
         }
        // ÏïÑÏù¥ÌÖú Î≥¥Í¥ÄÏÜåÏóê ÏïÑÏù¥ÌÖú Ï∂îÍ∞Ä
        function addToItemStorage(itemName, quantity = 1) {
            const now = new Date();
            const itemData = allShopItems.find(item => item.name === itemName);
            const rarity = itemData ? itemData.rarity : 'common';
            const existing = itemStorage.find(item => item.name === itemName);
            
            if (existing) {
                existing.count += quantity;
                existing.date = now.toLocaleDateString('ko-KR');
                existing.time = now.toLocaleTimeString('ko-KR');
                if (!existing.rarity) {
                    existing.rarity = rarity;
                }
                // Î≥¥Ï°∞Î∞∞ÌÑ∞Î¶¨Ïù∏ Í≤ΩÏö∞ ÏÇ¨Ïö© ÌöüÏàò Ï¥àÍ∏∞Ìôî
                if (itemName === 'Î≥¥Ï°∞Î∞∞ÌÑ∞Î¶¨' && existing.usesLeft === undefined) {
                    existing.usesLeft = 3;
                }
            } else {
                const newItem = {
                    name: itemName,
                    count: quantity,
                    date: now.toLocaleDateString('ko-KR'),
                    time: now.toLocaleTimeString('ko-KR'),
                    rarity
                };
                // Î≥¥Ï°∞Î∞∞ÌÑ∞Î¶¨Ïù∏ Í≤ΩÏö∞ ÏÇ¨Ïö© ÌöüÏàò ÏÑ§Ï†ï
                if (itemName === 'Î≥¥Ï°∞Î∞∞ÌÑ∞Î¶¨') {
                    newItem.usesLeft = 3;
                }
                itemStorage.push(newItem);
            }
            
            updateItemStorageDisplay();
            saveState();
        }
         // ÏïÑÏù¥ÌÖú Î≥¥Í¥ÄÏÜåÏóêÏÑú ÏïÑÏù¥ÌÖú ÏÇ¨Ïö©
         function useItemFromStorage(index) {
             if (index < 0 || index >= itemStorage.length) return;
             
             const item = itemStorage[index];
             const itemData = allShopItems.find(si => si.name === item.name);
             
             if (!itemData) return;
             
             if (itemData.type === 'potion') {
                 if (usePotion(itemData.effect, itemData.level)) {
                     item.count--;
                     if (item.count <= 0) {
                         itemStorage.splice(index, 1);
                     }
                     updateItemStorageDisplay();
                     saveState();
                 }
             } else if (itemData.type === 'special') {
                 if (useSpecialItem(itemData.effect, item)) {
                     // Î≥¥Ï°∞Î∞∞ÌÑ∞Î¶¨Ïù∏ Í≤ΩÏö∞ ÏÇ¨Ïö© ÌöüÏàò ÌôïÏù∏
                     if (item.name === 'Î≥¥Ï°∞Î∞∞ÌÑ∞Î¶¨' && item.usesLeft !== undefined) {
                         if (item.usesLeft <= 0) {
                             itemStorage.splice(index, 1);
                         }
                     } else {
                         item.count--;
                         if (item.count <= 0) {
                             itemStorage.splice(index, 1);
                         }
                     }
                     updateItemStorageDisplay();
                     saveState();
                 }
             }
         }

        // ÏÑ∏Ìò∏ ÌåêÎß§ Ìï®Ïàò
        function sellItem(index, event) {
            event.stopPropagation(); // Ïù¥Î≤§Ìä∏ Î≤ÑÎ∏îÎßÅ Î∞©ÏßÄ
            
            if (index < 0 || index >= storage.length) return;
            
            const item = storage[index];
            const sellPrice = calculateSellPrice(item, 1); // ÌïòÎÇòÏî©Îßå ÌåêÎß§
            
            if (!confirm(`ÌåêÎß§ÌïòÏãúÍ≤†ÏäµÎãàÍπå? (${sellPrice} ÏÑ∏Ìò∏ÏΩîÏù∏, ÏÜåÏàòÏ†ê Î∞òÏò¨Î¶ºÎê®)`)) {
                return;
            }
            
            // Í∞úÏàòÍ∞Ä 1Í∞ú Ïù¥ÏÉÅÏù¥Î©¥ 1Í∞úÎßå Í∞êÏÜå, ÏïÑÎãàÎ©¥ ÏïÑÏù¥ÌÖú Ï†úÍ±∞
            if ((item.count || 1) > 1) {
                item.count -= 1;
            } else {
                storage.splice(index, 1);
            }
            
            // ÏÑ∏Ìò∏ÏΩîÏù∏ Ï¶ùÍ∞Ä
            sehoCoin += sellPrice;
            
            // ÌôîÎ©¥ ÏóÖÎç∞Ïù¥Ìä∏
            updateStorageDisplay();
            updateCoinDisplay();
            saveState();
            
            alert(`${item.name}ÏùÑ(Î•º) ${sellPrice} ÏÑ∏Ìò∏ÏΩîÏù∏Ïóê ÌåêÎß§ÌñàÏäµÎãàÎã§!`);
        }

        // ÏÑ∏Ìò∏ ÌåêÎß§ Í∞ÄÍ≤© Í≥ÑÏÇ∞
        function calculateSellPrice(item, sellCount = 1) {
            let basePrice;
            
            // ÌäπÏàò Ìö®Í≥ºÎ≥Ñ Í∏∞Î≥∏ Í∞ÄÍ≤©
            if (item.effectType === 'rainbow') {
                basePrice = 20000; // Î¨¥ÏßÄÍ∞ØÎπõ ÌäπÎ≥ÑÌö®Í≥º
            } else if (item.effectType === 'diamond') {
                basePrice = 1750; // Îã§Ïù¥ÏïÑÎ™¨ÎìúÏÉâ ÌäπÎ≥ÑÌö®Í≥º
            } else if (item.effectType === 'golden') {
                basePrice = 250; // Ìô©Í∏àÏÉâ ÌäπÎ≥ÑÌö®Í≥º
            } else if (item.effectType === 'sparkling') {
                basePrice = 30; // Î≤àÏ©çÏù¥Îäî ÌäπÎ≥ÑÌö®Í≥º
            } else if (item.effectType === 'shining') {
                basePrice = 5; // ÎπõÎÇòÎäî ÌäπÎ≥ÑÌö®Í≥º
            } else {
                basePrice = 1; // ÏùºÎ∞òÏ¢ÖÎ•ò Î™®Îì† ÏÑ∏Ìò∏
            }
            
            // Í∞ïÌôî Îã®Í≥ÑÎ≥Ñ Í∞ÄÍ≤© Î∞∞Ïàò Ï†ÅÏö©
            const enhanceLevel = item.enhanceLevel || 0;
            if (enhanceLevel === 1) {
                basePrice *= 1.1; // 1Í∞ï: 1.1Î∞∞
            } else if (enhanceLevel === 2) {
                basePrice *= 1.25; // 2Í∞ï: 1.25Î∞∞
            } else if (enhanceLevel === 3) {
                basePrice *= 1.5; // 3Í∞ï: 1.5Î∞∞
            } else if (enhanceLevel === 4) {
                basePrice *= 2; // 4Í∞ï: 2Î∞∞
            } else if (enhanceLevel === 5) {
                basePrice *= 4; // 5Í∞ï: 4Î∞∞
            }
            
            // ÌåêÎß§ Í∞úÏàòÎßåÌÅº Í∞ÄÍ≤© Ï¶ùÍ∞Ä
            basePrice *= sellCount;
            
            // ÏÜåÏàòÏ†ê Î∞òÏò¨Î¶º
            return Math.round(basePrice);
        }

        // ========== ÌÖåÎßà ÏãúÏä§ÌÖú ==========
        
        const THEME_DISPLAY_NAMES = {
            default: 'Í∏∞Î≥∏',
            orange: 'Ï£ºÌô©',
            green: 'Ï¥àÎ°ù',
            gray: 'ÌöåÏÉâ',
            yellow: 'ÎÖ∏ÎûÄÏÉâ',
            pink: 'ÌïëÌÅ¨ÏÉâ',
            purple: 'Î≥¥Îùº'
        };
        
        const THEME_ALIASES = {
            default: 'default',
            orange: 'orange',
            green: 'green',
            gray: 'gray',
            yellow: 'yellow',
            pink: 'pink',
            purple: 'purple',
            'ÌÖåÎßà_Ï£ºÌô©': 'orange',
            'ÌÖåÎßà_Ï¥àÎ°ù': 'green',
            'ÌÖåÎßà_ÌöåÏÉâ': 'gray',
            'ÌÖåÎßà_ÎÖ∏ÎûÄÏÉâ': 'yellow',
            'ÌÖåÎßà_ÌïëÌÅ¨ÏÉâ': 'pink',
            'ÌÖåÎßà_Î≥¥Îùº': 'purple',
            'Ï£ºÌô©': 'orange',
            'Ï¥àÎ°ù': 'green',
            'ÌöåÏÉâ': 'gray',
            'ÎÖ∏ÎûÄÏÉâ': 'yellow',
            'ÌïëÌÅ¨ÏÉâ': 'pink',
            'Î≥¥Îùº': 'purple'
        };
        const AVAILABLE_THEME_COLORS = Object.keys(THEME_DISPLAY_NAMES);
        
        function normalizeThemeIdentifier(theme) {
            if (!theme || typeof theme !== 'string') return null;
            if (THEME_ALIASES[theme]) return THEME_ALIASES[theme];
            const trimmed = theme.replace('ÌÖåÎßà_', '');
            if (THEME_ALIASES[trimmed]) return THEME_ALIASES[trimmed];
            const lower = theme.toLowerCase();
            if (THEME_ALIASES[lower]) return THEME_ALIASES[lower];
            return null;
        }
        
        function sanitizeThemeState() {
            if (!Array.isArray(purchasedThemes)) purchasedThemes = [];
            const normalized = new Set();
            purchasedThemes.forEach(themeId => {
                const normalizedTheme = normalizeThemeIdentifier(themeId);
                if (normalizedTheme && normalizedTheme !== 'default') {
                    normalized.add(normalizedTheme);
                }
            });
            purchasedThemes = Array.from(normalized);
            const normalizedCurrent = normalizeThemeIdentifier(currentTheme);
            currentTheme = normalizedCurrent && AVAILABLE_THEME_COLORS.includes(normalizedCurrent)
                ? normalizedCurrent
                : 'default';
        }
        // ÌÖåÎßà ÏÑ†ÌÉùÍ∏∞ Ï¥àÍ∏∞Ìôî
        function initThemeSelector() {
            sanitizeThemeState();
            const selector = document.getElementById('themeSelector');
            if (!selector) return;
            
            // Í∏∞Ï°¥ Î≤ÑÌäºÎì§ Ï†úÍ±∞
            selector.innerHTML = '';
            
            // Í∏∞Î≥∏ ÌÖåÎßà (Ìï≠ÏÉÅ ÏÇ¨Ïö© Í∞ÄÎä•)
            const defaultButton = createThemeButton('default', THEME_DISPLAY_NAMES.default);
            selector.appendChild(defaultButton);
            
            // Íµ¨Îß§Ìïú ÌÖåÎßàÎì§Îßå Ï∂îÍ∞Ä
            AVAILABLE_THEME_COLORS.filter(color => color !== 'default' && purchasedThemes.includes(color))
                .forEach(color => {
                    const button = createThemeButton(color, THEME_DISPLAY_NAMES[color] || color);
                selector.appendChild(button);
            });
            
            // ÌòÑÏû¨ ÌÖåÎßà ÌôúÏÑ±Ìôî ÌëúÏãú
            updateThemeButtons();
        }
        
        // ÌÖåÎßà Î≤ÑÌäº ÏÉùÏÑ±
        function createThemeButton(themeColor, displayName) {
            const button = document.createElement('div');
            button.className = `theme-button ${themeColor}`;
            button.title = displayName;
            button.dataset.themeColor = themeColor;
            button.onclick = () => changeTheme(themeColor);
            return button;
        }
        
        // ÌÖåÎßà Î≥ÄÍ≤Ω
        function changeTheme(themeColor) {
            const normalizedTheme = normalizeThemeIdentifier(themeColor) || 'default';
            if (normalizedTheme !== 'default' && !purchasedThemes.includes(normalizedTheme)) {
                alert('Ïù¥ ÌÖåÎßàÎäî Íµ¨Îß§ÌïòÏßÄ ÏïäÏïòÏäµÎãàÎã§!');
                return;
            }
            
            currentTheme = normalizedTheme;
            applyTheme(normalizedTheme);
            updateThemeButtons();
            saveState();
        }
        
        // ÌÖåÎßà Ï†ÅÏö©
        function applyTheme(themeColor) {
            const body = document.body;
            
            // Í∏∞Ï°¥ ÌÖåÎßà ÌÅ¥ÎûòÏä§ Ï†úÍ±∞
            body.className = body.className.replace(/theme-\w+/g, '').trim();
            
            // ÏÉà ÌÖåÎßà ÌÅ¥ÎûòÏä§ Ï∂îÍ∞Ä
            if (themeColor !== 'default') {
                body.classList.add(`theme-${themeColor}`);
            }
            
            console.log('Applied theme:', themeColor, 'Body classes:', body.className);
        }
         // ÌÖåÎßà Î≤ÑÌäº ÏÉÅÌÉú ÏóÖÎç∞Ïù¥Ìä∏
         function updateThemeButtons() {
             const buttons = document.querySelectorAll('.theme-button');
             buttons.forEach(button => {
                 button.classList.remove('active');
                 const themeColor = button.dataset.themeColor;
                 if (themeColor === currentTheme) {
                     button.classList.add('active');
                 }
             });
         }

         // Îü≠ÌÇ§Î∞ïÏä§ Í≤∞Í≥º ÌëúÏãú
         function showLuckyBoxResult(luckCount, speedCount) {
             const resultDiv = document.createElement('div');
             resultDiv.style.cssText = `
                 position: fixed;
                 top: 50%;
                 left: 50%;
                 transform: translate(-50%, -50%);
                 background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
                 border: 3px solid #b8860b;
                 border-radius: 15px;
                 padding: 30px;
                 color: #8b4513;
                 font-size: 1.5em;
                 font-weight: bold;
                 text-align: center;
                 z-index: 10000;
                 box-shadow: 0 0 30px rgba(255, 215, 0, 0.8);
                 animation: pulse 0.5s ease-in-out;
             `;
             resultDiv.innerHTML = `
                 <div style="margin-bottom: 15px;">üéÅ Îü≠ÌÇ§Î∞ïÏä§ Í≤∞Í≥º üéÅ</div>
                 <div>ÌñâÏö¥Ìè¨ÏÖò‚Ö° x${luckCount}</div>
                 <div>ÏÜçÎèÑÌè¨ÏÖò‚Ö° x${speedCount}</div>
             `;
             document.body.appendChild(resultDiv);
             
             setTimeout(() => {
                 if (resultDiv.parentNode) {
                     resultDiv.parentNode.removeChild(resultDiv);
                 }
             }, 3000);
         }


  </script>
</body>
</html>
